import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";import{getAuth as t,EmailAuthProvider as n,reauthenticateWithCredential as s,onAuthStateChanged as a,updatePassword as r,sendPasswordResetEmail as i,signOut as o,signInWithEmailAndPassword as l,createUserWithEmailAndPassword as d}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";import{getFirestore as c,deleteDoc as u,orderBy as m,query as p,getDocs as h,collection as g,getDoc as f,setDoc as b,doc as v}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const x=e({apiKey:"AIzaSyBJgDqHiHD8mncuRNlw8eA1ismr_fcvj2E",authDomain:"mi-gestion-e2ee.firebaseapp.com",projectId:"mi-gestion-e2ee",storageBucket:"mi-gestion-e2ee.firebasestorage.app",messagingSenderId:"97671435614",appId:"1:97671435614:web:e0f35d92692ca1e63b2bcf",measurementId:"G-GLYJSXBC8E"}),y=t(x),w=c(x);window.firebaseModules={app:x,auth:y,db:w,createUserWithEmailAndPassword:d,signInWithEmailAndPassword:l,signOut:o,sendPasswordResetEmail:i,updatePassword:r,onAuthStateChanged:a,reauthenticateWithCredential:s,EmailAuthProvider:n,getFirestore:c,doc:v,setDoc:b,getDoc:f,collection:g,getDocs:h,query:p,orderBy:m,deleteDoc:u};const E=new class{constructor(){if(!window.firebaseModules)throw new Error("Firebase no est√° inicializado. Recarga la p√°gina.");this.modules=window.firebaseModules,this.auth=this.modules.auth,this.db=this.modules.db,this.app=this.modules.app}_cleanObject(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(e=>this._cleanObject(e));const t={};for(const n in e)if(e.hasOwnProperty(n)){const s=e[n];void 0!==s&&(t[n]=this._cleanObject(s))}return t}getAuth(){return this.auth}getFirestore(){return this.db}getApp(){return this.app}async createUser(e,t){return this.modules.createUserWithEmailAndPassword(this.auth,e,t)}async signIn(e,t){return this.modules.signInWithEmailAndPassword(this.auth,e,t)}async signOut(){return this.modules.signOut(this.auth)}async resetPassword(e){return this.modules.sendPasswordResetEmail(this.auth,e)}async updatePassword(e,t){return this.modules.updatePassword(e,t)}onAuthStateChanged(e){return this.modules.onAuthStateChanged(this.auth,e)}getDoc(e){return this.modules.getDoc(e)}setDoc(e,t,n){const s=this._cleanObject(t);return this.modules.setDoc(e,s,n)}deleteDoc(e){return this.modules.deleteDoc(e)}doc(e){return this.modules.doc(this.db,e)}};async function S(e,t){try{const n=(new TextEncoder).encode(e),s=await crypto.subtle.importKey("raw",n,"PBKDF2",!1,["deriveKey"]),a=await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),r=await crypto.subtle.exportKey("raw",a);return new Uint8Array(r)}catch(n){throw n}}async function I(e,t,n=null){try{const s=JSON.stringify(e),a=(new TextEncoder).encode(s),r=function(){const e=new Uint8Array(12);return crypto.getRandomValues(e),e}(),i=await L(t),o={name:"AES-GCM",iv:r,tagLength:128};if(n){const e=String(n);o.additionalData=(new TextEncoder).encode(e)}const l=await crypto.subtle.encrypt(o,i,a),d=new Uint8Array(l),c=btoa(String.fromCharCode(...d));return{content:c,iv:btoa(String.fromCharCode(...r)),algorithm:"AES-GCM-256",timestamp:(new Date).toISOString()}}catch(s){throw s}}async function C(e,t,n=null){try{const s=Uint8Array.from(atob(e.content),e=>e.charCodeAt(0)),a=Uint8Array.from(atob(e.iv),e=>e.charCodeAt(0)),r=await L(t),i={name:"AES-GCM",iv:a,tagLength:128};if(n){const e=String(n);i.additionalData=(new TextEncoder).encode(e)}const o=await crypto.subtle.decrypt(i,r,s),l=(new TextDecoder).decode(o);return JSON.parse(l)}catch(s){if("OperationError"===s.name||s.message.includes("decryption"))throw new Error("Contrase√±a incorrecta o datos corruptos");throw s}}async function L(e){return crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}async function $(e,t,n=null){try{const s=n||"doc_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),a=function(){const e=new Uint8Array(32);return crypto.getRandomValues(e),e}(),r=await I(e,a),i=await I(Array.from(a),t,s);return{content:r,metadata:{itemKey:i,documentId:s,contentHash:await k(e),encryptedAt:(new Date).toISOString(),version:"1.0"}}}catch(s){throw s}}async function T(e,t){try{const n=await C(e.metadata.itemKey,t,e.metadata.documentId||"item_key"),s=new Uint8Array(n),a=await C(e.content,s);await k(a);return e.metadata.contentHash,a}catch(n){if(n.message&&n.message.includes("Contrase√±a incorrecta"))throw new Error("No se puede descifrar: contrase√±a incorrecta o datos corruptos");throw n}}async function k(e){const t=JSON.stringify(e),n=(new TextEncoder).encode(t),s=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(s)).map(e=>e.toString(16).padStart(2,"0")).join("")}const D=new class{constructor(){this.isInitialized=!1,this.masterKey=null,this.salt=null}async initialize(e){try{const t=E.getAuth().currentUser;if(!t)throw new Error("Usuario no autenticado para iniciar cifrado");return this.salt=await this.getOrCreateSalt(t.uid),this.masterKey=await S(e,this.salt),this.isInitialized=!0,!0}catch(t){throw t}}async getOrCreateSalt(e){const t=`encryption_salt_${e}`;let n=null;try{const s=E.doc(`artifacts/mi-gestion-v1/users/${e}/metadata/encryption`),a=await E.getDoc(s);if(a.exists()&&a.data().salt){const e=a.data().salt,s=Object.values(e);return n=new Uint8Array(s.length>0?s:e),localStorage.setItem(t,JSON.stringify(Array.from(n))),n}}catch(r){}const s=localStorage.getItem(t)||localStorage.getItem("encryption_salt");if(s)return n=new Uint8Array(JSON.parse(s)),await this.saveSaltToFirestore(e,n),n;const a=function(e=16){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}();return localStorage.setItem(t,JSON.stringify(Array.from(a))),await this.saveSaltToFirestore(e,a),a}async saveSaltToFirestore(e,t){try{const n=E.doc(`artifacts/mi-gestion-v1/users/${e}/metadata/encryption`);await E.setDoc(n,{salt:Array.from(t),updatedAt:(new Date).toISOString()},{merge:!0})}catch(n){}}async encryptDocument(e,t=null){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return $(e,this.masterKey,t)}async decryptDocument(e){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return T(e,this.masterKey)}async encryptField(e,t){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return async function(e,t,n){return I({value:e,field:n,timestamp:(new Date).toISOString()},t,n)}(e,this.masterKey,t)}async decryptField(e,t){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return async function(e,t,n){return(await C(e,t,n)).value}(e,this.masterKey,t)}isReady(){return this.isInitialized&&null!==this.masterKey}getStatus(){return{isInitialized:this.isInitialized,hasMasterKey:null!==this.masterKey,algorithm:"PBKDF2 + AES-GCM-256"}}clearKeys(){this.masterKey=null,this.isInitialized=!1}};const B=new class{constructor(){this.currentUser=null,this.authListeners=[],this.initAuthListener()}initAuthListener(){E.onAuthStateChanged(async e=>{this.currentUser=e,this.notifyAuthListeners(e),e&&await this.initializeNewUser(e)})}async initializeNewUser(e){try{const t=(await e.getIdTokenResult()).claims.isNewUser||!1,n=await this.getUserRole();!t&&n||await this.createUserProfile(e)}catch(t){}}async createUserProfile(e){try{const t={email:e.email,role:"user",createdAt:(new Date).toISOString(),lastLogin:(new Date).toISOString(),settings:{theme:"auto",language:"es",autoLock:30}};localStorage.setItem(`user_profile_${e.uid}`,JSON.stringify(t));const n=E.doc(`artifacts/mi-gestion-v1/users/${e.uid}/metadata/user_config`);return await E.setDoc(n,t,{merge:!0}),t}catch(t){throw t}}async getUserRole(){if(!this.currentUser)return null;const e=localStorage.getItem(`user_profile_${this.currentUser.uid}`);if(e){const t=JSON.parse(e);if(t.role)return t.role}try{const e=E.doc(`artifacts/mi-gestion-v1/users/${this.currentUser.uid}/metadata/user_config`),t=await E.getDoc(e);if(t.exists()){const e=t.data();return localStorage.setItem(`user_profile_${this.currentUser.uid}`,JSON.stringify(e)),e.role||"user"}}catch(t){}return"user"}async register(e,t){try{const s=await E.createUser(e,t);try{await this.initializeEncryption(t)}catch(n){}return await this.createUserProfile(s.user),{success:!0,user:s.user,message:"Usuario registrado exitosamente"}}catch(s){return{success:!1,error:this.getErrorMessage(s.code),code:s.code}}}async login(e,t){try{const s=await E.signIn(e,t);try{await this.initializeEncryption(t)}catch(n){}return this.getUserRole(),{success:!0,user:s.user,message:"Sesi√≥n iniciada exitosamente"}}catch(s){return{success:!1,error:this.getErrorMessage(s.code),code:s.code}}}async logout(){try{return this.clearEncryption(),this.clearSensitiveData(),await E.signOut(),{success:!0,message:"Sesi√≥n cerrada exitosamente"}}catch(e){return{success:!1,error:"Error al cerrar sesi√≥n",code:e.code}}}async resetPassword(e){try{return await E.resetPassword(e),{success:!0,message:"Correo de restablecimiento enviado"}}catch(t){return{success:!1,error:this.getErrorMessage(t.code),code:t.code}}}async changePassword(e,t){try{const s=this.currentUser;if(!s)throw new Error("Usuario no autenticado");if(!t)throw new Error("Se requiere la contrase√±a actual para migrar los datos.");const{updatePassword:a,reauthenticateWithCredential:r,EmailAuthProvider:i,collection:o,getDocs:l,query:d}=E.modules,c=await D.getOrCreateSalt(s.uid),u=await S(t,c),m=await S(e,c),p=`artifacts/mi-gestion-v1/users/${s.uid}/vault`,h=d(o(E.db,p)),g=await l(h),f=[];g.forEach(e=>{const t=e.data();f.push((async()=>{try{const n=await T({content:t.encryptedContent,metadata:t.encryptionMetadata},u),s=await $(n,m,t.id),a={encryptedContent:s.content,encryptionMetadata:s.metadata,"metadata.updatedAt":(new Date).toISOString()};await E.setDoc(e.ref,a,{merge:!0})}catch(n){throw new Error(`Error migrando datos: ${n.message}`)}})())}),f.length>0&&await Promise.all(f);try{await a(s,e)}catch(n){if("auth/requires-recent-login"!==n.code)throw n;{const n=i.credential(s.email,t);await r(s,n),await a(s,e)}}return await D.initialize(e),{success:!0,message:"Contrase√±a actualizada y datos migrados exitosamente"}}catch(n){return{success:!1,error:"No se pudo completar el cambio. Tus datos NO se han modificado. Error: "+n.message,code:n.code}}}getErrorMessage(e){return{"auth/email-already-in-use":"Este correo ya est√° registrado.","auth/invalid-email":"Correo electr√≥nico no v√°lido","auth/weak-password":"La contrase√±a es demasiado d√©bil","auth/wrong-password":"Contrase√±a incorrecta.","auth/requires-recent-login":"Por seguridad, confirma tu contrase√±a actual."}[e]||`Error: ${e}`}clearSensitiveData(){["master_key","encryption_keys","user_session_data","temp_encryption_data"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)});const e=this.currentUser;e&&localStorage.removeItem(`user_profile_${e.uid}`)}subscribe(e){return this.authListeners.push(e),e(this.currentUser),()=>{this.authListeners=this.authListeners.filter(t=>t!==e)}}notifyAuthListeners(e){this.authListeners.forEach(t=>{try{t(e)}catch(n){}})}getCurrentUser(){return this.currentUser}isAuthenticated(){return!!this.currentUser}async getAuthToken(){return this.currentUser?await this.currentUser.getIdToken():null}async initializeEncryption(e){try{return await D.initialize(e),localStorage.setItem("encryption_initialized","true"),!0}catch(t){throw new Error("Error al configurar el cifrado seguro")}}clearEncryption(){D.clearKeys(),localStorage.removeItem("encryption_initialized")}isEncryptionInitialized(){return D.isReady()}};class F{constructor(e){this.onAuthSuccess=e,this.currentForm="login"}renderLoginForm(){return'\n      <div class="animate-fade-in space-y-6">\n        <form id="loginForm" class="space-y-5">\n          <div>\n            <label for="loginEmail" class="block text-sm font-semibold text-slate-700 mb-1.5">Correo Electr√≥nico</label>\n            <input type="email" id="loginEmail" required \n              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all outline-none text-slate-700 placeholder-slate-400"\n              placeholder="nombre@ejemplo.com" />\n          </div>\n\n          <div>\n            <div class="flex justify-between items-center mb-1.5">\n              <label for="loginPassword" class="block text-sm font-semibold text-slate-700">Contrase√±a</label>\n              <button type="button" id="forgotPasswordBtn" class="text-xs font-medium text-primary hover:text-primary-hover underline-offset-2 hover:underline">\n                ¬øOlvidaste tu contrase√±a?\n              </button>\n            </div>\n            <input type="password" id="loginPassword" required \n              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all outline-none text-slate-700"\n              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />\n          </div>\n\n          <button type="submit" class="w-full py-3.5 px-4 bg-primary hover:bg-primary-hover text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 flex items-center justify-center gap-2">\n            <span>Iniciar Sesi√≥n</span>\n            <svg class="w-5 h-5 text-white hidden animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>\n          </button>\n        </form>\n\n        <div class="relative">\n           <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>\n           <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-slate-400">O</span></div>\n        </div>\n\n        <div class="text-center">\n          <p class="text-slate-600 text-sm">\n            ¬øA√∫n no tienes cuenta?\n            <button id="switchToRegister" class="text-primary font-bold hover:underline ml-1">Crear cuenta gratis</button>\n          </p>\n        </div>\n      </div>\n    '}renderRegisterForm(){return'\n      <div class="animate-fade-in space-y-6">\n        <form id="registerForm" class="space-y-4">\n          <div>\n            <label class="block text-sm font-semibold text-slate-700 mb-1.5">Correo Electr√≥nico</label>\n            <input type="email" id="registerEmail" required \n               class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-success focus:border-transparent transition-all outline-none" placeholder="tu@email.com" />\n          </div>\n\n          <div class="grid grid-cols-2 gap-4">\n            <div>\n              <label class="block text-sm font-semibold text-slate-700 mb-1.5">Contrase√±a</label>\n              <input type="password" id="registerPassword" required minlength="8"\n                 class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-success focus:border-transparent transition-all outline-none" placeholder="Min 8 chars" />\n            </div>\n            <div>\n               <label class="block text-sm font-semibold text-slate-700 mb-1.5">Confirmar</label>\n               <input type="password" id="registerConfirmPassword" required\n                  class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-success focus:border-transparent transition-all outline-none" placeholder="Repetir" />\n            </div>\n          </div>\n\n          <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 flex gap-3 items-start">\n             <i class="fas fa-shield-alt text-primary mt-1"></i>\n             <p class="text-xs text-blue-800 leading-relaxed">\n               <strong>Importante:</strong> Tu contrase√±a se usar√° para generar tu llave de encriptaci√≥n. <br>Si la olvidas, tus datos no podr√°n ser recuperados por nadie (ni por nosotros).\n             </p>\n          </div>\n\n          <button type="submit" class="w-full py-3.5 px-4 bg-success hover:bg-emerald-600 text-white font-bold rounded-xl shadow-lg shadow-emerald-500/30 transition-all transform active:scale-95 flex items-center justify-center gap-2">\n            <span>Registrarse Seguro</span>\n            <svg class="w-5 h-5 text-white hidden animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>\n          </button>\n        </form>\n\n        <div class="text-center pt-2">\n          <p class="text-slate-600 text-sm">\n            ¬øYa tienes cuenta?\n            <button id="switchToLogin" class="text-primary font-bold hover:underline ml-1">Iniciar Sesi√≥n</button>\n          </p>\n        </div>\n      </div>\n    '}renderForgotPasswordForm(){return'\n      <div class="animate-fade-in space-y-6">\n        <div class="text-center mb-6">\n           <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">\n             <i class="fas fa-key text-yellow-600 text-xl"></i>\n           </div>\n           <h3 class="font-bold text-slate-800">Recuperaci√≥n de Cuenta</h3>\n        </div>\n\n        <form id="forgotPasswordForm" class="space-y-5">\n          <div>\n            <label class="block text-sm font-semibold text-slate-700 mb-1.5">Correo registrado</label>\n            <input type="email" id="resetEmail" required \n              class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-yellow-500 transition-all outline-none" placeholder="tu@email.com" />\n          </div>\n\n          <div class="bg-yellow-50 border border-yellow-100 rounded-xl p-3 flex gap-3">\n            <i class="fas fa-exclamation-circle text-yellow-600 mt-0.5"></i>\n            <p class="text-xs text-yellow-800">\n              Al resetear tu contrase√±a, perder√°s acceso a los documentos cifrados con la contrase√±a anterior.\n            </p>\n          </div>\n\n          <div class="flex gap-3">\n            <button type="button" id="cancelReset" class="flex-1 py-3 px-4 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition-colors">\n              Cancelar\n            </button>\n            <button type="submit" class="flex-1 py-3 px-4 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-900 shadow-lg transition-all flex items-center justify-center gap-2">\n              <span>Enviar Link</span>\n              <svg class="w-5 h-5 text-white hidden animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>\n            </button>\n          </div>\n        </form>\n      </div>\n    '}render(){switch(this.currentForm){case"login":default:return this.renderLoginForm();case"register":return this.renderRegisterForm();case"forgot":return this.renderForgotPasswordForm()}}setupEventListeners(e){switch(this.setupRealTimeValidation(e),this.currentForm){case"login":this.setupLoginListeners(e);break;case"register":this.setupRegisterListeners(e);break;case"forgot":this.setupForgotPasswordListeners(e)}}setupLoginListeners(e){const t=e.querySelector("#loginForm"),n=e.querySelector("#switchToRegister"),s=e.querySelector("#forgotPasswordBtn");t&&t.addEventListener("submit",this.handleLogin.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="register",this.updateView(e)}),s&&s.addEventListener("click",()=>{this.currentForm="forgot",this.updateView(e)})}setupRegisterListeners(e){const t=e.querySelector("#registerForm"),n=e.querySelector("#switchToLogin");t&&t.addEventListener("submit",this.handleRegister.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="login",this.updateView(e)})}setupForgotPasswordListeners(e){const t=e.querySelector("#forgotPasswordForm"),n=e.querySelector("#cancelReset");t&&t.addEventListener("submit",this.handleForgotPassword.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="login",this.updateView(e)})}async handleLogin(e){e.preventDefault();const t=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value;if(!t||!n)return this.showError("Credenciales incompletas");this.showLoading(!0);try{const e=await B.login(t,n);e.success?window.app&&window.app.initializePostLogin&&window.app.initializePostLogin(e.user,n):(this.showError(e.error||"Error al iniciar sesi√≥n"),this.showLoading(!1))}catch(s){this.showError("Error de conexi√≥n"),this.showLoading(!1)}}async handleRegister(e){e.preventDefault();const t=document.getElementById("registerEmail").value,n=document.getElementById("registerPassword").value,s=document.getElementById("registerConfirmPassword").value;if(!t||!n||!s)return this.showError("Faltan datos");if(n!==s)return this.showError("Las contrase√±as no coinciden");if(n.length<8)return this.showError("M√≠nimo 8 caracteres requeridos");this.showLoading(!0);try{const e=await B.register(t,n);e.success||(this.showError(e.error||"Error en registro"),this.showLoading(!1))}catch(a){this.showError("Error inesperado"),this.showLoading(!1)}}async handleForgotPassword(e){e.preventDefault();const t=document.getElementById("resetEmail").value;if(!t)return this.showError("Ingresa tu email");this.showLoading(!0);try{const e=await B.resetPassword(t);e.success?(this.showMessage(e.message,"success"),setTimeout(()=>{this.currentForm="login",this.updateView(document.getElementById("authContainer"))},3500)):(this.showError(e.error),this.showLoading(!1))}catch(n){this.showError("Error al enviar solicitud"),this.showLoading(!1)}}updateView(e){e&&(e.innerHTML=this.render(),this.setupEventListeners(e))}showLoading(e){const t=document.querySelector('#authContainer button[type="submit"]');if(!t)return;const n=t.querySelector("svg"),s=t.querySelector("span");e?(t.disabled=!0,t.classList.add("opacity-80","cursor-not-allowed"),n&&n.classList.remove("hidden"),s&&(s.innerText="Procesando...")):(t.disabled=!1,t.classList.remove("opacity-80","cursor-not-allowed"),n&&n.classList.add("hidden"),s&&(s.innerText="login"===this.currentForm?"Iniciar Sesi√≥n":"register"===this.currentForm?"Registrarse Seguro":"Enviar Link")),document.querySelectorAll("#authContainer input").forEach(t=>{t.disabled=e,e?t.classList.add("bg-slate-100","text-slate-400"):t.classList.remove("bg-slate-100","text-slate-400")})}showError(e,t=4e3){this.clearMessages();const n=document.createElement("div");n.className="error-message mb-5 p-4 rounded-xl bg-red-50 border-l-4 border-red-500 text-red-700 text-sm font-medium flex items-center animate-pulse",n.innerHTML=`<i class="fas fa-exclamation-triangle mr-3 text-red-500 text-lg"></i> ${e}`,this.injectMessage(n,t)}showMessage(e,t="success",n=4e3){this.clearMessages();const s=document.createElement("div");s.className="success-message mb-5 p-4 rounded-xl bg-emerald-50 border-l-4 border-emerald-500 text-emerald-700 text-sm font-medium flex items-center animate-bounce-in",s.innerHTML=`<i class="fas fa-check-circle mr-3 text-emerald-500 text-lg"></i> ${e}`,this.injectMessage(s,n)}injectMessage(e,t){const n=document.querySelector("#authContainer form");n&&(n.parentElement.insertBefore(e,n),t>0&&setTimeout(()=>e.remove(),t))}clearMessages(){document.querySelectorAll(".error-message, .success-message").forEach(e=>e.remove())}setupRealTimeValidation(e){e.querySelectorAll("input").forEach(e=>{e.addEventListener("input",()=>{e.classList.remove("ring-2","ring-red-500","bg-red-50")})})}}class M{constructor(e,t){this.onPasswordSubmit=e,this.userEmail=t,this.isSubmitting=!1}render(){return`\n      <div class="fixed inset-0 z-50 flex items-center justify-center px-4">\n        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>\n        \n        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all animate-[fadeIn_0.3s_ease-out]">\n          \n          <div class="h-2 bg-gradient-to-r from-primary to-secondary"></div>\n\n          <div class="p-8">\n            <div class="text-center mb-8">\n              <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-50 rounded-full mb-4 ring-4 ring-blue-50/50">\n                <i class="fas fa-shield-alt text-primary text-2xl"></i>\n              </div>\n              <h3 class="text-2xl font-bold text-slate-800">B√≥veda Cifrada</h3>\n              <p class="text-slate-500 mt-2 text-sm">Tus datos est√°n protegidos. Ingresa tu llave maestra para desencriptarlos localmente.</p>\n            </div>\n            \n            <div class="space-y-5">\n              <div class="relative">\n                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">\n                  <i class="fas fa-user text-slate-400"></i>\n                </div>\n                <input\n                  type="text"\n                  value="${this.userEmail}"\n                  disabled\n                  class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-500 text-sm font-medium select-none"\n                />\n              </div>\n              \n              <div class="relative">\n                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">\n                  <i class="fas fa-key text-slate-400"></i>\n                </div>\n                <input\n                  type="password"\n                  id="encryptionPassword"\n                  placeholder="Contrase√±a maestra"\n                  class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-xl text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-sm"\n                  autocomplete="current-password"\n                />\n              </div>\n              \n              <div class="bg-amber-50 border border-amber-100 rounded-xl p-4 flex gap-3">\n                <i class="fas fa-exclamation-triangle text-amber-500 mt-0.5 flex-shrink-0"></i>\n                <div class="text-xs text-amber-800 space-y-1">\n                  <p class="font-bold">Informaci√≥n Cr√≠tica:</p>\n                  <p>Esta contrase√±a nunca se env√≠a a nuestros servidores. Si la pierdes, tus datos cifrados ser√°n irrecuperables.</p>\n                </div>\n              </div>\n              \n              <div class="flex gap-3 pt-2">\n                <button\n                  id="cancelEncryption"\n                  class="flex-1 px-4 py-2.5 bg-white border border-slate-200 text-slate-700 rounded-xl hover:bg-slate-50 hover:text-slate-900 font-medium transition-colors focus:ring-2 focus:ring-slate-200"\n                >\n                  Omitir\n                </button>\n                <button\n                  id="submitEncryptionPassword"\n                  class="flex-1 px-4 py-2.5 bg-primary hover:bg-primary-hover text-white rounded-xl shadow-lg shadow-blue-500/30 font-medium transition-all transform active:scale-95 focus:ring-2 focus:ring-offset-2 focus:ring-primary flex items-center justify-center gap-2"\n                >\n                  <span id="submitText">Desbloquear</span>\n                  <svg id="submitSpinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">\n                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n                  </svg>\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}show(){const e=document.createElement("div");e.id="encryptionPromptOverlay",e.style.position="relative",e.style.zIndex="9999",e.innerHTML=this.render(),document.body.appendChild(e),setTimeout(()=>{const e=document.getElementById("encryptionPassword");e&&e.focus()},100),this.setupEventListeners()}hide(){const e=document.getElementById("encryptionPromptOverlay");e&&e.remove()}setupEventListeners(){const e=document.getElementById("encryptionPassword"),t=document.getElementById("submitEncryptionPassword"),n=document.getElementById("cancelEncryption"),s=document.getElementById("submitText"),a=document.getElementById("submitSpinner"),r=async()=>{if(this.isSubmitting)return;const n=e.value.trim();if(!n)return this.showError("La contrase√±a es obligatoria"),e.classList.add("ring-2","ring-red-500","bg-red-50"),void setTimeout(()=>e.classList.remove("ring-2","ring-red-500","bg-red-50"),2e3);this.isSubmitting=!0,s.textContent="Verificando...",a.classList.remove("hidden"),t.disabled=!0,t.classList.add("opacity-75","cursor-not-allowed");try{await this.onPasswordSubmit(n)?this.hide():(this.showError("Contrase√±a incorrecta"),this.resetForm(),e.select())}catch(r){this.showError(r.message||"Error cr√≠tico"),this.resetForm()}};t.addEventListener("click",r),n.addEventListener("click",()=>this.hide()),e.addEventListener("keypress",e=>{"Enter"!==e.key||this.isSubmitting||r()});document.getElementById("encryptionPromptOverlay").querySelector(".absolute").addEventListener("click",()=>this.hide())}showError(e){this.clearErrors();const t=document.querySelector("#encryptionPromptOverlay .space-y-5"),n=document.createElement("div");n.className="p-3 bg-red-50 text-red-700 text-sm rounded-lg flex items-center animate-pulse border border-red-100",n.innerHTML=`<i class="fas fa-times-circle mr-2 text-red-500"></i> ${e}`,t.insertBefore(n,t.lastElementChild)}clearErrors(){document.querySelectorAll("#encryptionPromptOverlay .bg-red-50").forEach(e=>e.remove())}resetForm(){this.isSubmitting=!1;const e=document.getElementById("submitText"),t=document.getElementById("submitSpinner"),n=document.getElementById("submitEncryptionPassword");e&&(e.textContent="Desbloquear"),t&&t.classList.add("hidden"),n&&(n.disabled=!1,n.classList.remove("opacity-75","cursor-not-allowed"))}}class A{constructor(e,t="mi-gestion-v1"){this.userId=e,this.appId=t}async loadFromLocalStorage(){const e=`user_templates_${this.userId}`,t=localStorage.getItem(e);return t?JSON.parse(t):[]}async saveToLocalStorage(e){try{if(!this.userId)return;const t=`user_templates_${this.userId}`;localStorage.setItem(t,JSON.stringify(e))}catch(t){}}getTemplatesRef(){if(!this.userId)throw new Error("ID de usuario no definido para Firestore.");return E.doc(`artifacts/${this.appId}/users/${this.userId}/metadata/templates`)}async loadFromFirestore(){try{const e=this.getTemplatesRef(),t=await E.getDoc(e);if(t.exists()){const e=t.data();return e.templates||[]}return[]}catch(e){return null}}async saveToFirestore(e){try{if(!this.userId)return;const t=this.getTemplatesRef(),n={userId:this.userId,appId:this.appId,templates:e,lastUpdated:(new Date).toISOString(),count:e.length};await E.setDoc(t,n,{merge:!0}),await this.saveToLocalStorage(e)}catch(t){throw new Error("Fallo al guardar plantillas en la nube.")}}async migrateToFirestore(){const e=await this.loadFromLocalStorage();return e.length>0?(await this.saveToFirestore(e),{success:!0,migrated:e.length}):{success:!0,migrated:0}}async checkSyncStatus(e){if(!this.userId)return{synced:!1,error:"Usuario no autenticado"};const t=this.getTemplatesRef(),n=await E.getDoc(t);if(n.exists()){const t=n.data(),s=t.templates||[];return{synced:s.length===e.length,localCount:e.length,cloudCount:s.length,cloudTemplates:s,lastUpdated:t.lastUpdated,needsSync:s.length!==e.length}}return{synced:!1,localCount:e.length,cloudCount:0,needsSync:!0,cloudTemplates:[]}}}const j=[{value:"string",label:"Texto Breve",inputType:"text",icon:"fas fa-font",description:"Nombres, t√≠tulos o datos cortos."},{value:"text",label:"Texto Largo / Notas",inputType:"textarea",icon:"fas fa-align-left",description:"Descripciones detalladas o p√°rrafos."},{value:"currency",label:"Moneda / Dinero",inputType:"text",icon:"fas fa-dollar-sign",description:"Importes financieros."},{value:"number",label:"N√∫mero",inputType:"text",icon:"fas fa-hashtag",description:"Cantidades, edades, unidades."},{value:"percentage",label:"Porcentaje",inputType:"text",icon:"fas fa-percent",description:"Valores porcentuales (0-100)."},{value:"boolean",label:"S√≠ / No (Interruptor)",inputType:"checkbox",icon:"fas fa-check-square",description:"Opci√≥n binaria verdadero/falso."},{value:"select",label:"Lista de Opciones",inputType:"select",icon:"fas fa-list-ul",description:"Men√∫ desplegable con opciones predefinidas."},{value:"date",label:"Fecha",inputType:"date",icon:"far fa-calendar-alt",description:"Selector de calendario."},{value:"email",label:"Correo Electr√≥nico",inputType:"email",icon:"fas fa-envelope",description:"Validaci√≥n de formato email."},{value:"url",label:"Enlace Web (URL)",inputType:"url",icon:"fas fa-link",description:"Link a sitio web con etiqueta opcional."},{value:"secret",label:"Dato Sensible (Oculto)",inputType:"password",icon:"fas fa-key",description:"Se visualiza con desenfoque/asteriscos."},{value:"table",label:"Tabla Din√°mica",inputType:"table",icon:"fas fa-table",description:"Lista de √≠tems con columnas personalizadas."}],q=()=>j;const P=new class{getValidFieldTypes(){return q().map(e=>e.value)}generateFieldId(e,t){if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_$]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"");return n&&/^[a-zA-Z_$]/.test(n)?n:`campo_${t+1}`}validateField(e,t){const n=this.getValidFieldTypes();if(!n.includes(e.type))throw new Error(`Tipo de campo inv√°lido: "${e.type}". Tipos v√°lidos: ${n.join(", ")}`);return e.id||(e.id=this.generateFieldId(e.label,t)),"table"===e.type&&e.columns&&Array.isArray(e.columns)&&0!==e.columns.length&&e.columns.forEach((t,s)=>{if(!t.label)throw new Error(`La columna ${s+1} de la tabla '${e.label}' no tiene nombre (etiqueta).`);if(!n.includes(t.type))throw new Error(`Tipo inv√°lido en columna '${t.label}'`);t.id||(t.id=this.generateFieldId(t.label,s))}),void 0===e.sensitive&&(e.sensitive=!1),!0}validateTemplateData(e){if(!e.name)throw new Error("La plantilla debe tener un nombre");if(!e.fields||!Array.isArray(e.fields)||0===e.fields.length)throw new Error("La plantilla debe tener al menos un campo");return e.fields.forEach((e,t)=>{this.validateField(e,t)}),!0}getCategoryName(e){return{personal:"Personal",access:"Accesos",financial:"Financiero",health:"Salud",custom:"Personalizado"}[e]||e}getCategoryIcon(e){return{personal:"üë§",access:"üîê",financial:"üí∞",health:"üè•",custom:"üìã"}[e]||"üìÑ"}};const N=new class{constructor(){this.userId=null,this.appId="mi-gestion-v1",this.userTemplates=[],this.isInitialized=!1,this.storage=null}async initialize(e){this.isInitialized&&this.userId===e||(this.userId=e,this.storage=new A(e,this.appId),await this.loadUserTemplates(),this.isInitialized=!0)}async loadUserTemplates(){try{if(!this.userId)return void(this.userTemplates=[]);let e=await this.storage.loadFromFirestore();null===e&&(e=await this.storage.loadFromLocalStorage()),e&&0!==e.length||(e=this.getDefaultTemplates(),await this.storage.saveToFirestore(e)),this.userTemplates=e}catch(e){this.userTemplates=this.getDefaultTemplates()}}async createTemplate(e){if(!this.userId)throw new Error("Usuario no autenticado");P.validateTemplateData(e);const t={id:`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:this.userId,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),...e,settings:{allowDuplicates:!1,maxEntries:0,category:"custom",...e.settings,isSystemTemplate:!1}};return this.userTemplates.push(t),await this.storage.saveToFirestore(this.userTemplates),t}async updateTemplate(e,t){const n=this.userTemplates.findIndex(t=>t.id===e);if(-1===n)throw new Error("Plantilla no encontrada");const s={...this.userTemplates[n],...t};return P.validateTemplateData(s),this.userTemplates[n]={...s,updatedAt:(new Date).toISOString()},await this.storage.saveToFirestore(this.userTemplates),this.userTemplates[n]}async deleteTemplate(e){const t=this.userTemplates.length;if(this.userTemplates=this.userTemplates.filter(t=>t.id!==e),this.userTemplates.length===t)throw new Error("Plantilla no encontrada");return await this.storage.saveToFirestore(this.userTemplates),{success:!0,message:"Plantilla eliminada"}}async exportTemplate(e){const t=await this.getTemplateById(e);if(!t)throw new Error("Plantilla no encontrada");const{id:n,userId:s,createdAt:a,updatedAt:r,...i}=t;return i}async importTemplate(e){return await this.createTemplate(e)}async getUserTemplates(){if(!this.isInitialized)throw new Error("Servicio no inicializado");return 0===this.userTemplates.length?this.getDefaultTemplates():this.userTemplates}async getTemplateById(e){return this.userTemplates.find(t=>t.id===e)||null}async getCategories(){const e=await this.getUserTemplates();return[...new Set(e.map(e=>e.settings.category))].map(t=>({id:t,count:e.filter(e=>e.settings.category===t).length}))}getDefaultTemplates(){return[{id:"tpl_default_access",name:"Accesos y Contrase√±as",description:"Gesti√≥n segura de credenciales",icon:"üîê",color:"#F59E0B",settings:{category:"access",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_site",label:"Sitio / Aplicaci√≥n",type:"string",order:1,required:!0},{id:"f_user",label:"Usuario / Email",type:"string",order:2,required:!1},{id:"f_pass",label:"Contrase√±a",type:"secret",order:3,required:!0},{id:"f_url",label:"URL de acceso",type:"url",order:4,required:!1},{id:"f_notes",label:"Notas adicionales",type:"text",order:5,required:!1}]},{id:"tpl_default_health",name:"Historial M√©dico",description:"Registro b√°sico de salud",icon:"‚öïÔ∏è",color:"#EF4444",settings:{category:"health",allowDuplicates:!1},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_blood",label:"Tipo de Sangre",type:"string",order:1,required:!1},{id:"f_allergies",label:"Alergias",type:"text",order:2,required:!1},{id:"f_meds",label:"Medicaci√≥n Actual",type:"text",order:3,required:!1},{id:"f_contact",label:"Contacto Emergencia",type:"string",order:4,required:!0}]},{id:"tpl_default_finance",name:"Tarjeta de Cr√©dito",description:"Datos de tarjetas bancarias",icon:"üí≥",color:"#10B981",settings:{category:"financial",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_bank",label:"Banco / Emisor",type:"string",order:1,required:!0},{id:"f_number",label:"N√∫mero de Tarjeta",type:"secret",order:2,required:!0},{id:"f_exp",label:"Vencimiento (MM/AA)",type:"string",order:3,required:!0},{id:"f_cvv",label:"CVV",type:"secret",order:4,required:!0},{id:"f_pin",label:"PIN Cajero",type:"secret",order:5,required:!1}]}]}async checkSyncStatus(){return this.storage.checkSyncStatus(this.userTemplates)}async syncTemplates(){const e=await this.storage.checkSyncStatus(this.userTemplates);if(e.needsSync){if(e.cloudCount>e.localCount)return this.userTemplates=e.cloudTemplates,await this.storage.saveToLocalStorage(this.userTemplates),{synced:!0,message:`Descargadas ${e.cloudCount} plantillas.`};if(e.localCount>e.cloudCount)return await this.storage.saveToFirestore(this.userTemplates),{synced:!0,message:`Subidas ${e.localCount} plantillas.`}}return{synced:!0,message:"Sincronizado."}}},_=Object.freeze(Object.defineProperty({__proto__:null,templateService:N},Symbol.toStringTag,{value:"Module"})),O={"es-VE":{moneda:"Bol√≠var",codigo:"VES"},"es-ES":{moneda:"Euro",codigo:"EUR"},"en-US":{moneda:"D√≥lar USD",codigo:"USD"},"en-GB":{moneda:"Libra",codigo:"GBP"},"fr-FR":{moneda:"Euro",codigo:"EUR"},"es-AR":{moneda:"Peso Arg",codigo:"ARS"},"es-CO":{moneda:"Peso Col",codigo:"COP"},"es-MX":{moneda:"Peso Mex",codigo:"MXN"},es:{moneda:"D√≥lar USD",codigo:"USD"},"es-419":{moneda:"D√≥lar USD",codigo:"USD"}},U=(e,t)=>{if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"");return n.length<2||/^\d/.test(n)?`campo_${t+1}_${n}`:n},z=e=>({personal:"Personal",access:"Accesos / Claves",financial:"Financiero",health:"Salud",home:"Hogar",car:"Veh√≠culo",job:"Laboral",education:"Educaci√≥n",custom:"Personalizado",all:"Todas"}[e]||"Otros"),H=e=>({personal:"üë§",access:"üîê",financial:"üí≥",health:"‚ù§Ô∏è",home:"üè†",car:"üöó",job:"üíº",education:"üéì",custom:"‚ö°",all:"üìÇ"}[e]||"üìã");class R{constructor(e){this.handlers=e}render(e,t,n){const s=e.filter(e=>!e.settings?.isSystemTemplate),a=t.map(e=>{const t=e.id===n;return`\n        <button class="flex items-center px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border cursor-pointer whitespace-nowrap ${t?"bg-slate-800 text-white border-slate-800 shadow-lg shadow-slate-200 scale-105":"bg-white text-slate-600 border-slate-200 hover:border-primary/50 hover:bg-slate-50 hover:text-slate-800"} category-filter" data-category="${e.id}">\n            <span class="mr-2 text-lg">${H(e.id)}</span>\n            ${z(e.id)}\n            <span class="ml-2 ${t?"bg-white/20":"bg-slate-100 text-slate-500"} px-2 py-0.5 rounded-full text-xs transition-colors">\n                ${e.count}\n            </span>\n        </button>`}).join(""),r="all"===n;return`\n      <div class="animate-fade-in space-y-8">\n        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">\n            <div class="flex items-center gap-4">\n              <div class="p-3 bg-white rounded-xl shadow-sm border border-slate-100">\n                <i class="fas fa-swatchbook text-2xl text-indigo-600"></i>\n              </div>\n              <div>\n                <h2 class="text-2xl font-bold text-slate-800">Mis Plantillas</h2>\n                <p class="text-slate-500 text-sm">Dise√±a las estructuras para tus datos.</p>\n              </div>\n            </div>\n            \n            <div class="flex gap-3 w-full md:w-auto">\n              <input type="file" id="importTemplateInput" accept=".json" class="hidden" />\n              <button id="btnImportTemplate" class="flex-1 md:flex-none px-4 py-2.5 bg-white border border-slate-200 text-slate-700 hover:text-indigo-600 hover:border-indigo-200 font-medium rounded-xl transition shadow-sm flex items-center justify-center gap-2">\n                <i class="fas fa-file-import"></i> <span>Importar</span>\n              </button>\n              <button id="btnNewTemplate" class="flex-1 md:flex-none px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2">\n                <i class="fas fa-plus"></i> <span>Nueva Plantilla</span>\n              </button>\n            </div>\n        </div>\n\n        <div class="flex space-x-3 overflow-x-auto pb-4 no-scrollbar">\n            ${`\n        <button class="flex items-center px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border cursor-pointer whitespace-nowrap category-filter ${r?"bg-slate-800 text-white border-slate-800 shadow-lg":"bg-white text-slate-600 border-slate-200 hover:bg-slate-50"}" data-category="all">\n            <span class="mr-2 text-lg">üí†</span> Todas\n            <span class="ml-2 ${r?"bg-white/20":"bg-slate-100 text-slate-500"} px-2 py-0.5 rounded-full text-xs">${e.length}</span>\n        </button>\n    `}\n            ${a}\n        </div>\n\n        <div id="customTemplatesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">\n            ${s.map(e=>this.renderCard(e)).join("")}\n        </div>\n        \n        ${0===s.length?'\n            <div class="text-center py-16 bg-white rounded-2xl border border-dashed border-slate-300">\n                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üì≠</div>\n                <p class="text-slate-500 font-medium">No hay plantillas en esta categor√≠a.</p>\n                <button class="mt-4 text-indigo-600 font-medium text-sm hover:underline" onclick="document.querySelector(\'[data-category=all]\').click()">\n                    Ver todas las plantillas\n                </button>\n            </div>\n        ':""}\n      </div>`}renderCard(e){const t=e.fields.length,n=`background-color: ${e.color}15; color: ${e.color}`;return`\n    <div class="template-card group relative bg-white border border-slate-200 rounded-2xl p-5 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden" \n         data-template-id="${e.id}">\n      \n      <div class="absolute top-0 left-0 right-0 h-1" style="background-color: ${e.color}"></div>\n\n      <div class="flex justify-between items-start mb-4">\n          <div class="flex items-center gap-4">\n            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-inner border border-slate-50" style="${n}">\n                ${e.icon||"üìã"}\n            </div>\n            <div>\n                <h4 class="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition-colors">${e.name}</h4>\n                <div class="flex items-center text-xs text-slate-500 mt-1">\n                    <span class="bg-slate-100 px-2 py-0.5 rounded uppercase tracking-wider font-semibold mr-2">${z(e.settings?.category)}</span>\n                </div>\n            </div>\n          </div>\n          \n          <div class="flex flex-col gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity duration-200 absolute top-4 right-4 sm:relative sm:top-auto sm:right-auto bg-white sm:bg-transparent shadow-sm sm:shadow-none rounded-lg p-1 sm:p-0 border sm:border-0 border-slate-100">\n              <button class="edit-template w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition" title="Editar Estructura">\n                <i class="fas fa-pencil-alt"></i>\n              </button>\n              <button class="export-template w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 transition" title="Exportar JSON">\n                <i class="fas fa-file-export"></i>\n              </button>\n              <button class="delete-template w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 transition" title="Eliminar">\n                <i class="fas fa-trash-alt"></i>\n              </button>\n          </div>\n      </div>\n      \n      <p class="text-sm text-slate-500 mb-6 line-clamp-2 h-10 leading-relaxed">\n        ${e.description||"Sin descripci√≥n disponible."}\n      </p>\n\n      <div class="flex items-center justify-between pt-4 border-t border-slate-100">\n        <div class="text-xs font-medium text-slate-400 flex items-center">\n            <i class="fas fa-layer-group mr-1.5"></i> ${t} Campos\n        </div>\n        <button class="use-template-btn px-4 py-2 bg-slate-50 hover:bg-indigo-600 hover:text-white text-indigo-600 text-sm font-bold rounded-lg transition-colors">\n            Usar Plantilla\n        </button>\n      </div>\n    </div>`}setupListeners(e){e.querySelector("#btnNewTemplate")?.addEventListener("click",this.handlers.onNew);const t=e.querySelector("#importTemplateInput");e.querySelector("#btnImportTemplate")?.addEventListener("click",()=>t.click()),t?.addEventListener("change",e=>{e.target.files.length&&this.handlers.onImport(e.target.files[0])}),e.querySelectorAll(".category-filter").forEach(e=>{e.addEventListener("click",e=>this.handlers.onFilter(e.currentTarget.dataset.category))}),e.addEventListener("click",e=>{if(e.target.closest(".use-template-btn")){e.stopPropagation();const t=e.target.closest(".template-card");return void(t&&this.handlers.onSelect(t.dataset.templateId))}const t=e.target.closest(".edit-template");if(t){e.stopPropagation();const n=t.closest(".template-card");return void this.handlers.onEdit(n.dataset.templateId)}const n=e.target.closest(".delete-template");if(n){e.stopPropagation();const t=n.closest(".template-card");return void this.handlers.onDelete(t.dataset.templateId)}const s=e.target.closest(".export-template");if(s){e.stopPropagation();const t=s.closest(".template-card");return void this.handlers.onExport(t.dataset.templateId)}const a=e.target.closest(".template-card");a&&!e.target.closest("button")&&this.handlers.onSelect(a.dataset.templateId)})}}class V{constructor(e){this.handlers=e,this.activeFieldItem=null,this.mainSortable=null,this.modalSortable=null}render(e=null){const t=!!e,n=e?.settings?.category||"custom",s=e?.icon||"üìã",a=e?.color||"#4F46E5";return`\n      <div class="max-w-4xl mx-auto animate-fade-in pb-16">\n          <div class="flex justify-between items-center mb-8 sticky top-0 z-10 bg-gray-50/90 backdrop-blur py-4 border-b border-gray-200">\n            <div>\n                <h3 class="text-2xl font-bold text-slate-800 flex items-center">\n                    <span class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mr-3 text-lg">\n                        <i class="fas fa-${t?"edit":"magic"}"></i>\n                    </span>\n                    ${t?"Editar Plantilla":"Dise√±ador de Plantillas"}\n                </h3>\n            </div>\n            <div class="flex gap-3">\n                 <button type="button" id="cancelTemplate" class="px-5 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 transition font-medium shadow-sm">Cancelar</button>\n                 <button type="submit" form="templateForm" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition font-bold flex items-center">\n                      <i class="fas fa-save mr-2"></i> Guardar\n                 </button>\n            </div>\n          </div>\n          \n          <form id="templateForm" class="space-y-8">\n              <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-slate-200">\n                  <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-6 flex items-center">\n                     <i class="fas fa-info-circle mr-2"></i> Informaci√≥n General\n                  </h4>\n\n                  <div class="grid grid-cols-1 md:grid-cols-12 gap-6">\n                      <div class="md:col-span-8">\n                          <label class="block text-sm font-bold text-slate-700 mb-2">Nombre de la Plantilla</label>\n                          <input type="text" id="templateName" value="${e?.name||""}" \n                                 class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition text-slate-800 font-medium" \n                                 required placeholder="Ej: Registro de Mantenimiento">\n                      </div>\n\n                      <div class="md:col-span-4">\n                          <label class="block text-sm font-bold text-slate-700 mb-2">Categor√≠a</label>\n                          <div class="relative">\n                              <select id="templateCategory" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition appearance-none bg-white cursor-pointer">\n                                  ${[{value:"custom",label:"Personalizado"},{value:"personal",label:"Personal"},{value:"access",label:"Accesos"},{value:"financial",label:"Financiero"},{value:"health",label:"Salud"},{value:"home",label:"Hogar"},{value:"car",label:"Veh√≠culo"},{value:"job",label:"Trabajo"},{value:"education",label:"Formaci√≥n"}].map(e=>`<option value="${e.value}" ${e.value===n?"selected":""}>${e.label}</option>`).join("")}\n                              </select>\n                              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>\n                          </div>\n                      </div>\n\n                      <div class="md:col-span-4">\n                          <label class="block text-sm font-bold text-slate-700 mb-2">Icono (Emoji)</label>\n                          <input type="text" id="templateIcon" value="${s}" \n                                 class="w-full px-4 py-3 border border-slate-200 rounded-xl text-center text-2xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition" \n                                 placeholder="üìã">\n                      </div>\n                      \n                      <div class="md:col-span-8">\n                          <label class="block text-sm font-bold text-slate-700 mb-2">Color Identificativo</label>\n                          <div class="flex items-center h-[54px] border border-slate-200 rounded-xl p-2 bg-white">\n                              <input type="color" id="templateColor" value="${a}" class="h-full w-full rounded cursor-pointer border-none bg-transparent">\n                          </div>\n                      </div>\n\n                      <div class="md:col-span-12">\n                          <label class="block text-sm font-bold text-slate-700 mb-2">Descripci√≥n</label>\n                          <input type="text" id="templateDescription" value="${e?.description||""}" \n                                 class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition" \n                                 placeholder="¬øPara qu√© sirve esta plantilla?">\n                      </div>\n                  </div>\n              </div>\n              \n              <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-sm border border-slate-200 relative">\n                  <div class="flex justify-between items-center mb-6">\n                    <div>\n                        <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center">\n                            <i class="fas fa-cubes mr-2"></i> Estructura de Datos\n                        </h4>\n                        <p class="text-xs text-slate-500 mt-1">Arrastra desde el √≠cono <i class="fas fa-grip-vertical mx-1"></i> para reordenar.</p>\n                    </div>\n                    <button type="button" id="addFieldBtn" class="px-4 py-2 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 rounded-lg transition font-bold border border-indigo-200 shadow-sm flex items-center">\n                        <i class="fas fa-plus-circle mr-2"></i> Agregar Campo\n                    </button>\n                  </div>\n\n                  <div id="fieldsContainer" class="space-y-4 min-h-[100px]">\n                      ${(e?.fields||[]).map((e,t)=>this.renderFieldItem(e,t)).join("")}\n                  </div>\n                  \n                  <div id="noFieldsMessage" class="${e?.fields?.length?"hidden":""} flex flex-col items-center justify-center py-12 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50/50 mt-4">\n                      <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-3xl text-slate-300"><i class="fas fa-layer-group"></i></div>\n                      <p class="text-slate-600 font-bold">Lienzo Vac√≠o</p>\n                      <p class="text-sm text-slate-400">Comienza agregando tu primer campo arriba.</p>\n                  </div>\n              </div>\n          </form>\n      </div>\n\n      ${this.renderColumnsModal()} \n    `}renderFieldItem(e=null,t=0){const n=e?.id||U(e?.label||`campo_${t+1}`,t),s=q(),a="table"===e?.type&&e.columns?e.columns.length:0,r="table"===e?.type?JSON.stringify(e.columns):"[]";return`\n    <div class="field-item group relative bg-white border border-slate-200 rounded-xl p-2 transition-all hover:shadow-md hover:border-indigo-300" data-field-id="${n}">\n      <div class="flex items-start">\n        <div class="hidden md:flex flex-col items-center justify-center w-10 py-4 text-slate-300 cursor-grab active:cursor-grabbing hover:text-slate-500 drag-handle self-stretch border-r border-slate-100 mr-4">\n            <i class="fas fa-grip-vertical"></i>\n        </div>\n\n        <div class="flex-grow p-2">\n            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">\n                <div class="md:col-span-7">\n                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Etiqueta</label>\n                    <input type="text" class="field-label w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition font-medium text-slate-800" \n                           value="${e?.label||""}" placeholder="Nombre del campo" required />\n                </div>\n                \n                <div class="md:col-span-5 relative">\n                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tipo</label>\n                    <select class="field-type w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition appearance-none cursor-pointer">\n                        ${s.map(t=>`<option value="${t.value}" ${e?.type===t.value?"selected":""}>${t.label}</option>`).join("")}\n                    </select>\n                    <div class="pointer-events-none absolute bottom-3 right-3 flex items-center text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>\n                </div>\n            </div>\n\n            <div class="space-y-3">\n                <div class="options-input-group ${"select"===e?.type?"":"hidden"}">\n                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Opciones</label>\n                    <input type="text" class="field-options w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm" \n                           value="${(e?.options||[]).join(", ")}" placeholder="Opci√≥n 1, Opci√≥n 2...">\n                </div>\n\n                <div class="table-config-group ${"table"===e?.type?"":"hidden"}">\n                    <input type="hidden" class="field-columns-data" value='${r}'>\n                    <div class="flex items-center justify-between p-3 bg-indigo-50/50 rounded-lg border border-indigo-100">\n                        <div class="flex items-center">\n                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mr-3"><i class="fas fa-table text-sm"></i></div>\n                            <div>\n                                <p class="text-sm font-bold text-indigo-900">Tabla Configurada</p>\n                                <p class="text-xs text-indigo-600"><span class="columns-count-badge font-bold">${a}</span> columnas</p>\n                            </div>\n                        </div>\n                        <button type="button" class="configure-table-btn px-3 py-1.5 bg-white text-indigo-600 text-xs font-bold border border-indigo-200 rounded-lg hover:bg-indigo-50 shadow-sm transition">\n                            Configurar\n                        </button>\n                    </div>\n                </div>\n\n                <div class="flex items-center justify-between pt-3 border-t border-slate-50">\n                    <label class="flex items-center cursor-pointer select-none">\n                        <input type="checkbox" class="field-required form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500" ${e?.required?"checked":""}>\n                        <span class="ml-2 text-xs font-bold text-slate-500">Obligatorio</span>\n                    </label>\n                </div>\n            </div>\n        </div>\n\n        <button type="button" class="remove-field absolute -top-2 -right-2 w-7 h-7 bg-white text-slate-300 hover:text-red-500 border border-slate-200 hover:border-red-200 rounded-full shadow-sm flex items-center justify-center transition-all z-10">\n            <i class="fas fa-times text-xs"></i>\n        </button>\n      </div>\n    </div>`}renderColumnsModal(){return'\n      <div id="columnsModal" class="fixed inset-0 z-50 hidden">\n        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" id="closeModalBackdrop"></div>\n        <div class="flex items-center justify-center min-h-screen p-4 w-full">\n            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] relative animate-scale-in">\n                \n                <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">\n                    <div>\n                        <h3 class="text-lg font-bold text-slate-800">Configurar Columnas</h3>\n                        <p class="text-xs text-slate-500">Arrastra para reordenar las columnas.</p>\n                    </div>\n                    <button type="button" id="closeModalTop" class="text-slate-400 hover:text-slate-600 bg-slate-100 hover:bg-slate-200 w-8 h-8 rounded-full transition flex items-center justify-center"><i class="fas fa-times"></i></button>\n                </div>\n                \n                <div class="p-6 overflow-y-auto flex-grow bg-slate-50/50">\n                    <div id="modalColumnsContainer" class="space-y-4"></div>\n                    \n                    <div id="noColumnsMessage" class="flex flex-col items-center justify-center py-10 border-2 border-dashed border-slate-300 rounded-xl bg-white mt-2">\n                        <p class="text-slate-500 font-medium mb-2">Sin columnas</p>\n                        <button type="button" id="addColBtnEmpty" class="text-indigo-600 text-sm font-bold hover:underline">Agregar primera columna</button>\n                    </div>\n\n                    <button type="button" id="addColBtn" class="mt-6 w-full py-3 border-2 border-dashed border-indigo-200 bg-indigo-50/30 text-indigo-600 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 transition flex items-center justify-center font-bold text-sm">\n                        <i class="fas fa-plus-circle mr-2"></i> Agregar Nueva Columna\n                    </button>\n                </div>\n\n                <div class="px-6 py-4 border-t border-slate-100 flex justify-end space-x-3 bg-white rounded-b-2xl">\n                    <button type="button" id="cancelModalBtn" class="px-5 py-2 text-slate-600 font-bold hover:bg-slate-50 rounded-lg transition">Cancelar</button>\n                    <button type="button" id="saveModalBtn" class="px-6 py-2 text-white bg-indigo-600 hover:bg-indigo-700 font-bold rounded-lg shadow-lg shadow-indigo-500/20 transition">Guardar Cambios</button>\n                </div>\n            </div>\n        </div>\n      </div>'}setupListeners(e){const t=e.querySelector("#templateCategory"),n=e.querySelector("#templateIcon");t&&n&&t.addEventListener("change",e=>n.value=H(e.target.value)),e.querySelector("#addFieldBtn")?.addEventListener("click",()=>this.addField(e)),this.initSortable(e.querySelector("#fieldsContainer"),"main");const s=e.querySelector("#fieldsContainer");s&&(s.addEventListener("click",t=>{t.target.closest(".remove-field")&&(t.target.closest(".field-item").remove(),this.updateNoFieldsMessage(e)),t.target.closest(".configure-table-btn")&&this.openColumnsModal(t.target.closest(".field-item"))}),s.addEventListener("change",e=>{if(e.target.classList.contains("field-type")){const t=e.target.closest(".field-item"),n=e.target.value;t.querySelector(".table-config-group").classList.toggle("hidden","table"!==n),t.querySelector(".options-input-group").classList.toggle("hidden","select"!==n)}})),e.querySelector("#templateForm")?.addEventListener("submit",e=>{e.preventDefault(),this.saveData()}),e.querySelector("#cancelTemplate")?.addEventListener("click",()=>this.handlers.onCancel()),this.setupModalListeners()}initSortable(e,t){if(!e||!window.Sortable)return;"main"===t&&this.mainSortable&&this.mainSortable.destroy(),"modal"===t&&this.modalSortable&&this.modalSortable.destroy();const n=new window.Sortable(e,{animation:150,handle:".drag-handle",ghostClass:"bg-indigo-50",chosenClass:"bg-indigo-50",forceFallback:!0,onEnd:()=>{}});"main"===t?this.mainSortable=n:this.modalSortable=n}addField(e){const t=e.querySelector("#fieldsContainer"),n=t.querySelectorAll(".field-item").length;t.insertAdjacentHTML("beforeend",this.renderFieldItem(null,n)),this.updateNoFieldsMessage(e)}updateNoFieldsMessage(e){const t=e.querySelector("#fieldsContainer"),n=e.querySelector("#noFieldsMessage");t&&n&&n.classList.toggle("hidden",t.children.length>0)}setupModalListeners(){const e=document.getElementById("columnsModal");if(!e)return;const t=()=>{e.classList.add("hidden"),e.classList.remove("flex")};e.querySelector("#closeModalTop").onclick=t,e.querySelector("#cancelModalBtn").onclick=t,e.querySelector("#closeModalBackdrop").onclick=t;const n=()=>{const t=e.querySelector("#modalColumnsContainer"),n=t.querySelectorAll(".field-item").length;t.insertAdjacentHTML("beforeend",this.renderFieldItem(null,n));[...t.lastElementChild.querySelector(".field-type").options].forEach(e=>{"table"===e.value&&e.remove()}),e.querySelector("#noColumnsMessage").classList.add("hidden")};e.querySelector("#addColBtn").onclick=n;const s=e.querySelector("#addColBtnEmpty");s&&(s.onclick=n);const a=e.querySelector("#modalColumnsContainer");a.onclick=t=>{const n=t.target.closest(".remove-field");n&&(n.closest(".field-item").remove(),0===a.children.length&&e.querySelector("#noColumnsMessage").classList.remove("hidden"))},a.onchange=e=>{if(e.target.classList.contains("field-type")){e.target.closest(".field-item").querySelector(".options-input-group").classList.toggle("hidden","select"!==e.target.value)}},e.querySelector("#saveModalBtn").onclick=()=>{const e=this.collectFields(a),n=this.activeFieldItem;n.querySelector(".field-columns-data").value=JSON.stringify(e),n.querySelector(".columns-count-badge").textContent=e.length,t()}}openColumnsModal(e){this.activeFieldItem=e;const t=document.getElementById("columnsModal"),n=document.getElementById("modalColumnsContainer"),s=e.querySelector(".field-columns-data");let a=[];try{a=JSON.parse(s.value||"[]")}catch(r){}n.innerHTML="",a.forEach((e,t)=>{n.insertAdjacentHTML("beforeend",this.renderFieldItem(e,t));const s=n.lastElementChild;[...s.querySelector(".field-type").options].forEach(e=>{"table"===e.value&&e.remove()}),"select"===e.type&&s.querySelector(".options-input-group").classList.remove("hidden")}),this.initSortable(n,"modal"),t.querySelector("#noColumnsMessage").classList.toggle("hidden",a.length>0),t.classList.remove("hidden"),t.classList.add("flex")}collectFields(e){const t=[];return e.querySelectorAll(".field-item").forEach((e,n)=>{const s=e.querySelector(".field-label").value.trim();if(!s)return;const a=e.querySelector(".field-type").value,r=U(s,n);let i=[];if("select"===a){const t=e.querySelector(".field-options").value;t&&(i=t.split(",").map(e=>e.trim()).filter(e=>e))}let o=[];if("table"===a)try{o=JSON.parse(e.querySelector(".field-columns-data").value)}catch(l){}t.push({id:r,label:s,type:a,order:n+1,required:e.querySelector(".field-required").checked,...i.length&&{options:i},...o.length&&{columns:o}})}),t}saveData(){try{const e=document.getElementById("templateName").value.trim();if(!e)throw new Error("Debes ponerle un nombre a la plantilla");const t=this.collectFields(document.getElementById("fieldsContainer"));if(0===t.length)throw new Error("La plantilla debe tener al menos un campo");const n={name:e,category:document.getElementById("templateCategory").value,icon:document.getElementById("templateIcon").value,color:document.getElementById("templateColor").value,description:document.getElementById("templateDescription").value,fields:t};this.handlers.onSave(n)}catch(e){alert(e.message)}}}class J{constructor(e){this.onTemplateSelect=e,this.currentView="list",this.editingTemplateId=null,this.listComponent=new R({onNew:()=>this.setView("create"),onImport:e=>this.handleImport(e),onSelect:e=>this.onTemplateSelect(e),onEdit:e=>this.setView("edit",e),onDelete:e=>this.handleDelete(e),onExport:e=>this.handleExport(e),onFilter:e=>this.loadTemplates(e)}),this.formComponent=new V({onSave:e=>this.handleSave(e),onCancel:()=>this.setView("list")})}render(){return'<div id="templateContent" class="min-h-[500px] animate-fade-in"></div>'}async setView(e,t=null){this.currentView=e,this.editingTemplateId=t;const n=document.getElementById("templateContent");if(n)if(this.renderLoading(n),"list"===e)await this.loadTemplates();else{let e=null;t&&(e=await N.getTemplateById(t)),n.innerHTML=this.formComponent.render(e),this.formComponent.setupListeners(n)}}async loadTemplates(e="all"){const t=document.getElementById("templateContent");if(t&&("list"===this.currentView||!t.querySelector("form"))){t.innerHTML.trim()||this.renderLoading(t);try{const n=await N.getUserTemplates(),s=await N.getCategories();let a=n;"all"!==e&&(a=n.filter(t=>t.settings.category===e)),t.innerHTML=this.listComponent.render(a,s,e),this.listComponent.setupListeners(t)}catch(n){t.innerHTML=`\n        <div class="max-w-lg mx-auto mt-10 p-6 bg-red-50 border border-red-100 rounded-2xl text-center">\n            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 text-red-500">\n                <i class="fas fa-exclamation-triangle"></i>\n            </div>\n            <h3 class="text-red-800 font-bold">Error de Carga</h3>\n            <p class="text-red-600 text-sm mt-1">${n.message}</p>\n            <button onclick="document.getElementById('navHome').click()" class="mt-4 text-sm text-red-700 underline">Volver al inicio</button>\n        </div>`}}}renderLoading(e){e.innerHTML='\n        <div class="flex flex-col items-center justify-center h-64">\n            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>\n            <p class="text-slate-400 text-sm mt-3 animate-pulse">Cargando gestor...</p>\n        </div>'}async handleSave(e){try{"edit"===this.currentView&&this.editingTemplateId?await N.updateTemplate(this.editingTemplateId,e):await N.createTemplate(e),this.setView("list")}catch(t){alert("Error: "+t.message)}}async handleDelete(e){if(confirm("¬øEliminar plantilla? Esta acci√≥n es irreversible."))try{await N.deleteTemplate(e),this.loadTemplates()}catch(t){alert("Error: "+t.message)}}async handleExport(e){try{const t=await N.exportTemplate(e),n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=`${(t.name||"plantilla").replace(/[^a-z0-9]/gi,"_").toLowerCase()}.template.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}catch(t){alert("Error: "+t.message)}}async handleImport(e){const t=new FileReader;t.onload=async e=>{try{const t=JSON.parse(e.target.result);await N.importTemplate(t),this.loadTemplates()}catch(t){alert("Error importando: "+t.message)}},t.readAsText(e)}}const K=new class{get inputBaseClass(){return"block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 text-sm placeholder-slate-400 focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all outline-none"}renderField(e,t=""){if(!e||!e.type)return'<p class="text-red-500 text-xs">Error: Campo sin tipo.</p>';const n=e.required?"required":"",s=(a=e.type,j.find(e=>e.value===a)||j[0]);var a;let r=s?.inputType||"text",i="";if("checkbox"===r)i=`\n        <div class="flex items-center h-full pt-1">\n          <label class="relative inline-flex items-center cursor-pointer">\n            <input type="checkbox" id="${e.id}" name="${e.id}" \n                   class="peer sr-only form-checkbox" ${t?"checked":""} />\n            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>\n            <span class="ml-3 text-sm font-medium text-slate-600 select-none cursor-pointer">Activar</span>\n          </label>\n        </div>`;else if("textarea"===r)i=`<textarea id="${e.id}" name="${e.id}" rows="3"\n        class="${this.inputBaseClass}" \n        placeholder="${e.placeholder||"Escribe aqu√≠..."}" ${n}>${t}</textarea>`;else if("url"===r){let s=t?.url||("string"==typeof t?t:""),a=t?.text||"";i=`\n        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 url-group">\n           <div class="sm:col-span-2 relative">\n             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i class="fas fa-link text-xs"></i></div>\n             <input type="url" id="${e.id}_url" class="${this.inputBaseClass} pl-9" \n                    placeholder="https://ejemplo.com" value="${s}" ${n} />\n           </div>\n           <div class="relative">\n             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i class="fas fa-font text-xs"></i></div>\n             <input type="text" id="${e.id}_text" class="${this.inputBaseClass} pl-9" \n                    placeholder="Etiqueta (Opcional)" value="${a}" />\n           </div>\n        </div>\n      `}else if("select"===r){const s=(e.options||[]).map(e=>`<option value="${e}" ${t===e?"selected":""}>${e}</option>`).join("");i=`\n        <div class="relative">\n          <select id="${e.id}" name="${e.id}" class="${this.inputBaseClass} appearance-none cursor-pointer" ${n}>\n            <option value="" disabled ${t?"":"selected"}>Seleccionar opci√≥n...</option>\n            ${s}\n          </select>\n          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">\n            <i class="fas fa-chevron-down text-xs"></i>\n          </div>\n        </div>`}else if("table"===r){const n=(e.columns||[]).map(e=>`<th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-50 border-b border-slate-100">${e.label}</th>`).join(""),s=Array.isArray(t)?t:[];i=`\n        <div class="table-input-container rounded-xl border border-slate-200 bg-white overflow-hidden shadow-sm" data-field-id="${e.id}">\n          <input type="hidden" id="${e.id}" name="${e.id}" value='${JSON.stringify(s)}' class="form-table-data">\n          \n          <div class="overflow-x-auto">\n            <table class="min-w-full divide-y divide-slate-100">\n              <thead><tr>${n}<th class="w-10 bg-slate-50 border-b border-slate-100"></th></tr></thead>\n              <tbody class="bg-white divide-y divide-slate-100 table-body"></tbody>\n            </table>\n          </div>\n          \n          <button type="button" class="add-row-btn w-full py-3 bg-slate-50 hover:bg-slate-100 text-primary font-medium text-sm transition-colors border-t border-slate-200 flex items-center justify-center gap-2">\n            <i class="fas fa-plus-circle"></i> Agregar Fila\n          </button>\n        </div>\n        <script type="application/json" class="columns-def">${JSON.stringify(e.columns||[])}<\/script>\n      `}else{let s=["number","currency","percentage"].includes(e.type)?"text":r,a="";"email"===e.type?a="fa-envelope":"date"===e.type?a="fa-calendar":"secret"===e.type?a="fa-key":"currency"===e.type&&(a="fa-dollar-sign");const o=a?"pl-10":"";i=`\n        <div class="relative">\n          ${a?`<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i class="fas ${a}"></i></div>`:""}\n          <input type="${s}" id="${e.id}" name="${e.id}" \n            class="${this.inputBaseClass} ${o}" \n            placeholder="${e.placeholder||""}" value="${t}" ${n} />\n        </div>\n      `}return`\n      <div class="field-wrapper ${"table"===e.type||"text"===e.type||"url"===e.type||"textarea"===e.type?"md:col-span-2":"md:col-span-1"} group">\n        <label for="${e.id}" class="block text-sm font-bold text-slate-700 mb-1.5 ml-1 flex items-center justify-between">\n            <span>${e.label} ${e.required?'<span class="text-red-400">*</span>':""}</span>\n        </label>\n        ${i}\n      </div>\n    `}generateFormHtml(e,t={}){return e&&e.fields?e.fields.map(e=>this.renderField(e,t[e.id]||"")).join(""):'<div class="p-4 bg-red-50 text-red-600 rounded-lg">Error: Plantilla da√±ada.</div>'}},G={};class W{constructor(e={}){this.id=e.id||this.generateId(),this.userId=e.userId,this.areaId=e.areaId,this.encryptedContent=e.encryptedContent||"",this.contentHash=e.contentHash||"",this.encryptionMetadata=e.encryptionMetadata||{encryptedItemKey:"",iv:"",salt:"",algorithm:"AES-GCM-256",version:"1.0"},this.metadata=e.metadata||{title:"",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),tags:[],isFavorite:!1,icon:"üìÑ"},this.sharedWith=e.sharedWith||{},this.templateId=e.templateId||"",this.fieldOrder=e.fieldOrder||[],this.version=e.version||1}generateId(){return"doc_"+Math.random().toString(36).substr(2,9)}toFirestore(){return{id:this.id,userId:this.userId,areaId:this.areaId,encryptedContent:this.encryptedContent,contentHash:this.contentHash,encryptionMetadata:this.encryptionMetadata,metadata:this.metadata,sharedWith:this.sharedWith,templateId:this.templateId,fieldOrder:this.fieldOrder,version:this.version}}}const X=new class{constructor(){this.collectionPath="vault"}async createDocument(e,t){const n=B.getCurrentUser();if(!n)throw new Error("Usuario no autenticado");const s={...t,_templateVersion:e.updatedAt},a=await D.encryptDocument(s),r=new W({userId:n.uid,templateId:e.id,encryptedContent:a.content,encryptionMetadata:a.metadata,metadata:{title:this.generateDocumentTitle(e,t),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),icon:e.icon||"üìÑ",isFavorite:!1}}),i=E.doc(`artifacts/mi-gestion-v1/users/${n.uid}/vault/${r.id}`);return await E.setDoc(i,r.toFirestore()),r}async getAllDocuments(){const e=B.getCurrentUser();if(!e)throw new Error("Usuario no autenticado");const t=`artifacts/mi-gestion-v1/users/${e.uid}/vault`,n=E.getFirestore(),{collection:s,getDocs:a,query:r,orderBy:i}=window.firebaseModules;try{const e=r(s(n,t),i("metadata.updatedAt","desc")),o=await a(e),l=[];return o.forEach(e=>{l.push(e.data())}),l}catch(o){return[]}}async getDocumentById(e){const t=B.getCurrentUser();if(!t)throw new Error("Usuario no autenticado");try{const n=E.doc(`artifacts/mi-gestion-v1/users/${t.uid}/vault/${e}`),s=await E.getDoc(n);if(s.exists())return s.data();throw new Error("Documento no encontrado")}catch(n){throw n}}async loadDocumentForEditing(e){if(!B.getCurrentUser())throw new Error("Usuario no autenticado");const{templateService:t}=await function(e,t){let n=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),a=s?.nonce||s?.getAttribute("nonce");n=e(t.map(e=>{if((e=function(e){return"/"+e}(e))in G)return;G[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,a&&s.setAttribute("nonce",a),document.head.appendChild(s),t?new Promise((t,n)=>{s.addEventListener("load",t),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function s(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then(t=>{for(const e of t||[])"rejected"===e.status&&s(e.reason);return e().catch(s)})}(async()=>{const{templateService:e}=await Promise.resolve().then(()=>_);return{templateService:e}},void 0),n=await this.getDocumentById(e);if(!n.encryptionMetadata||!n.encryptedContent)throw new Error("Datos cifrados incompletos o corruptos.");const s=await D.decryptDocument({content:n.encryptedContent,metadata:n.encryptionMetadata}),a=await t.getTemplateById(n.templateId);if(!a)throw new Error("Plantilla asociada no encontrada.");return{template:a,formData:s,documentId:e,metadata:n.metadata}}async updateDocument(e,t,n){const s=B.getCurrentUser();if(!s)throw new Error("Usuario no autenticado");const a={...n,_templateVersion:t.updatedAt},r=await D.encryptDocument(a,e),i={encryptedContent:r.content,encryptionMetadata:r.metadata,metadata:{...t.metadata,title:this.generateDocumentTitle(t,n),updatedAt:(new Date).toISOString(),icon:t.icon||"üìÑ",isFavorite:!1}},o=E.doc(`artifacts/mi-gestion-v1/users/${s.uid}/vault/${e}`);return await E.setDoc(o,i,{merge:!0}),{id:e,...i}}async deleteDocument(e){const t=B.getCurrentUser();if(!t)throw new Error("Usuario no autenticado");try{const n=E.doc(`artifacts/mi-gestion-v1/users/${t.uid}/vault/${e}`);return await E.deleteDoc(n),{success:!0}}catch(n){throw new Error("No se pudo eliminar el documento de la b√≥veda.")}}generateDocumentTitle(e,t){const n=e.fields[0];if(n&&void 0!==t[n.id]&&null!==t[n.id]){const e=t[n.id];let s=String(e);if(s.length>0||0===e||!1===e)return s.length>50&&(s=s.substring(0,50)+"..."),s}return`${e.name} - ${(new Date).toLocaleDateString()}`}};class Y{constructor(e,t,n){this.initialData=e,this.onSaveSuccess=t,this.onCancel=n,this.isEditing=!!e.documentId,this.documentId=e.documentId||null,this.template=e.template||null,this.initialFormData=e.formData||{},this.documentMetadata=e.metadata||{},this.isSubmitting=!1,this.isEditing&&!this.template&&this.loadExistingDocument()}async loadExistingDocument(){this.updateEditorState(!0,"Descifrando datos...");try{const e=await X.loadDocumentForEditing(this.documentId);this.template=e.template,this.initialFormData=e.formData,this.documentMetadata=e.metadata,this.render(),this.setupEventListeners(),this.updateEditorState(!1)}catch(e){this.renderError("No se pudo descifrar el documento. Verifica tu contrase√±a.")}}render(){if(!this.template&&this.isEditing)return'<div id="editorContainer" class="flex justify-center items-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-primary"></div></div>';if(!this.template)return'<div class="p-4 text-red-500">Error cr√≠tico: Plantilla perdida.</div>';const e=this.isEditing?"Editar Documento":"Nuevo Documento",t=this.isEditing?`Actualizando: ${this.documentMetadata?.title}`:`Plantilla: ${this.template.name}`,n=this.isEditing?"Guardar Cambios":"Crear Documento";return`\n      <div id="editorContainer" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden animate-fade-in mb-10">\n        <div class="px-6 py-5 border-b border-slate-100 bg-white flex justify-between items-center sticky top-0 z-20 backdrop-blur-md bg-white/90">\n          <div class="flex items-center gap-4">\n            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-sm border border-slate-50" style="background-color: ${this.template.color}10; color: ${this.template.color}">\n                ${this.template.icon}\n            </div>\n            <div>\n              <h2 class="text-xl font-bold text-slate-800 tracking-tight">${e}</h2>\n              <p class="text-sm text-slate-500 font-medium">${t}</p>\n            </div>\n          </div>\n          <button id="closeEditorBtn" class="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100 transition"><i class="fas fa-times text-lg"></i></button>\n        </div>\n\n        <div class="p-6 sm:p-8 bg-slate-50/30">\n          <div id="dynamicFormContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">\n            ${K.generateFormHtml(this.template,this.initialFormData)}\n          </div>\n\n          <div class="mt-8 mb-6 flex items-start p-4 bg-emerald-50 border border-emerald-100 rounded-xl">\n            <div class="p-2 bg-emerald-100 rounded-lg text-emerald-600 mr-4">\n                <i class="fas fa-shield-alt text-xl"></i>\n            </div>\n            <div class="text-sm text-emerald-800">\n              <p class="font-bold">Seguridad E2EE Activa</p>\n              <p class="opacity-90 mt-1">Antes de guardar, todos los datos ser√°n cifrados en tu dispositivo usando tu llave maestra. El servidor solo recibir√° c√≥digo ilegible.</p>\n            </div>\n          </div>\n\n          <div class="flex justify-end items-center gap-3 pt-6 border-t border-slate-200">\n            <button id="cancelDocBtn" class="px-5 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 font-medium transition shadow-sm">\n                Cancelar\n            </button>\n            <button id="saveDocBtn" class="px-6 py-2.5 bg-primary hover:bg-primary-hover text-white rounded-xl shadow-lg shadow-blue-500/20 font-bold transition-all transform active:scale-95 flex items-center">\n              <i class="fas fa-save mr-2"></i> <span>${n}</span>\n            </button>\n          </div>\n        </div>\n      </div>\n      \n      <style>\n        /* Hacemos que los campos de texto largo y tablas ocupen 2 columnas */\n        #dynamicFormContainer > div:has(textarea),\n        #dynamicFormContainer > div:has(.table-input-container) {\n            grid-column: span 1;\n        }\n        @media (min-width: 768px) {\n            #dynamicFormContainer > div:has(textarea),\n            #dynamicFormContainer > div:has(.table-input-container) {\n                grid-column: span 2;\n            }\n        }\n        /* Estilos base para inputs generados */\n        #dynamicFormContainer label { display: block; font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 0.5rem; }\n        #dynamicFormContainer input[type="text"],\n        #dynamicFormContainer input[type="number"],\n        #dynamicFormContainer input[type="date"],\n        #dynamicFormContainer input[type="password"],\n        #dynamicFormContainer input[type="url"],\n        #dynamicFormContainer select,\n        #dynamicFormContainer textarea {\n            width: 100%;\n            padding: 0.75rem 1rem;\n            background-color: #ffffff;\n            border: 1px solid #cbd5e1;\n            border-radius: 0.75rem;\n            font-size: 0.875rem;\n            transition: all 0.2s;\n            outline: none;\n        }\n        #dynamicFormContainer input:focus,\n        #dynamicFormContainer select:focus,\n        #dynamicFormContainer textarea:focus {\n            border-color: #2563eb;\n            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);\n        }\n      </style>\n    `}setupEventListeners(){document.getElementById("closeEditorBtn")?.addEventListener("click",()=>this.onCancel()),document.getElementById("cancelDocBtn")?.addEventListener("click",()=>this.onCancel()),document.getElementById("saveDocBtn")?.addEventListener("click",()=>this.handleSave()),this.setupMathCalculations(),this.setupTableInteractivity()}setupTableInteractivity(){document.querySelectorAll(".table-input-container").forEach(e=>{e.className="table-input-container w-full overflow-hidden border border-slate-200 rounded-xl bg-white shadow-sm";const t=e.dataset.fieldId,n=e.querySelector(`#${t}`),s=e.querySelector(".table-body"),a=e.querySelector(".add-row-btn");a&&(a.className="add-row-btn w-full py-3 bg-slate-50 hover:bg-slate-100 text-primary font-medium text-sm transition-colors border-t border-slate-200 flex items-center justify-center gap-2",a.innerHTML='<i class="fas fa-plus-circle"></i> Agregar Fila');const r=e.querySelector("thead");r&&(r.className="bg-slate-50 text-xs uppercase font-semibold text-slate-500");e.querySelectorAll("th").forEach(e=>e.className="px-4 py-3 text-left tracking-wider");let i=[];try{i=JSON.parse(e.nextElementSibling.textContent)}catch(d){}const o=(e={})=>{const t=document.createElement("tr");t.className="group border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors";let n="";i.forEach(t=>{n+=`<td class="p-0 border-r border-slate-100 last:border-0 relative">${((e,t)=>{const n=null!=t?t:"",s="w-full text-sm border-0 bg-transparent focus:ring-0 p-2 placeholder-slate-300";if("boolean"===e.type)return`<div class="flex justify-center"><input type="checkbox" class="h-4 w-4 text-primary border-slate-300 rounded focus:ring-primary cursor-pointer cell-input" data-col-id="${e.id}" ${n?"checked":""}></div>`;if("select"===e.type){const t=(e.options||[]).map(e=>`<option value="${e}" ${n===e?"selected":""}>${e}</option>`).join("");return`<select class="${s} cursor-pointer" data-col-id="${e.id}"><option value="">Seleccionar...</option>${t}</select>`}const a=["number","currency","percentage"].includes(e.type),r=`${s} ${a?"font-mono text-right math-input":""}`,i=a?"0.00":"date"===e.type?"":"Escribir...";return`<input type="${"date"===e.type?"date":"secret"===e.type?"password":"text"}" class="${r} cell-input" data-col-id="${e.id}" value="${n}" placeholder="${i}">`})(t,e[t.id])}</td>`}),n+='<td class="w-10 text-center p-0">\n                <button type="button" class="remove-row-btn w-full h-full text-slate-300 hover:text-red-500 hover:bg-red-50 transition-all" title="Eliminar fila">\n                    <i class="fas fa-times"></i>\n                </button>\n            </td>',t.innerHTML=n,s.appendChild(t),t.querySelectorAll(".math-input").forEach(e=>{e.addEventListener("blur",()=>this.evaluateMathInput(e)),e.addEventListener("keydown",t=>("Enter"===t.key||"="===t.key)&&this.evaluateMathInput(e))})};JSON.parse(n.value||"[]").forEach(e=>o(e)),a.addEventListener("click",()=>o({})),s.addEventListener("click",e=>{e.target.closest(".remove-row-btn")&&(e.target.closest("tr").remove(),l())}),s.addEventListener("input",()=>l()),s.addEventListener("change",()=>l());const l=()=>{const e=[];s.querySelectorAll("tr").forEach(t=>{const n={};t.querySelectorAll(".cell-input").forEach(e=>{const t=e.dataset.colId;let s="checkbox"===e.type?e.checked:e.value;const a=i.find(e=>e.id===t);a&&["number","currency","percentage"].includes(a.type)&&(s=""===s||isNaN(s)?null:Number(s)),n[t]=s}),e.push(n)}),n.value=JSON.stringify(e)}})}setupMathCalculations(){this.template.fields.filter(e=>["number","currency","percentage"].includes(e.type)).forEach(e=>{const t=document.getElementById(e.id);t&&(t.placeholder||(t.placeholder="0.00 (admite f√≥rmulas)"),t.classList.add("font-mono","text-right"),t.addEventListener("keydown",e=>("Enter"===e.key||"="===e.key)&&(e.preventDefault(),this.evaluateMathInput(t))),t.addEventListener("blur",()=>this.evaluateMathInput(t)))})}evaluateMathInput(e){const t=e.value.trim();if(t&&/^[\d\s\.\+\-\*\/\(\)]+$/.test(t)&&/[\+\-\*\/]/.test(t))try{const n=new Function('"use strict";return ('+t+")")();isFinite(n)&&(e.value=Math.round(100*n)/100,e.dispatchEvent(new Event("input",{bubbles:!0})),e.classList.add("bg-emerald-50","text-emerald-700","font-bold","ring-2","ring-emerald-500"),setTimeout(()=>e.classList.remove("bg-emerald-50","text-emerald-700","font-bold","ring-2","ring-emerald-500"),600))}catch(n){}}async handleSave(){if(this.isSubmitting)return;const e=document.querySelector('form[id^="templateForm_"]');if(!e||e.checkValidity()){this.updateEditorState(!0,this.isEditing?"Guardando cambios...":"Encriptando y guardando...");try{document.querySelectorAll(".math-input").forEach(e=>this.evaluateMathInput(e)),await new Promise(e=>setTimeout(e,100));const e=this.collectFormData(),t=this.isEditing?await X.updateDocument(this.documentId,this.template,e):await X.createDocument(this.template,e);this.onSaveSuccess&&this.onSaveSuccess(t)}catch(t){alert("Error: "+t.message),this.updateEditorState(!1)}}else e.reportValidity()}collectFormData(){const e={};return this.template.fields.forEach(t=>{if("url"===t.type){const n=document.getElementById(`${t.id}_url`),s=document.getElementById(`${t.id}_text`);return void(n&&(e[t.id]={url:n.value,text:s.value||""}))}const n=document.getElementById(t.id);if(n)if("boolean"===t.type)e[t.id]=n.checked;else if(["number","currency","percentage"].includes(t.type)){let a=n.value;try{/[\+\-\*\/]/.test(a)&&(a=new Function('"use strict";return ('+a+")")())}catch(s){}e[t.id]=""===a||isNaN(a)?null:Number(a)}else if("table"===t.type)try{e[t.id]=JSON.parse(n.value||"[]")}catch(s){e[t.id]=[]}else e[t.id]=n.value}),e}updateEditorState(e,t=null){this.isSubmitting=e;const n=document.getElementById("saveDocBtn");if(!n)return;e?(n.disabled=!0,n.innerHTML=`<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${t}`,n.classList.add("opacity-80","cursor-wait")):(n.disabled=!1,n.innerHTML='<i class="fas fa-save mr-2"></i> '+(this.isEditing?"Guardar Cambios":"Crear Documento"),n.classList.remove("opacity-80","cursor-wait"));const s=document.getElementById("dynamicFormContainer");if(s){s.querySelectorAll("input, textarea, select, button").forEach(t=>t.disabled=e),s.style.opacity=e?"0.7":"1"}}renderError(e){document.getElementById("editorContainer").innerHTML=`\n        <div class="p-8 text-center">\n            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">\n                <i class="fas fa-times text-2xl"></i>\n            </div>\n            <h3 class="text-xl font-bold text-slate-800 mb-2">Error de Carga</h3>\n            <p class="text-slate-500 mb-6">${e}</p>\n            <button id="cancelDocBtn" class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition">Volver</button>\n        </div>\n    `,document.getElementById("cancelDocBtn")?.addEventListener("click",()=>this.onCancel())}}class Z{constructor(e,t){this.onDocumentSelect=e,this.onNewDocument=t,this.documents=[],this.templatesMap={},this.isLoading=!1,this.currentFilter="all"}async loadDocuments(){this.isLoading=!0,this.render();try{const[e,t]=await Promise.all([X.getAllDocuments(),N.getUserTemplates()]);this.documents=e,this.templatesMap=t.reduce((e,t)=>(e[t.id]=t,e),{})}catch(e){this.error="No se pudieron recuperar los datos seguros."}finally{this.isLoading=!1,this.render()}}getActiveFilters(){const e=this.documents.reduce((e,t)=>{const n=t.templateId;return e[n]=(e[n]||0)+1,e},{});return Object.keys(e).map(t=>{const n=this.templatesMap[t]||{name:"Otros",icon:"üì¶",color:"#94a3b8"};return{id:t,name:n.name,icon:n.icon,color:n.color,count:e[t]}})}render(){const e=document.getElementById("vaultListContainer");if(!e)return;if(this.isLoading)return void(e.innerHTML=`\n        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-4">\n          ${Array(6).fill(0).map(()=>'\n            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 animate-pulse">\n              <div class="flex items-center space-x-4 mb-4">\n                <div class="h-12 w-12 bg-slate-200 rounded-lg"></div>\n                <div class="flex-1 space-y-2">\n                  <div class="h-4 bg-slate-200 rounded w-3/4"></div>\n                  <div class="h-3 bg-slate-200 rounded w-1/2"></div>\n                </div>\n              </div>\n              <div class="h-2 bg-slate-200 rounded w-full mt-4"></div>\n            </div>\n          ').join("")}\n        </div>\n      `);if(this.error)return e.innerHTML=`\n        <div class="flex flex-col items-center justify-center py-12 text-center px-4">\n          <div class="bg-red-50 p-4 rounded-full mb-4">\n            <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>\n          </div>\n          <h3 class="text-lg font-bold text-slate-800">Hubo un problema</h3>\n          <p class="text-slate-500 mb-6">${this.error}</p>\n          <button id="retryLoadBtn" class="px-6 py-2 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 font-medium text-slate-700 transition">\n            Intentar nuevamente\n          </button>\n        </div>\n      `,void document.getElementById("retryLoadBtn")?.addEventListener("click",()=>this.loadDocuments());if(0===this.documents.length)return e.innerHTML=this.renderEmptyState(),void document.getElementById("createFirstDocBtn")?.addEventListener("click",()=>this.onNewDocument());const t="all"===this.currentFilter?this.documents:this.documents.filter(e=>e.templateId===this.currentFilter);e.innerHTML=`\n      <div class="p-1">\n        <div class="flex space-x-3 mb-8 overflow-x-auto pb-4 no-scrollbar items-center">\n            ${this.renderFilters()}\n        </div>\n\n        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">\n          ${t.map(e=>this.renderDocumentCard(e)).join("")}\n        </div>\n        \n        ${0===t.length?'\n          <div class="flex flex-col items-center justify-center py-16 bg-white rounded-2xl border border-dashed border-slate-300">\n             <i class="fas fa-filter text-4xl text-slate-300 mb-3"></i>\n             <p class="text-slate-500 font-medium">No hay documentos en esta categor√≠a.</p>\n             <button class="mt-4 text-primary hover:text-primary-hover font-medium text-sm" data-filter="all" onclick="document.querySelector(\'[data-filter=all]\').click()">\n               Ver todos los documentos\n             </button>\n          </div>\n        ':""}\n      </div>\n    `,this.setupListeners(e)}renderFilters(){const e=this.getActiveFilters(),t=(e,t,n,s,a=null)=>{const r=this.currentFilter===e;let i="filter-btn flex-shrink-0 flex items-center px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border cursor-pointer select-none ";if(r){if(i+="bg-slate-800 text-white border-slate-800 shadow-lg shadow-slate-200 scale-105",a)return`<button class="${i}" style="background-color: ${a}; border-color: ${a};" data-filter="${e}"><span class="mr-2">${n}</span>${t}<span class="ml-2 bg-white/20 px-2 py-0.5 rounded-full text-xs">${s}</span></button>`}else i+="bg-white text-slate-600 border-slate-200 hover:border-primary/30 hover:bg-slate-50 hover:shadow-sm";return`\n        <button class="${i}" data-filter="${e}">\n          <span class="mr-2">${n}</span>\n          ${t}\n          <span class="ml-2 ${r?"bg-white/20":"bg-slate-100 text-slate-500"} px-2 py-0.5 rounded-full text-xs transition-colors">\n            ${s}\n          </span>\n        </button>\n      `};let n=t("all","Todos","üìÇ",this.documents.length);return n+=e.map(e=>t(e.id,e.name,e.icon,e.count,e.color)).join(""),n}renderEmptyState(){return'\n      <div class="text-center py-16 bg-white rounded-2xl shadow-sm border border-slate-200 mx-4">\n        <div class="relative w-24 h-24 mx-auto mb-6">\n           <div class="absolute inset-0 bg-blue-100 rounded-full animate-ping opacity-25"></div>\n           <div class="relative bg-blue-50 w-full h-full rounded-full flex items-center justify-center">\n             <i class="fas fa-shield-alt text-primary text-4xl"></i>\n           </div>\n        </div>\n        <h3 class="text-xl font-bold text-slate-800 mb-2">Tu B√≥veda est√° lista</h3>\n        <p class="text-slate-500 max-w-md mx-auto mb-8">\n          Tus datos personales merecen la mejor seguridad. Comienza agregando tu primer registro cifrado de extremo a extremo.\n        </p>\n        <button id="createFirstDocBtn" class="inline-flex items-center px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-xl shadow-lg shadow-blue-500/30 font-bold transition-all hover:-translate-y-1">\n          <i class="fas fa-plus mr-2"></i>\n          Crear Primer Documento\n        </button>\n      </div>\n    '}renderDocumentCard(e){const t=new Date(e.metadata.updatedAt).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"}),n=this.templatesMap[e.templateId]||{},s=n.icon||e.metadata.icon||"üìÑ",a=n.color||"#64748b";return`\n      <div class="vault-card group relative bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer overflow-hidden" data-id="${e.id}">\n        \n        <div class="absolute top-0 left-0 right-0 h-1.5" style="background-color: ${a}"></div>\n        \n        <div class="flex items-start justify-between mt-2">\n          <div class="flex items-center gap-4">\n            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-inner" \n                 style="background-color: ${a}15; color: ${a}">\n              ${s}\n            </div>\n            <div class="min-w-0">\n              <h4 class="text-base font-bold text-slate-800 truncate pr-2 group-hover:text-primary transition-colors">\n                ${e.metadata.title||"Sin T√≠tulo"}\n              </h4>\n              <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">\n                ${n.name||"Documento"}\n              </p>\n            </div>\n          </div>\n          \n          <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-primary group-hover:text-white transition-all">\n            <i class="fas fa-chevron-right text-xs"></i>\n          </div>\n        </div>\n\n        <div class="mt-6 pt-4 border-t border-slate-100 flex items-center justify-between text-xs">\n           <div class="flex items-center text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-md font-medium">\n             <i class="fas fa-lock mr-1.5 text-[10px]"></i> E2EE\n           </div>\n           <div class="flex items-center text-slate-400">\n             <i class="far fa-clock mr-1.5"></i> ${t}\n           </div>\n        </div>\n      </div>\n    `}setupListeners(e){e.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget;this.currentFilter=t.dataset.filter,this.render()})}),e.querySelectorAll(".vault-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.id;this.onDocumentSelect(t)})})}}class Q{constructor(e,t){this.docId=e,this.onBack=t,this.document=null,this.template=null,this.decryptedData=null,this.currencyConfig=(()=>{const e=navigator.language;if(O[e])return{locale:e,...O[e]};const t=e.split("-")[0];return O[t]?{locale:t,...O[t]}:{locale:"en-US",...O["en-US"]}})()}render(){return'<div id="documentViewerPlaceholder" class="animate-fade-in pb-12"></div>'}async load(){this.renderLoading();try{if(this.document=await X.getDocumentById(this.docId),this.template=await N.getTemplateById(this.document.templateId),!this.template)throw new Error("La plantilla original ya no existe.");if(!D.isReady())throw new Error("Cifrado no inicializado.");this.decryptedData=await D.decryptDocument({content:this.document.encryptedContent,metadata:this.document.encryptionMetadata}),this.renderContent()}catch(e){this.renderError(e.message)}}renderFieldValue(e,t,n=!1){if(null==t||"string"==typeof t&&""===t.trim())return'<span class="text-slate-300 italic text-xs select-none">Vac√≠o</span>';switch(e){case"boolean":return t?'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 border border-emerald-200"><i class="fas fa-check mr-1"></i> S√≠</span>':'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200">No</span>';case"date":try{const[e,n,s]=String(t).split("-").map(Number),a=new Date(e,n-1,s);return`<span class="font-medium text-slate-700"><i class="far fa-calendar-alt mr-1.5 text-slate-400"></i>${new Intl.DateTimeFormat(this.currencyConfig.locale,{dateStyle:"medium"}).format(a)}</span>`}catch(s){return t}case"currency":const e=Number(t);if(isNaN(e))return t;return`<span class="font-mono font-medium text-slate-700 tracking-tight">${new Intl.NumberFormat(this.currencyConfig.locale,{style:"currency",currency:this.currencyConfig.codigo}).format(e)}</span>`;case"percentage":return`<span class="font-mono text-slate-700">${t}%</span>`;case"secret":return n?'<span class="text-xs text-slate-400 font-mono">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>':`\n            <div class="relative group inline-flex items-center max-w-full">\n              <div class="secret-container relative overflow-hidden rounded-md border border-slate-200 bg-slate-50 px-3 py-1.5 transition-all duration-300 group-hover:border-primary/30 group-hover:shadow-sm">\n                 <span class="secret-mask filter blur-[4px] select-none transition-all duration-300 group-hover:blur-none font-mono text-sm text-slate-800" data-value="${t}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>\n                 <span class="secret-revealed hidden font-mono text-sm text-slate-800 select-all">${t}</span>\n              </div>\n              <button class="toggle-secret-btn ml-2 text-slate-400 hover:text-primary transition-colors p-1" title="Revelar permanentemente">\n                <i class="fas fa-eye"></i>\n              </button>\n              <button class="copy-btn ml-1 text-slate-400 hover:text-emerald-600 transition-colors p-1" data-value="${t}" title="Copiar">\n                <i class="far fa-copy"></i>\n              </button>\n            </div>`;case"url":let a=t,r=t;if("object"==typeof t&&null!==t&&(a=t.url,r=t.text||t.url),!a)return'<span class="text-slate-300 italic">Sin enlace</span>';return`<a href="${a}" target="_blank" class="inline-flex items-center text-primary hover:text-primary-hover hover:underline transition-colors group">\n                <i class="fas fa-link mr-1.5 text-xs opacity-50 group-hover:opacity-100"></i> ${n&&r.length>20?r.substring(0,17)+"...":r}\n            </a>`;case"text":return n?t.length>30?`<span title="${t}">${t.substring(0,30)}...</span>`:t:`<div class="prose prose-sm max-w-none text-slate-700 bg-slate-50/50 p-4 rounded-xl border border-slate-100 leading-relaxed">${t}</div>`;default:return String(t)}}renderContent(){const e=document.getElementById("documentViewerPlaceholder");if(!e)return;const t=new Date(this.document.metadata.updatedAt).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}),n=this.template.fields.map((e,t)=>{if(0===t)return"";const n=this.decryptedData[e.id];if("table"===e.type)return this.renderTableField(e,n);const s=this.renderFieldValue(e.type,n);return`\n        <div class="group py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6 hover:bg-slate-50/80 transition-colors rounded-lg">\n          <dt class="text-sm font-medium text-slate-500 flex items-center mb-1 sm:mb-0">\n             ${e.label}\n          </dt>\n          <dd class="mt-1 text-sm text-slate-900 sm:mt-0 sm:col-span-2 break-words leading-6">\n             ${s}\n          </dd>\n        </div>\n      `}).join("");e.innerHTML=`\n      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 px-2 no-print">\n         \n         <button id="backBtn" class="flex items-center text-slate-500 hover:text-primary transition-colors font-medium">\n            <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center mr-2 shadow-sm">\n                <i class="fas fa-arrow-left text-sm"></i>\n            </div>\n            <span>Volver</span>\n         </button>\n         \n         <div class="flex items-center gap-2 self-end sm:self-auto bg-white p-1 rounded-xl shadow-sm border border-slate-200">\n            <button id="whatsappDocBtn" class="p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Copiar para WhatsApp">\n               <i class="fab fa-whatsapp text-lg"></i>\n            </button>\n            <button id="pdfDocBtn" class="p-2 text-slate-400 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors" title="Imprimir / PDF">\n               <i class="fas fa-print text-lg"></i>\n            </button>\n\n            <div class="h-6 w-px bg-slate-200 mx-1"></div>\n\n            <button id="deleteDocBtn" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">\n               <i class="far fa-trash-alt text-lg"></i>\n            </button>\n            <button id="editDocBtn" class="flex items-center px-3 py-1.5 bg-slate-800 hover:bg-slate-900 text-white rounded-lg shadow-sm transition-all text-sm font-medium ml-1">\n               <i class="fas fa-pen mr-2 text-xs"></i> <span>Editar</span>\n            </button>\n         </div>\n      </div>\n\n      <div id="documentCard" class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden relative print:shadow-none print:border-none">\n        <div class="h-1.5 w-full bg-gradient-to-r from-primary to-secondary"></div>\n        \n        <div class="px-6 py-8 sm:px-8 border-b border-slate-100 bg-white">\n          <div class="flex items-start justify-between">\n            <div class="flex gap-5">\n               <div class="flex-shrink-0 w-16 h-16 rounded-2xl flex items-center justify-center text-3xl shadow-sm border border-slate-50" \n                    style="background-color: ${this.template.color}10; color: ${this.template.color}">\n                  ${this.template.icon}\n               </div>\n               <div>\n                  <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 tracking-tight">${this.document.metadata.title}</h1>\n                  <div class="flex items-center mt-2 text-sm text-slate-500 space-x-3">\n                     <span class="bg-slate-100 px-2 py-0.5 rounded text-xs font-medium text-slate-600 uppercase tracking-wide">${this.template.name}</span>\n                     <span>&bull;</span>\n                     <span><i class="far fa-clock mr-1"></i> ${t}</span>\n                  </div>\n               </div>\n            </div>\n          </div>\n        </div>\n\n        <div class="px-4 py-6 sm:px-8">\n           <dl class="space-y-1">\n              ${n}\n           </dl>\n        </div>\n\n        <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex items-center justify-center sm:justify-between">\n           <div class="flex items-center text-emerald-600 text-xs font-medium">\n              <i class="fas fa-lock mr-2"></i> Protegido con cifrado de extremo a extremo\n           </div>\n           <div class="hidden sm:block text-slate-400 text-xs font-mono">\n              ID: ${this.document.id.substring(0,8)}...\n           </div>\n        </div>\n      </div>\n\n      <div id="rowDetailModal" class="fixed inset-0 z-50 hidden">\n         <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" id="modalBackdrop"></div>\n         <div class="flex items-center justify-center min-h-screen p-4">\n            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-100 relative overflow-hidden flex flex-col max-h-[85vh]">\n                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">\n                    <h3 class="font-bold text-slate-800">Detalles del Registro</h3>\n                    <button class="close-modal text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded-full p-1"><i class="fas fa-times"></i></button>\n                </div>\n                <div class="p-6 overflow-y-auto" id="rowDetailContent"></div>\n            </div>\n         </div>\n      </div>\n    `,this.setupContentListeners()}renderTableField(e,t){const n=Array.isArray(t)?t:[],s=e.columns||[];if(0===n.length)return`\n        <div class="py-5 px-6 rounded-xl border border-dashed border-slate-200 bg-slate-50/30 text-center my-4">\n            <p class="text-sm font-medium text-slate-500 mb-1">${e.label}</p>\n            <p class="text-xs text-slate-400">Sin registros almacenados</p>\n        </div>`;const a=s.length>3,r=a?s.slice(0,3):s,i=r.map(e=>`<th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">${e.label||e.name}</th>`).join(""),o=n.map((t,n)=>`<tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0 even:bg-slate-50/50">${r.map(e=>`<td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">${this.renderFieldValue(e.type,t[e.id],!0)}</td>`).join("")}${a?`<td class="px-4 py-3 text-right"><button class="view-row-btn text-primary hover:bg-blue-50 p-1.5 rounded transition" data-field-id="${e.id}" data-row-index="${n}"><i class="fas fa-eye"></i></button></td>`:""}</tr>`).join("");return`\n      <div class="py-6 sm:col-span-3">\n         <div class="flex items-center justify-between mb-3">\n             <dt class="text-sm font-medium text-slate-500">${e.label}</dt>\n             <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600">${n.length} registros</span>\n         </div>\n         <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">\n             <div class="overflow-x-auto">\n                 <table class="min-w-full divide-y divide-slate-100">\n                    <thead class="bg-slate-50"><tr>${i}${a?'<th class="w-10"></th>':""}</tr></thead>\n                    <tbody class="divide-y divide-slate-100 bg-white">${o}</tbody>\n                 </table>\n             </div>\n             ${a?'<div class="bg-slate-50/50 px-4 py-2 text-[10px] text-slate-400 text-center border-t border-slate-100 uppercase tracking-wide">Mostrando vista previa ‚Ä¢ Click en ojo para detalles</div>':""}\n         </div>\n      </div>\n    `}setupContentListeners(){["closeViewerBtn","backBtn"].forEach(e=>document.getElementById(e)?.addEventListener("click",()=>this.onBack())),document.getElementById("deleteDocBtn")?.addEventListener("click",()=>this.handleDelete()),document.getElementById("editDocBtn")?.addEventListener("click",()=>this.handleEdit()),document.getElementById("pdfDocBtn")?.addEventListener("click",()=>window.print()),document.getElementById("whatsappDocBtn")?.addEventListener("click",()=>this.handleCopyToWhatsApp());document.getElementById("documentViewerPlaceholder").addEventListener("click",e=>{const t=e.target.closest(".toggle-secret-btn");if(t){const e=t.parentElement,n=e.querySelector(".secret-mask"),s=e.querySelector(".secret-revealed"),a=t.querySelector("i");s.classList.contains("hidden")?(n.classList.add("hidden"),s.classList.remove("hidden"),a.className="fas fa-eye-slash",t.classList.add("text-primary")):(n.classList.remove("hidden"),s.classList.add("hidden"),a.className="fas fa-eye",t.classList.remove("text-primary"))}const n=e.target.closest(".copy-btn");if(n){navigator.clipboard.writeText(n.dataset.value);const e=n.querySelector("i");e.className="fas fa-check text-emerald-500",setTimeout(()=>e.className="far fa-copy",1500)}const s=e.target.closest(".view-row-btn");s&&this.openRowModal(s.dataset.fieldId,parseInt(s.dataset.rowIndex))});const e=document.getElementById("rowDetailModal"),t=()=>e.classList.add("hidden");e?.querySelectorAll(".close-modal").forEach(e=>e.addEventListener("click",t)),document.getElementById("modalBackdrop")?.addEventListener("click",t)}openRowModal(e,t){const n=this.template.fields.find(t=>t.id===e);if(!n)return;const s=this.decryptedData[e][t],a=n.columns.map(e=>`\n        <div class="py-3 border-b border-slate-100 last:border-0">\n            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${e.label||e.name}</p>\n            <div class="text-slate-800 text-sm break-words">${this.renderFieldValue(e.type,s[e.id])}</div>\n        </div>\n    `).join("");document.getElementById("rowDetailContent").innerHTML=a,document.getElementById("rowDetailModal").classList.remove("hidden")}renderLoading(){document.getElementById("documentViewerPlaceholder").innerHTML='<div class="flex flex-col items-center justify-center py-24"><div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-primary mb-4"></div><p class="text-slate-400 animate-pulse">Desencriptando documento...</p></div>'}renderError(e){document.getElementById("documentViewerPlaceholder").innerHTML=`<div class="max-w-2xl mx-auto mt-10 p-6 bg-red-50 border border-red-100 rounded-xl text-center"><i class="fas fa-exclamation-circle text-4xl text-red-400 mb-4"></i><h3 class="text-red-800 font-bold text-lg">Error de Carga</h3><p class="text-red-600 mt-2">${e}</p><button id="backBtn" class="mt-6 px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition">Volver</button></div>`,document.getElementById("backBtn")?.addEventListener("click",()=>this.onBack())}async handleDelete(){if(confirm("¬øEst√°s seguro de eliminar este documento permanentemente?"))try{await X.deleteDocument(this.docId),this.onBack()}catch(e){alert(e.message)}}handleEdit(){this.onBack({documentId:this.docId,template:this.template,formData:this.decryptedData,metadata:this.document.metadata})}async handleCopyToWhatsApp(){try{let e=`*${this.document.metadata.title}*\n_${this.template.name}_\n\n`;this.template.fields.forEach((t,n)=>{if(0===n)return;const s=this.decryptedData[t.id];if("table"===t.type){const n=Array.isArray(s)?s:[];e+=`*${t.label}:* ${0===n.length?"_Sin datos_":""}\n`,n.forEach((n,s)=>{e+=`  ${s+1}. `,t.columns?.forEach(t=>e+=`${t.label}: ${this.getFormattedValueForText(t.type,n[t.id])} | `),e+="\n"})}else e+=`*${t.label}:* ${this.getFormattedValueForText(t.type,s)}\n`}),e+="\n_Enviado desde Mi Gesti√≥n_",await navigator.clipboard.writeText(e);const t=document.getElementById("whatsappDocBtn");t.innerHTML='<i class="fas fa-check text-green-500 text-lg"></i>',setTimeout(()=>t.innerHTML='<i class="fab fa-whatsapp text-lg"></i>',2e3)}catch(e){}}getFormattedValueForText(e,t){return null==t||""===t?"_N/A_":"boolean"===e?t?"S√≠":"No":"currency"===e?new Intl.NumberFormat(this.currencyConfig.locale).format(Number(t)):String(t)}}const ee={async createBackup(){try{const e=await N.getUserTemplates(),t=await X.getAllDocuments(),n={metadata:{version:"1.0",appName:"Mi Gesti√≥n",exportedAt:(new Date).toISOString(),totalDocuments:t.length,totalTemplates:e.length},data:{templates:e,vault:t}},s=JSON.stringify(n,null,2),a=new Blob([s],{type:"application/json"}),r=URL.createObjectURL(a),i=document.createElement("a");i.href=r;const o=(new Date).toISOString().slice(0,10);return i.download=`respaldo_migestion_${o}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),{success:!0,count:t.length}}catch(e){throw e}},restoreBackup:async e=>new Promise((t,n)=>{const s=new FileReader;s.onload=async e=>{try{const n=JSON.parse(e.target.result);if(!n.data||!n.data.templates||!n.data.vault)throw new Error("El archivo no es v√°lido o est√° da√±ado.");const a=B.getCurrentUser();if(!a)throw new Error("Debes iniciar sesi√≥n para restaurar.");if(n.data.vault.length>0)try{const e=n.data.vault[0];if(!D.isReady())throw new Error("Cifrado no inicializado");await D.decryptDocument({content:e.encryptedContent,metadata:e.encryptionMetadata})}catch(s){throw new Error("‚õî CLAVE INCORRECTA\n\nEste archivo de respaldo fue creado con una contrase√±a diferente a la actual.\nNo se puede restaurar porque los datos ser√≠an ilegibles.")}const r=[],i=E.doc(`artifacts/mi-gestion-v1/users/${a.uid}/metadata/templates`),o=await N.getUserTemplates(),l=new Map(o.map(e=>[e.id,e]));n.data.templates.forEach(e=>{e.userId=a.uid,l.set(e.id,e)}),r.push(E.setDoc(i,{templates:Array.from(l.values()),lastUpdated:(new Date).toISOString(),count:l.size},{merge:!0})),n.data.vault.forEach(e=>{e.userId=a.uid;const t=E.doc(`artifacts/mi-gestion-v1/users/${a.uid}/vault/${e.id}`);r.push(E.setDoc(t,e))}),await Promise.all(r),await N.loadUserTemplates(),t({success:!0,docsRestored:n.data.vault.length,templatesRestored:n.data.templates.length})}catch(a){n(a)}},s.onerror=()=>n(new Error("Error al leer el archivo")),s.readAsText(e)})};class te{render(){return'\n      <div class="max-w-4xl mx-auto space-y-8 animate-fade-in pb-12">\n        \n        <div class="flex items-center space-x-4 mb-8">\n          <div class="p-3 bg-white rounded-xl shadow-sm border border-slate-100">\n             <i class="fas fa-sliders-h text-2xl text-slate-700"></i>\n          </div>\n          <div>\n            <h2 class="text-2xl font-bold text-slate-800">Panel de Control</h2>\n            <p class="text-slate-500">Seguridad, respaldos y configuraci√≥n de cuenta.</p>\n          </div>\n        </div>\n\n        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">\n          <div class="p-6 sm:p-8">\n            <div class="flex items-start justify-between mb-4">\n                <div>\n                    <h3 class="text-lg font-bold text-slate-800 flex items-center">\n                        <i class="fas fa-cloud-download-alt mr-2 text-primary"></i>\n                        Exportar Datos Seguros\n                    </h3>\n                    <p class="text-slate-500 text-sm mt-1">Descarga un archivo cifrado con toda tu informaci√≥n.</p>\n                </div>\n            </div>\n            \n            <div class="bg-blue-50/50 border border-blue-100 p-4 rounded-xl mb-6 flex gap-3">\n              <i class="fas fa-info-circle text-blue-500 mt-1 flex-shrink-0"></i>\n              <div class="text-sm text-blue-800">\n                <p class="font-bold mb-1">Nota de Seguridad:</p>\n                <p>Este archivo <strong>solo funciona con tu contrase√±a actual</strong>. Si cambias tu contrase√±a, deber√°s generar un nuevo respaldo inmediatamente.</p>\n              </div>\n            </div>\n\n            <button id="btnExport" class="w-full sm:w-auto px-6 py-3 bg-white border border-slate-200 text-slate-700 hover:text-primary hover:border-primary/50 font-bold rounded-xl shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2">\n              <i class="fas fa-file-export"></i>\n              <span>Generar Respaldo (.json)</span>\n            </button>\n          </div>\n        </div>\n\n        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">\n          <div class="p-6 sm:p-8">\n            <h3 class="text-lg font-bold text-slate-800 flex items-center mb-2">\n                <i class="fas fa-history mr-2 text-indigo-500"></i>\n                Restaurar Copia de Seguridad\n            </h3>\n            <p class="text-slate-500 text-sm mb-6">Importa datos desde un archivo generado previamente. Se fusionar√°n con tus datos actuales.</p>\n\n            <div class="bg-slate-50 rounded-xl p-6 border border-dashed border-slate-300">\n                <div class="flex flex-col sm:flex-row items-center gap-4">\n                  <input type="file" id="fileImport" accept=".json"\n                    class="block w-full text-sm text-slate-500\n                      file:mr-4 file:py-2.5 file:px-4\n                      file:rounded-xl file:border-0\n                      file:text-sm file:font-semibold\n                      file:bg-indigo-50 file:text-indigo-700\n                      hover:file:bg-indigo-100\n                      cursor-pointer\n                    "\n                  />\n                  <button id="btnRestore" disabled class="w-full sm:w-auto px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold rounded-xl shadow-lg shadow-indigo-500/20 transition-all flex items-center justify-center gap-2 whitespace-nowrap">\n                    <i class="fas fa-upload"></i>\n                    <span>Restaurar</span>\n                  </button>\n                </div>\n                <div id="restoreStatus" class="mt-4 hidden"></div>\n            </div>\n          </div>\n        </div>\n\n        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">\n          <div class="p-6 sm:p-8">\n            <h3 class="text-lg font-bold text-slate-800 flex items-center mb-2">\n                <i class="fas fa-shield-alt mr-2 text-amber-500"></i>\n                Cambio de Contrase√±a Maestra\n            </h3>\n            <p class="text-slate-500 text-sm mb-6">Actualiza la llave que cifra todos tus documentos.</p>\n\n            <div class="bg-amber-50 border border-amber-100 p-4 rounded-xl mb-6 flex gap-3">\n              <i class="fas fa-exclamation-triangle text-amber-500 mt-1 flex-shrink-0"></i>\n              <div class="text-sm text-amber-800">\n                 <p class="font-bold mb-1">¬°Advertencia Cr√≠tica!</p>\n                 <p>Al cambiar la contrase√±a, <strong>los respaldos anteriores quedar√°n inservibles permanentemente</strong>. Aseg√∫rate de recordar la nueva clave, ya que no podemos recuperarla por ti.</p>\n              </div>\n            </div>\n\n            <form id="changePasswordForm" class="space-y-5 max-w-md">\n              <div>\n                <label class="block text-sm font-bold text-slate-700 mb-1">Contrase√±a Actual</label>\n                <input type="password" id="currentPassword" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition" required>\n              </div>\n              <div class="pt-2">\n                <label class="block text-sm font-bold text-slate-700 mb-1">Nueva Contrase√±a</label>\n                <input type="password" id="newPassword" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition" placeholder="M√≠nimo 8 caracteres" required minlength="8">\n              </div>\n              <div>\n                <label class="block text-sm font-bold text-slate-700 mb-1">Confirmar Nueva</label>\n                <input type="password" id="confirmNewPassword" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition" required>\n              </div>\n              \n              <button type="submit" id="btnChangePass" class="w-full py-3 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-xl shadow-lg shadow-amber-500/20 transition-all transform active:scale-95 mt-2">\n                Actualizar Contrase√±a\n              </button>\n            </form>\n          </div>\n        </div>\n\n      </div>\n    '}setupEventListeners(){document.getElementById("btnExport")?.addEventListener("click",async()=>{const e=document.getElementById("btnExport"),t=e.innerHTML;try{e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Procesando...',e.disabled=!0;const t=await ee.createBackup();alert(`‚úÖ Respaldo creado (${t.count} docs).\nRecuerda: Solo v√°lido con tu contrase√±a actual.`)}catch(n){alert("Error: "+n.message)}finally{e.innerHTML=t,e.disabled=!1}});const e=document.getElementById("fileImport"),t=document.getElementById("btnRestore");e?.addEventListener("change",()=>{t.disabled=0===e.files.length}),t?.addEventListener("click",async()=>{if(0===e.files.length)return;const n=document.getElementById("restoreStatus");n.classList.remove("hidden"),n.innerHTML='<p class="text-indigo-600 font-medium animate-pulse"><i class="fas fa-circle-notch fa-spin mr-2"></i> Restaurando datos...</p>',t.disabled=!0;try{const t=await ee.restoreBackup(e.files[0]);n.innerHTML=`<div class="bg-emerald-50 text-emerald-700 p-3 rounded-xl border border-emerald-100 flex items-center"><i class="fas fa-check-circle mr-2 text-xl"></i><div><p class="font-bold">¬°√âxito!</p><p class="text-sm">Restaurados ${t.docsRestored} documentos.</p></div></div>`,e.value=""}catch(s){n.innerHTML=`<div class="bg-red-50 text-red-700 p-3 rounded-xl border border-red-100"><p class="font-bold"><i class="fas fa-times-circle mr-1"></i> Fall√≥ la restauraci√≥n</p><p class="text-xs mt-1">${s.message}</p></div>`}finally{e.files.length>0&&(t.disabled=!1)}});const n=document.getElementById("changePasswordForm");n?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("currentPassword").value,s=document.getElementById("newPassword").value;if(s!==document.getElementById("confirmNewPassword").value)return alert("Las contrase√±as no coinciden");if(!confirm("‚ö†Ô∏è ¬øSeguro que quieres cambiar la contrase√±a?\n\nTus respaldos viejos dejar√°n de funcionar."))return;const a=document.getElementById("btnChangePass"),r=a.innerHTML;a.innerHTML="Procesando...",a.disabled=!0;try{const e=await B.changePassword(s,t);e.success?(alert("‚úÖ Contrase√±a cambiada. Crea un nuevo respaldo ahora."),n.reset()):alert("Error: "+e.error)}catch(i){alert("Error: "+i.message)}finally{a.innerHTML=r,a.disabled=!1}})}}async function ne(e,t){if(e){try{await N.initialize(e.uid)}catch(n){}se(e,t),await async function(e){setTimeout(async()=>{if(!D.isReady()){new M(async e=>{try{return await B.initializeEncryption(e),!0}catch(n){return!1}},e.email).show()}},500)}(e)}else!function(e){const t=new F(e=>{});e.innerHTML='\n    <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-slate-50 to-slate-200">\n      <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden transform transition-all">\n        <div class="bg-gradient-to-r from-primary to-secondary p-8 text-center">\n          <div class="inline-flex items-center justify-center w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full mb-4 shadow-inner border border-white/30">\n            <i class="fas fa-shield-alt text-3xl text-white"></i>\n          </div>\n          <h1 class="text-3xl font-bold text-white tracking-tight">Mi Gesti√≥n</h1>\n          <p class="text-blue-100 text-sm mt-2 font-medium">B√≥veda Digital Segura</p>\n        </div>\n        \n        <div id="authContainer" class="p-8"></div>\n        \n        <div class="px-8 pb-6 text-center">\n          <p class="text-xs text-slate-400 flex items-center justify-center gap-2">\n            <i class="fas fa-lock text-green-500"></i>\n            Encriptado de Extremo a Extremo (E2EE)\n          </p>\n        </div>\n      </div>\n    </div>\n  ';const n=document.getElementById("authContainer");n&&t.updateView(n)}(t)}async function se(e,t){const n=await B.getUserRole(),s="admin"===n?'<span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">\n         <i class="fas fa-shield-virus"></i> Admin\n       </span>':'<span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary border border-blue-200">\n         <i class="fas fa-user"></i> Usuario\n       </span>',a="admin"===n?'<a href="#" id="navAdmin" class="text-slate-600 hover:text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg text-sm font-medium transition-colors">\n         Admin Panel\n       </a>':"";t.innerHTML=`\n    <div class="min-h-screen bg-slate-50 flex flex-col">\n      <nav class="sticky top-0 z-40 w-full bg-white/80 backdrop-blur-md border-b border-slate-200 shadow-sm">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16">\n            \n            <div class="flex items-center gap-8">\n              <div class="flex items-center gap-2">\n                <div class="bg-gradient-to-br from-primary to-secondary text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">\n                  <i class="fas fa-shield-alt text-sm"></i>\n                </div>\n                <span class="font-bold text-slate-800 text-lg tracking-tight">Mi Gesti√≥n</span>\n              </div>\n              \n              <div class="hidden md:flex items-center space-x-1">\n                <a href="#" id="navHome" class="text-slate-600 hover:text-primary hover:bg-primary-light px-3 py-2 rounded-lg text-sm font-medium transition-colors">\n                  <i class="fas fa-home mr-1.5 opacity-70"></i>Inicio\n                </a>\n                <a href="#mis-datos" id="navMyData" class="text-slate-600 hover:text-primary hover:bg-primary-light px-3 py-2 rounded-lg text-sm font-medium transition-colors">\n                  <i class="fas fa-database mr-1.5 opacity-70"></i>B√≥veda\n                </a>\n                <a href="#" id="navSettings" class="text-slate-600 hover:text-primary hover:bg-primary-light px-3 py-2 rounded-lg text-sm font-medium transition-colors">\n                  <i class="fas fa-cogs mr-1.5 opacity-70"></i>Ajustes\n                </a>\n                ${a}\n              </div>\n            </div>\n            \n            <div class="flex items-center gap-4">\n              <div class="hidden md:flex flex-col items-end">\n                <span class="text-sm font-semibold text-slate-700 leading-none">${e.email.split("@")[0]}</span>\n                <span class="mt-1">${s}</span>\n              </div>\n              \n              <div class="relative group">\n                <button id="userMenuButton" class="flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 border border-slate-300 text-slate-600 hover:ring-2 hover:ring-offset-2 hover:ring-primary transition-all">\n                   <span class="font-bold text-lg">${e.email.charAt(0).toUpperCase()}</span>\n                </button>\n                \n                <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 origin-top-right bg-white rounded-xl shadow-2xl ring-1 ring-black ring-opacity-5 focus:outline-none z-50 transform transition-all">\n                  <div class="p-4 border-b border-slate-100 md:hidden">\n                    <p class="text-sm font-medium text-slate-900 truncate">${e.email}</p>\n                    <div class="mt-2">${s}</div>\n                  </div>\n                  <div class="py-1">\n                    <button id="logoutButton" class="group flex w-full items-center px-4 py-2.5 text-sm text-slate-700 hover:bg-red-50 hover:text-red-700 transition-colors">\n                      <i class="fas fa-sign-out-alt mr-3 text-slate-400 group-hover:text-red-500"></i>\n                      Cerrar Sesi√≥n\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      <main class="flex-grow max-w-7xl w-full mx-auto py-8 px-4 sm:px-6 lg:px-8">\n        <div id="dynamicContent" class="animate-fade-in"></div>\n      </main>\n    </div>\n  `,function(){const e=document.getElementById("userMenuButton"),t=document.getElementById("userMenu"),n=document.getElementById("logoutButton");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("hidden"),t.classList.contains("hidden")||t.classList.add("animate-fade-in-down")}),document.addEventListener("click",()=>t.classList.add("hidden")),t.addEventListener("click",e=>e.stopPropagation()));n&&n.addEventListener("click",()=>B.logout());["navMyData","navHome"].forEach(e=>{document.getElementById(e)?.addEventListener("click",e=>{e.preventDefault();ae(B.getCurrentUser())})}),document.getElementById("navSettings")?.addEventListener("click",e=>{e.preventDefault(),B.getCurrentUser(),function(){const e=document.querySelector("main"),t=new te;e.innerHTML=t.render(),t.setupEventListeners()}()})}(),"admin"===n&&document.getElementById("navAdmin")?.addEventListener("click",e=>{e.preventDefault(),alert("üöß Panel Admin: Pr√≥ximamente gesti√≥n de usuarios global.")}),ae(e)}function ae(e){const t=document.querySelector("main");if(!t)return;t.innerHTML='\n    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">\n      <div>\n        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Mi B√≥veda</h2>\n        <p class="text-slate-500 mt-1">Gestiona tus documentos cifrados de forma segura.</p>\n      </div>\n      <button id="btnNewDocVault" class="group inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary-hover text-white font-medium py-2.5 px-5 rounded-xl shadow-lg shadow-blue-500/20 transition-all hover:-translate-y-0.5">\n        <i class="fas fa-plus text-sm transition-transform group-hover:rotate-90"></i>\n        <span>Nuevo Documento</span>\n      </button>\n    </div>\n\n    <div id="vaultListContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[300px]">\n      </div>\n  ';const n=new Z(t=>{ie(t,e)},()=>re(e));document.getElementById("btnNewDocVault")?.addEventListener("click",()=>{re(e)}),n.loadDocuments()}function re(e){const t=document.getElementById("app"),n=new J(t=>{!async function(e,t){const n=document.getElementById("app");n.innerHTML='\n    <div class="h-screen flex items-center justify-center bg-slate-50">\n      <div class="flex flex-col items-center">\n        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary mb-4"></div>\n        <p class="text-slate-500">Cargando plantilla...</p>\n      </div>\n    </div>';try{const s=await N.getTemplateById(e),a=new Y({template:s},()=>se(t,n),()=>re(t));n.innerHTML='\n      <div class="min-h-screen bg-slate-50 py-8 px-4 sm:px-6 lg:px-8">\n        <div id="editorContainer" class="max-w-5xl mx-auto"></div>\n      </div>\n    ',document.getElementById("editorContainer").innerHTML=a.render(),a.setupEventListeners()}catch(s){alert("Error cargando plantilla."),re(t)}}(t,e)});t.innerHTML='\n    <div class="min-h-screen bg-slate-50">\n      <nav class="bg-white border-b border-slate-200 sticky top-0 z-30">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16 items-center">\n            <div class="flex items-center gap-4">\n              <button id="backToDashboard" class="p-2 -ml-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-full transition-colors">\n                <i class="fas fa-arrow-left text-lg"></i>\n              </button>\n              <div>\n                <h1 class="text-xl font-bold text-slate-800">Nueva Entrada</h1>\n                <p class="text-xs text-slate-500">Selecciona una plantilla para comenzar</p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </nav>\n      <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">\n        <div id="templateManagerContainer"></div>\n      </main>\n    </div>\n  ';const s=document.getElementById("templateManagerContainer");s&&(s.innerHTML=n.render(),N.initialize(e.uid),n.loadTemplates()),document.getElementById("backToDashboard")?.addEventListener("click",()=>{se(e,t)})}async function ie(e,t){const n=document.getElementById("app");n.innerHTML='\n    <div class="min-h-screen bg-slate-50 py-8 px-4 flex justify-center items-start">\n      <div class="animate-pulse bg-white w-full max-w-4xl h-96 rounded-2xl shadow-sm"></div>\n    </div>\n  ';const s=new Q(e,e=>{e?function(e,t){const n=document.getElementById("app"),s=new Y(e,()=>ie(e.documentId,t),()=>ie(e.documentId,t));n.innerHTML='\n    <div class="min-h-screen bg-slate-50 py-8 px-4 sm:px-6 lg:px-8">\n      <div id="editorContainer" class="max-w-5xl mx-auto"></div>\n    </div>\n  ',document.getElementById("editorContainer").innerHTML=s.render(),s.setupEventListeners()}(e,t):se(t,n)});n.innerHTML='\n    <div class="min-h-screen bg-slate-50 py-8 px-4 sm:px-6 lg:px-8">\n      <div id="documentViewerPlaceholder" class="max-w-5xl mx-auto"></div>\n    </div>\n  ',document.getElementById("documentViewerPlaceholder").innerHTML=s.render(),await s.load()}document.addEventListener("DOMContentLoaded",()=>{!async function(){const e=document.getElementById("app");if(!e)return;B.subscribe(async t=>{await ne(t,e)});const t=B.getCurrentUser();await ne(t,e)}()}),window.app={initializePostLogin:async function(e,t){await D.initialize(t,e.uid)}};
