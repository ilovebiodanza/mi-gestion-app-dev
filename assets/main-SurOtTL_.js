import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";import{getAuth as t,onAuthStateChanged as n,updatePassword as s,sendPasswordResetEmail as a,signOut as r,signInWithEmailAndPassword as i,createUserWithEmailAndPassword as o}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";import{getFirestore as l,getDoc as d,setDoc as c,doc as u}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const m=e({apiKey:"AIzaSyBJgDqHiHD8mncuRNlw8eA1ismr_fcvj2E",authDomain:"mi-gestion-e2ee.firebaseapp.com",projectId:"mi-gestion-e2ee",storageBucket:"mi-gestion-e2ee.firebasestorage.app",messagingSenderId:"97671435614",appId:"1:97671435614:web:e0f35d92692ca1e63b2bcf",measurementId:"G-GLYJSXBC8E"}),p=t(m),g=l(m);window.firebaseModules={app:m,auth:p,db:g,createUserWithEmailAndPassword:o,signInWithEmailAndPassword:i,signOut:r,sendPasswordResetEmail:a,updatePassword:s,onAuthStateChanged:n,getFirestore:l,doc:u,setDoc:c,getDoc:d};const h=new class{constructor(){if(!window.firebaseModules)throw new Error("Firebase no est√° inicializado. Recarga la p√°gina.");this.modules=window.firebaseModules,this.auth=this.modules.auth,this.db=this.modules.db,this.app=this.modules.app}_cleanObject(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(e=>this._cleanObject(e));const t={};for(const n in e)if(e.hasOwnProperty(n)){const s=e[n];void 0!==s&&(t[n]=this._cleanObject(s))}return t}getAuth(){return this.auth}getFirestore(){return this.db}getApp(){return this.app}async createUser(e,t){return this.modules.createUserWithEmailAndPassword(this.auth,e,t)}async signIn(e,t){return this.modules.signInWithEmailAndPassword(this.auth,e,t)}async signOut(){return this.modules.signOut(this.auth)}async resetPassword(e){return this.modules.sendPasswordResetEmail(this.auth,e)}async updatePassword(e,t){return this.modules.updatePassword(e,t)}onAuthStateChanged(e){return this.modules.onAuthStateChanged(this.auth,e)}getDoc(e){return this.modules.getDoc(e)}setDoc(e,t,n){const s=this._cleanObject(t);return this.modules.setDoc(e,s,n)}doc(e){return this.modules.doc(this.db,e)}};const f=new class{constructor(){this.isInitialized=!1,this.masterKey=null}async initialize(e){return await new Promise(e=>setTimeout(e,500)),this.isInitialized=!0,this.masterKey="simulated_key_"+Date.now(),!0}isReady(){return this.isInitialized&&null!==this.masterKey}getStatus(){return{isInitialized:this.isInitialized,hasMasterKey:null!==this.masterKey,keyLength:this.masterKey?256:0}}clearKeys(){this.masterKey=null,this.isInitialized=!1}async encryptDocument(e,t){if(!this.isInitialized)throw new Error("Cifrado no inicializado");return await new Promise(e=>setTimeout(e,300)),{content:btoa(JSON.stringify(e)),metadata:{algorithm:"AES-GCM-256 (simulado)",encryptedAt:(new Date).toISOString()}}}async decryptDocument(e){if(!this.isInitialized)throw new Error("Cifrado no inicializado");await new Promise(e=>setTimeout(e,300));try{return JSON.parse(atob(e.content))}catch(t){throw new Error("Error al descifrar datos")}}};const b=new class{constructor(){this.currentUser=null,this.authListeners=[],this.initAuthListener()}initAuthListener(){h.onAuthStateChanged(async e=>{this.currentUser=e,this.notifyAuthListeners(e),e&&await this.initializeNewUser(e)})}async initializeNewUser(e){try{const t=await e.getIdTokenResult();(t.claims.isNewUser||!1)&&await this.createUserProfile(e)}catch(t){}}async createUserProfile(e){try{const t={email:e.email,createdAt:(new Date).toISOString(),lastLogin:(new Date).toISOString(),settings:{theme:"auto",language:"es",autoLock:30}};return localStorage.setItem(`user_profile_${e.uid}`,JSON.stringify(t)),t}catch(t){throw t}}async register(e,t){try{const s=await h.createUser(e,t);try{await this.initializeEncryption(t)}catch(n){}return await this.createUserProfile(s.user),{success:!0,user:s.user,message:"Usuario registrado exitosamente"}}catch(s){return{success:!1,error:this.getErrorMessage(s.code),code:s.code}}}async login(e,t){try{const s=await h.signIn(e,t);try{await this.initializeEncryption(t)}catch(n){}return{success:!0,user:s.user,message:"Sesi√≥n iniciada exitosamente"}}catch(s){return{success:!1,error:this.getErrorMessage(s.code),code:s.code}}}async logout(){try{return this.clearEncryption(),this.clearSensitiveData(),await h.signOut(),{success:!0,message:"Sesi√≥n cerrada exitosamente"}}catch(e){return{success:!1,error:"Error al cerrar sesi√≥n",code:e.code}}}async resetPassword(e){try{return await h.resetPassword(e),{success:!0,message:"Correo de restablecimiento enviado"}}catch(t){return{success:!1,error:this.getErrorMessage(t.code),code:t.code}}}async changePassword(e){try{const t=this.currentUser;if(!t)throw new Error("Usuario no autenticado");return await h.updatePassword(t,e),{success:!0,message:"Contrase√±a actualizada exitosamente"}}catch(t){return{success:!1,error:this.getErrorMessage(t.code),code:t.code}}}getErrorMessage(e){return{"auth/email-already-in-use":"Este correo ya est√° registrado. ¬øQuieres iniciar sesi√≥n?","auth/invalid-email":"Correo electr√≥nico no v√°lido","auth/operation-not-allowed":"Operaci√≥n no permitida","auth/weak-password":"La contrase√±a es demasiado d√©bil (m√≠nimo 8 caracteres)","auth/user-disabled":"Esta cuenta ha sido deshabilitada","auth/user-not-found":"Usuario no encontrado. ¬øQuieres registrarte?","auth/wrong-password":"Contrase√±a incorrecta. ¬øOlvidaste tu contrase√±a?","auth/invalid-login-credentials":"Email o contrase√±a incorrectos. Verifica tus credenciales.","auth/too-many-requests":"Demasiados intentos. Intenta m√°s tarde","auth/network-request-failed":"Error de red. Verifica tu conexi√≥n","auth/popup-closed-by-user":"La ventana de autenticaci√≥n fue cerrada","auth/cancelled-popup-request":"Solicitud de autenticaci√≥n cancelada"}[e]||`Error: ${e}`}clearSensitiveData(){["master_key","encryption_keys","user_session_data","temp_encryption_data"].forEach(e=>{localStorage.removeItem(e),sessionStorage.removeItem(e)})}subscribe(e){return this.authListeners.push(e),e(this.currentUser),()=>{this.authListeners=this.authListeners.filter(t=>t!==e)}}notifyAuthListeners(e){this.authListeners.forEach(t=>{try{t(e)}catch(n){}})}getCurrentUser(){return this.currentUser}isAuthenticated(){return!!this.currentUser}async getAuthToken(){return this.currentUser?await this.currentUser.getIdToken():null}async initializeEncryption(e){try{return await f.initialize(e),localStorage.setItem("encryption_initialized","true"),localStorage.setItem("encryption_timestamp",(new Date).toISOString()),!0}catch(t){if(t.toString().includes("QuotaExceededError"))throw new Error("Memoria insuficiente para cifrado. Cierra otras pesta√±as.");throw new Error("Error al configurar el cifrado seguro")}}clearEncryption(){f.clearKeys(),localStorage.removeItem("encryption_initialized"),localStorage.removeItem("encryption_timestamp")}isEncryptionInitialized(){return f.isReady()}};class y{constructor(e){this.onAuthSuccess=e,this.currentForm="login"}renderLoginForm(){return'\n      <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8 space-y-6">\n        <div class="text-center">\n          <i class="fas fa-shield-alt text-4xl text-blue-500 mb-4"></i>\n          <h2 class="text-2xl font-bold text-gray-800">Iniciar Sesi√≥n</h2>\n          <p class="text-gray-600 mt-2">Accede a tu informaci√≥n segura</p>\n        </div>\n\n        <form id="loginForm" class="space-y-4">\n          <div>\n            <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">\n              Correo Electr√≥nico\n            </label>\n            <input\n              type="email"\n              id="loginEmail"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="tu@ejemplo.com"\n            />\n          </div>\n\n          <div>\n            <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">\n              Contrase√±a\n            </label>\n            <input\n              type="password"\n              id="loginPassword"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"\n            />\n          </div>\n\n          <div class="flex items-center justify-between">\n            <label class="flex items-center">\n              <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">\n              <span class="ml-2 text-sm text-gray-600">Recordarme</span>\n            </label>\n            <button type="button" id="forgotPasswordBtn" class="text-sm text-blue-600 hover:text-blue-800">\n              ¬øOlvidaste tu contrase√±a?\n            </button>\n          </div>\n\n          <button\n            type="submit"\n            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition font-medium"\n          >\n            <i class="fas fa-sign-in-alt mr-2"></i>\n            Iniciar Sesi√≥n\n          </button>\n        </form>\n\n        <div class="text-center">\n          <p class="text-gray-600">\n            ¬øNo tienes cuenta?\n            <button id="switchToRegister" class="text-blue-600 hover:text-blue-800 font-medium ml-1">\n              Reg√≠strate aqu√≠\n            </button>\n          </p>\n        </div>\n\n        <div class="text-center text-xs text-gray-500 mt-6">\n          <i class="fas fa-lock mr-1"></i>\n          Tus datos est√°n cifrados de extremo a extremo\n        </div>\n      </div>\n    '}renderRegisterForm(){return'\n      <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8 space-y-6">\n        <div class="text-center">\n          <i class="fas fa-user-plus text-4xl text-green-500 mb-4"></i>\n          <h2 class="text-2xl font-bold text-gray-800">Crear Cuenta</h2>\n          <p class="text-gray-600 mt-2">Comienza a proteger tu informaci√≥n</p>\n        </div>\n\n        <form id="registerForm" class="space-y-4">\n          <div>\n            <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">\n              Correo Electr√≥nico\n            </label>\n            <input\n              type="email"\n              id="registerEmail"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="tu@ejemplo.com"\n            />\n          </div>\n\n          <div>\n            <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">\n              Contrase√±a\n            </label>\n            <input\n              type="password"\n              id="registerPassword"\n              required\n              minlength="8"\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="M√≠nimo 8 caracteres"\n            />\n            <p class="text-xs text-gray-500 mt-1">\n              La contrase√±a se usa para cifrar tus datos. No la compartas.\n            </p>\n          </div>\n\n          <div>\n            <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700 mb-1">\n              Confirmar Contrase√±a\n            </label>\n            <input\n              type="password"\n              id="registerConfirmPassword"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="Repite tu contrase√±a"\n            />\n          </div>\n\n          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">\n            <h4 class="font-medium text-blue-800 mb-2">\n              <i class="fas fa-info-circle mr-1"></i>\n              Importante sobre seguridad\n            </h4>\n            <ul class="text-sm text-blue-700 space-y-1">\n              <li>‚Ä¢ Tus datos se cifran con tu contrase√±a</li>\n              <li>‚Ä¢ Nunca almacenamos tu contrase√±a</li>\n              <li>‚Ä¢ Si la olvidas, no podemos recuperar tus datos</li>\n              <li>‚Ä¢ Considera usar un gestor de contrase√±as</li>\n            </ul>\n          </div>\n\n          <button\n            type="submit"\n            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition font-medium"\n          >\n            <i class="fas fa-user-check mr-2"></i>\n            Crear Cuenta\n          </button>\n        </form>\n\n        <div class="text-center">\n          <p class="text-gray-600">\n            ¬øYa tienes cuenta?\n            <button id="switchToLogin" class="text-blue-600 hover:text-blue-800 font-medium ml-1">\n              Inicia sesi√≥n aqu√≠\n            </button>\n          </p>\n        </div>\n      </div>\n    '}renderForgotPasswordForm(){return'\n      <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8 space-y-6">\n        <div class="text-center">\n          <i class="fas fa-key text-4xl text-orange-500 mb-4"></i>\n          <h2 class="text-2xl font-bold text-gray-800">Recuperar Contrase√±a</h2>\n          <p class="text-gray-600 mt-2">Te enviaremos un correo para restablecerla</p>\n        </div>\n\n        <form id="forgotPasswordForm" class="space-y-4">\n          <div>\n            <label for="resetEmail" class="block text-sm font-medium text-gray-700 mb-1">\n              Correo Electr√≥nico\n            </label>\n            <input\n              type="email"\n              id="resetEmail"\n              required\n              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n              placeholder="tu@ejemplo.com"\n            />\n          </div>\n\n          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">\n            <h4 class="font-medium text-yellow-800 mb-2">\n              <i class="fas fa-exclamation-triangle mr-1"></i>\n              ¬°Atenci√≥n!\n            </h4>\n            <p class="text-sm text-yellow-700">\n              Al restablecer la contrase√±a, tus datos cifrados no podr√°n ser accedidos \n              hasta que los re-encriptes con la nueva contrase√±a.\n            </p>\n          </div>\n\n          <div class="flex space-x-3">\n            <button\n              type="button"\n              id="cancelReset"\n              class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition font-medium"\n            >\n              Cancelar\n            </button>\n            <button\n              type="submit"\n              class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition font-medium"\n            >\n              <i class="fas fa-paper-plane mr-2"></i>\n              Enviar Correo\n            </button>\n          </div>\n        </form>\n      </div>\n    '}render(){switch(this.currentForm){case"login":default:return this.renderLoginForm();case"register":return this.renderRegisterForm();case"forgot":return this.renderForgotPasswordForm()}}setupEventListeners(e){switch(this.removeEventListeners(),this.setupRealTimeValidation(e),this.currentForm){case"login":this.setupLoginListeners(e);break;case"register":this.setupRegisterListeners(e);break;case"forgot":this.setupForgotPasswordListeners(e)}}setupLoginListeners(e){const t=e.querySelector("#loginForm"),n=e.querySelector("#switchToRegister"),s=e.querySelector("#forgotPasswordBtn");t&&t.addEventListener("submit",this.handleLogin.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="register",this.updateView(e)}),s&&s.addEventListener("click",()=>{this.currentForm="forgot",this.updateView(e)})}setupRegisterListeners(e){const t=e.querySelector("#registerForm"),n=e.querySelector("#switchToLogin");t&&t.addEventListener("submit",this.handleRegister.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="login",this.updateView(e)})}setupForgotPasswordListeners(e){const t=e.querySelector("#forgotPasswordForm"),n=e.querySelector("#cancelReset");t&&t.addEventListener("submit",this.handleForgotPassword.bind(this)),n&&n.addEventListener("click",()=>{this.currentForm="login",this.updateView(e)})}async handleLogin(e){e.preventDefault();const t=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value;if(t&&n){this.showLoading(!0);try{const e=await b.login(t,n);e.success?window.app&&window.app.initializePostLogin&&window.app.initializePostLogin(userCredential.user,n):(this.showError(e.error||"Error en login"),this.showLoading(!1))}catch(s){this.showError("Error inesperado. Intenta nuevamente."),this.showLoading(!1)}}else this.showError("Por favor completa todos los campos")}async handleRegister(e){e.preventDefault();const t=document.getElementById("registerEmail").value,n=document.getElementById("registerPassword").value,s=document.getElementById("registerConfirmPassword").value;if(t&&n&&s)if(n===s)if(n.length<8)this.showError("La contrase√±a debe tener al menos 8 caracteres");else{this.showLoading(!0);try{const e=await b.register(t,n);e.success||(this.showError(e.error||"Error en registro"),this.showLoading(!1))}catch(a){this.showError("Error inesperado. Intenta nuevamente."),this.showLoading(!1)}}else this.showError("Las contrase√±as no coinciden");else this.showError("Por favor completa todos los campos")}async handleForgotPassword(e){e.preventDefault();const t=document.getElementById("resetEmail").value;if(!t)return void this.showError("Por favor ingresa tu correo electr√≥nico");if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)){this.showLoading(!0);try{const e=await b.resetPassword(t);e.success?(this.showMessage(e.message,"success"),setTimeout(()=>{this.currentForm="login",this.updateView(document.getElementById("authContainer"))},3e3)):(this.showError(e.error||"Error al enviar correo de recuperaci√≥n"),this.showLoading(!1))}catch(n){this.showError("Error inesperado. Intenta nuevamente."),this.showLoading(!1)}}else this.showError("Por favor ingresa un correo electr√≥nico v√°lido")}async handleForgotPassword(e){e.preventDefault();const t=document.getElementById("resetEmail").value;if(t){this.showLoading(!0);try{const e=await b.resetPassword(t);e.success?(this.showMessage(e.message,"success"),setTimeout(()=>{this.currentForm="login",this.updateView(document.getElementById("authContainer"))},2e3)):(this.showError(e.error),this.showLoading(!1))}catch(n){this.showError("Error inesperado. Intenta nuevamente."),this.showLoading(!1)}}else this.showError("Por favor ingresa tu correo electr√≥nico")}updateView(e){e&&(e.innerHTML=this.render(),this.setupEventListeners(e))}showLoading(e){const t=document.querySelectorAll('button[type="submit"]');document.querySelectorAll("#authContainer button"),t.forEach(t=>{if(e){t.dataset.originalText||(t.dataset.originalText=t.innerHTML);const e='<div class="spinner inline-block mr-2"></div>';t.innerHTML=e+" Procesando...",t.disabled=!0,t.classList.add("opacity-50","cursor-not-allowed")}else t.dataset.originalText&&(t.innerHTML=t.dataset.originalText,delete t.dataset.originalText),t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed")});document.querySelectorAll("#authContainer input").forEach(t=>{t.disabled=e,e?t.classList.add("opacity-50","cursor-not-allowed"):t.classList.remove("opacity-50","cursor-not-allowed")})}restoreButtonText(e){e.disabled=!1,"login"===this.currentForm?e.innerHTML='<i class="fas fa-sign-in-alt mr-2"></i> Iniciar Sesi√≥n':"register"===this.currentForm?e.innerHTML='<i class="fas fa-user-check mr-2"></i> Crear Cuenta':"forgot"===this.currentForm&&(e.innerHTML='<i class="fas fa-paper-plane mr-2"></i> Enviar Correo')}showError(e,t=5e3){this.clearMessages();const n=document.createElement("div");n.className="error-message animate-fade-in",n.innerHTML=`\n    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded-r-lg">\n      <div class="flex">\n        <div class="flex-shrink-0">\n          <i class="fas fa-exclamation-circle text-red-400 text-lg"></i>\n        </div>\n        <div class="ml-3">\n          <p class="text-sm font-medium text-red-800">${e}</p>\n          <p class="text-xs text-red-600 mt-1">Por favor, verifica la informaci√≥n e intenta nuevamente.</p>\n        </div>\n        <div class="ml-auto pl-3">\n          <button onclick="this.parentElement.parentElement.parentElement.remove()" \n                  class="text-red-500 hover:text-red-700 focus:outline-none">\n            <i class="fas fa-times"></i>\n          </button>\n        </div>\n      </div>\n    </div>\n  `;const s=document.querySelector("#authContainer");s&&(s.insertBefore(n,s.firstChild),t>0&&setTimeout(()=>{n.parentNode&&n.remove()},t),n.scrollIntoView({behavior:"smooth",block:"nearest"}))}showMessage(e,t="success",n=5e3){this.clearMessages();const s="success"===t?"fa-check-circle":"fa-info-circle",a="success"===t?"green":"blue",r="success"===t?"border-green-500":"border-blue-500",i="success"===t?"text-green-800":"text-blue-800",o="success"===t?"text-green-400":"text-blue-400",l=document.createElement("div");l.className="success-message animate-fade-in",l.innerHTML=`\n    <div class="bg-${a}-50 border-l-4 ${r} p-4 mb-4 rounded-r-lg">\n      <div class="flex">\n        <div class="flex-shrink-0">\n          <i class="fas ${s} ${o} text-lg"></i>\n        </div>\n        <div class="ml-3">\n          <p class="text-sm font-medium ${i}">${e}</p>\n        </div>\n        <div class="ml-auto pl-3">\n          <button onclick="this.parentElement.parentElement.parentElement.remove()" \n                  class="text-${a}-500 hover:text-${a}-700 focus:outline-none">\n            <i class="fas fa-times"></i>\n          </button>\n        </div>\n      </div>\n    </div>\n  `;const d=document.querySelector("#authContainer");d&&(d.insertBefore(l,d.firstChild),n>0&&setTimeout(()=>{l.parentNode&&l.remove()},n))}clearMessages(){document.querySelectorAll(".error-message, .success-message").forEach(e=>{e.classList.contains("animate-fade-in")&&e.remove()})}removeEventListeners(){}setupRealTimeValidation(e){const t=e.querySelectorAll('input[type="email"]'),n=e.querySelectorAll('input[type="password"]');t.forEach(e=>{e.addEventListener("blur",()=>{this.validateEmail(e)}),e.addEventListener("input",()=>{this.clearInputError(e)})}),n.forEach(e=>{e.addEventListener("blur",()=>{this.validatePassword(e)}),e.addEventListener("input",()=>{this.clearInputError(e)})})}validateEmail(e){const t=e.value.trim();return t&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)?(this.showInputError(e,"Correo electr√≥nico no v√°lido"),!1):(this.clearInputError(e),!0)}validatePassword(e){const t=e.value;return t&&t.length<8?(this.showInputError(e,"M√≠nimo 8 caracteres"),!1):(this.clearInputError(e),!0)}showInputError(e,t){this.clearInputError(e),e.classList.add("input-error");const n=document.createElement("div");n.className="text-red-600 text-xs mt-1 ml-1",n.id=`error-${e.id}`,n.textContent=t,e.parentNode.appendChild(n)}clearInputError(e){e.classList.remove("input-error");const t=e.parentNode.querySelector(`#error-${e.id}`);t&&t.remove()}}class v{constructor(e,t){this.onPasswordSubmit=e,this.userEmail=t,this.isSubmitting=!1}render(){return`\n      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">\n        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fade-in">\n          <div class="text-center mb-6">\n            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">\n              <i class="fas fa-shield-alt text-blue-600 text-2xl"></i>\n            </div>\n            <h3 class="text-xl font-bold text-gray-800">Cifrado de Seguridad</h3>\n            <p class="text-gray-600 mt-2">Ingresa tu contrase√±a para activar el cifrado</p>\n          </div>\n          \n          <div class="space-y-4">\n            <div>\n              <label class="block text-sm font-medium text-gray-700 mb-1">\n                <i class="fas fa-user mr-1"></i>\n                Usuario\n              </label>\n              <input\n                type="text"\n                value="${this.userEmail}"\n                disabled\n                class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600"\n              />\n            </div>\n            \n            <div>\n              <label class="block text-sm font-medium text-gray-700 mb-1">\n                <i class="fas fa-key mr-1"></i>\n                Contrase√±a\n              </label>\n              <input\n                type="password"\n                id="encryptionPassword"\n                placeholder="Ingresa tu contrase√±a"\n                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"\n                autocomplete="current-password"\n              />\n              <p class="text-xs text-gray-500 mt-1">\n                Tu contrase√±a se usa solo para generar claves de cifrado localmente.\n              </p>\n            </div>\n            \n            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">\n              <h4 class="font-medium text-yellow-800 mb-2">\n                <i class="fas fa-info-circle mr-1"></i>\n                Importante\n              </h4>\n              <ul class="text-sm text-yellow-700 space-y-1">\n                <li>‚Ä¢ Sin la contrase√±a correcta, no podr√°s acceder a tus datos cifrados</li>\n                <li>‚Ä¢ La contrase√±a nunca sale de tu dispositivo</li>\n                <li>‚Ä¢ Si la olvidas, perder√°s acceso a tus datos cifrados</li>\n              </ul>\n            </div>\n            \n            <div class="flex space-x-3 pt-2">\n              <button\n                id="cancelEncryption"\n                class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition font-medium"\n              >\n                Omitir por ahora\n              </button>\n              <button\n                id="submitEncryptionPassword"\n                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition font-medium flex items-center justify-center"\n              >\n                <span id="submitText">Activar Cifrado</span>\n                <div id="submitSpinner" class="hidden ml-2">\n                  <div class="spinner-small"></div>\n                </div>\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <style>\n        .animate-fade-in {\n          animation: fadeIn 0.3s ease-out;\n        }\n        @keyframes fadeIn {\n          from { opacity: 0; transform: translateY(-20px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n        .spinner-small {\n          display: inline-block;\n          width: 1rem;\n          height: 1rem;\n          border: 2px solid rgba(255, 255, 255, 0.3);\n          border-radius: 50%;\n          border-top-color: #fff;\n          animation: spin 1s ease-in-out infinite;\n        }\n        @keyframes spin {\n          to { transform: rotate(360deg); }\n        }\n      </style>\n    `}show(){const e=document.createElement("div");e.id="encryptionPromptOverlay",e.innerHTML=this.render(),document.body.appendChild(e),this.setupEventListeners()}hide(){const e=document.getElementById("encryptionPromptOverlay");e&&e.remove()}setupEventListeners(){const e=document.getElementById("encryptionPassword"),t=document.getElementById("submitEncryptionPassword"),n=document.getElementById("cancelEncryption"),s=document.getElementById("submitText"),a=document.getElementById("submitSpinner");t.addEventListener("click",async()=>{if(this.isSubmitting)return;const n=e.value.trim();if(n){this.isSubmitting=!0,s.textContent="Inicializando...",a.classList.remove("hidden"),t.disabled=!0;try{await this.onPasswordSubmit(n)?this.hide():(this.showError("Contrase√±a incorrecta o error al inicializar cifrado"),this.resetForm())}catch(r){this.showError(r.message||"Error al activar cifrado"),this.resetForm()}}else this.showError("Por favor ingresa tu contrase√±a")}),n.addEventListener("click",()=>{this.hide()}),e.addEventListener("keypress",e=>{"Enter"!==e.key||this.isSubmitting||t.click()});const r=document.getElementById("encryptionPromptOverlay");r.addEventListener("click",e=>{e.target===r&&this.hide()})}showError(e){this.clearErrors();const t=document.createElement("div");t.className="bg-red-50 border border-red-200 rounded-lg p-3 mt-3 animate-fade-in",t.innerHTML=`\n      <div class="flex items-center">\n        <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>\n        <span class="text-red-700 text-sm">${e}</span>\n      </div>\n    `;const n=document.querySelector("#encryptionPromptOverlay .bg-white");n&&n.insertBefore(t,n.querySelector(".flex.space-x-3"))}clearErrors(){document.querySelectorAll("#encryptionPromptOverlay .bg-red-50").forEach(e=>e.remove())}resetForm(){this.isSubmitting=!1;const e=document.getElementById("submitText"),t=document.getElementById("submitSpinner"),n=document.getElementById("submitEncryptionPassword");e&&(e.textContent="Activar Cifrado"),t&&t.classList.add("hidden"),n&&(n.disabled=!1);const s=document.getElementById("encryptionPassword");s&&s.focus()}}class x{constructor(){this.testData={nombre:"Juan P√©rez",email:"juan@ejemplo.com",telefono:"+1234567890",direccion:"Calle Principal 123",notas:"Informaci√≥n confidencial del usuario",fechaNacimiento:"1990-01-01",numeroIdentificacion:"123456789"}}render(){return`\n      <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto">\n        <h2 class="text-2xl font-bold text-gray-800 mb-6">\n          <i class="fas fa-shield-alt text-blue-500 mr-2"></i>\n          Prueba de Cifrado E2EE\n        </h2>\n        \n        <div class="space-y-6">\n          \x3c!-- Estado del cifrado --\x3e\n          <div id="encryptionStatus" class="bg-blue-50 border border-blue-200 rounded-lg p-4">\n            <div class="flex items-center">\n              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mr-3"></div>\n              <span class="text-blue-700">Verificando estado del cifrado...</span>\n            </div>\n          </div>\n          \n          \x3c!-- Datos de prueba --\x3e\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h3 class="font-semibold text-gray-700 mb-3">Datos de Prueba:</h3>\n            <pre id="testData" class="text-sm bg-gray-50 p-3 rounded overflow-x-auto">${JSON.stringify(this.testData,null,2)}</pre>\n          </div>\n          \n          \x3c!-- Botones de acci√≥n --\x3e\n          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n            <button id="btnEncrypt" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">\n              <i class="fas fa-lock mr-2"></i>\n              Cifrar Datos\n            </button>\n            \n            <button id="btnDecrypt" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>\n              <i class="fas fa-unlock mr-2"></i>\n              Descifrar Datos\n            </button>\n          </div>\n          \n          \x3c!-- Resultados --\x3e\n          <div id="resultsContainer" class="hidden">\n            <h3 class="font-semibold text-gray-700 mb-3">Resultados:</h3>\n            \n            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n              \x3c!-- Datos cifrados --\x3e\n              <div class="border border-gray-200 rounded-lg p-4">\n                <h4 class="font-medium text-gray-600 mb-2">Datos Cifrados:</h4>\n                <div id="encryptedData" class="text-xs font-mono bg-gray-900 text-green-400 p-3 rounded overflow-x-auto h-40 overflow-y-auto">\n                  \x3c!-- Se llenar√° din√°micamente --\x3e\n                </div>\n                <p class="text-xs text-gray-500 mt-2">Base64 ¬∑ AES-GCM-256</p>\n              </div>\n              \n              \x3c!-- Datos descifrados --\x3e\n              <div class="border border-gray-200 rounded-lg p-4">\n                <h4 class="font-medium text-gray-600 mb-2">Datos Descifrados:</h4>\n                <pre id="decryptedData" class="text-xs bg-gray-50 p-3 rounded overflow-x-auto h-40 overflow-y-auto">\n                  \x3c!-- Se llenar√° din√°micamente --\x3e\n                </pre>\n                <p class="text-xs text-gray-500 mt-2">Verificaci√≥n de integridad</p>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- Estad√≠sticas --\x3e\n          <div id="statsContainer" class="hidden">\n            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">\n              <div class="bg-gray-50 p-3 rounded-lg">\n                <p class="text-xs text-gray-500">Tama√±o Original</p>\n                <p id="originalSize" class="font-bold text-gray-800">--</p>\n              </div>\n              <div class="bg-gray-50 p-3 rounded-lg">\n                <p class="text-xs text-gray-500">Tama√±o Cifrado</p>\n                <p id="encryptedSize" class="font-bold text-gray-800">--</p>\n              </div>\n              <div class="bg-gray-50 p-3 rounded-lg">\n                <p class="text-xs text-gray-500">Overhead</p>\n                <p id="encryptionOverhead" class="font-bold text-gray-800">--</p>\n              </div>\n              <div class="bg-gray-50 p-3 rounded-lg">\n                <p class="text-xs text-gray-500">Tiempo</p>\n                <p id="encryptionTime" class="font-bold text-gray-800">-- ms</p>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- Informaci√≥n de seguridad --\x3e\n          <div class="bg-green-50 border border-green-200 rounded-lg p-4">\n            <h4 class="font-medium text-green-800 mb-2">\n              <i class="fas fa-check-circle mr-2"></i>\n              Seguridad Garantizada\n            </h4>\n            <ul class="text-sm text-green-700 space-y-1">\n              <li>‚Ä¢ <strong>Cifrado de extremo a extremo:</strong> Los datos nunca salen de tu dispositivo sin cifrar</li>\n              <li>‚Ä¢ <strong>Clave √∫nica por documento:</strong> Cada documento tiene su propia clave de cifrado</li>\n              <li>‚Ä¢ <strong>AES-GCM 256-bit:</strong> Est√°ndar militar de cifrado</li>\n              <li>‚Ä¢ <strong>Verificaci√≥n de integridad:</strong> Detecta cualquier modificaci√≥n en los datos</li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    `}setupEventListeners(){this.checkEncryptionStatus(),document.getElementById("btnEncrypt")?.addEventListener("click",()=>{this.runEncryptionTest()}),document.getElementById("btnDecrypt")?.addEventListener("click",()=>{this.runDecryptionTest()})}checkEncryptionStatus(){const e=document.getElementById("encryptionStatus");if(!e)return;const t=f.getStatus();if(t.isInitialized&&t.hasMasterKey){e.innerHTML=`\n      <div class="flex items-center">\n        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">\n          <i class="fas fa-check text-green-600"></i>\n        </div>\n        <div>\n          <p class="font-medium text-green-800">Cifrado E2EE activo</p>\n          <p class="text-sm text-green-600">Clave de ${8*t.keyLength} bits ¬∑ PBKDF2</p>\n        </div>\n      </div>\n    `;const n=document.getElementById("btnEncrypt");n&&(n.disabled=!1)}else e.innerHTML='\n      <div class="flex items-center justify-between">\n        <div class="flex items-center">\n          <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">\n            <i class="fas fa-exclamation-triangle text-yellow-600"></i>\n          </div>\n          <div>\n            <p class="font-medium text-yellow-800">Cifrado no inicializado</p>\n            <p class="text-sm text-yellow-600">Esperando activaci√≥n...</p>\n          </div>\n        </div>\n        <button id="retryEncryption" class="text-sm bg-yellow-100 text-yellow-700 hover:bg-yellow-200 px-3 py-1 rounded-lg transition">\n          <i class="fas fa-redo mr-1"></i> Reintentar\n        </button>\n      </div>\n    ',setTimeout(()=>{const e=document.getElementById("retryEncryption");e&&e.addEventListener("click",()=>{this.checkEncryptionStatus()})},100)}async runEncryptionTest(){try{const e=performance.now();document.getElementById("btnEncrypt").disabled=!0,document.getElementById("btnEncrypt").innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Cifrando...';const t=await f.encryptDocument(this.testData,"test_document"),n=performance.now(),s=Math.round(n-e);this.displayResults(t,s),window.lastEncryptedData=t,document.getElementById("btnDecrypt").disabled=!1,document.getElementById("btnEncrypt").innerHTML='<i class="fas fa-lock mr-2"></i> Cifrar Datos',document.getElementById("btnEncrypt").disabled=!1}catch(e){this.showError("Error al cifrar datos: "+e.message),document.getElementById("btnEncrypt").innerHTML='<i class="fas fa-lock mr-2"></i> Cifrar Datos',document.getElementById("btnEncrypt").disabled=!1}}async runDecryptionTest(){try{if(!window.lastEncryptedData)throw new Error("No hay datos cifrados para descifrar");document.getElementById("btnDecrypt").disabled=!0,document.getElementById("btnDecrypt").innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Descifrando...';const e=await f.decryptDocument(window.lastEncryptedData);document.getElementById("decryptedData").textContent=JSON.stringify(e,null,2);JSON.stringify(e)===JSON.stringify(this.testData)?this.showSuccess("‚úÖ Datos descifrados correctamente - Integridad verificada"):this.showWarning("‚ö†Ô∏è  Datos descifrados pero la integridad no coincide"),document.getElementById("btnDecrypt").innerHTML='<i class="fas fa-unlock mr-2"></i> Descifrar Datos',document.getElementById("btnDecrypt").disabled=!1}catch(e){this.showError("Error al descifrar: "+e.message),document.getElementById("btnDecrypt").innerHTML='<i class="fas fa-unlock mr-2"></i> Descifrar Datos',document.getElementById("btnDecrypt").disabled=!1}}displayResults(e,t){document.getElementById("resultsContainer").classList.remove("hidden"),document.getElementById("statsContainer").classList.remove("hidden");const n=JSON.stringify(e,null,2),s=n.substring(0,500)+"...";document.getElementById("encryptedData").textContent=s;const a=JSON.stringify(this.testData).length,r=n.length,i=((r-a)/a*100).toFixed(1);document.getElementById("originalSize").textContent=a+" bytes",document.getElementById("encryptedSize").textContent=r+" bytes",document.getElementById("encryptionOverhead").textContent=i+"%",document.getElementById("encryptionTime").textContent=t+" ms",this.showSuccess(`‚úÖ Datos cifrados en ${t}ms (${i}% overhead)`)}showSuccess(e){this.showMessage(e,"success")}showError(e){this.showMessage(e,"error")}showWarning(e){this.showMessage(e,"warning")}showMessage(e,t="info"){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg animate-fade-in ${"success"===t?"bg-green-500":"error"===t?"bg-red-500":"warning"===t?"bg-yellow-500":"bg-blue-500"} text-white`,n.innerHTML=`\n      <div class="flex items-center">\n        <i class="fas ${"success"===t?"fa-check-circle":"error"===t?"fa-exclamation-circle":"warning"===t?"fa-exclamation-triangle":"fa-info-circle"} mr-3"></i>\n        <span>${e}</span>\n      </div>\n    `,document.body.appendChild(n),setTimeout(()=>{n.classList.add("animate-fade-out"),setTimeout(()=>n.remove(),300)},5e3)}}class w{constructor(e,t="mi-gestion-v1"){this.userId=e,this.appId=t}async loadFromLocalStorage(){const e=`user_templates_${this.userId}`,t=localStorage.getItem(e);return t?JSON.parse(t):[]}async saveToLocalStorage(e){try{if(!this.userId)return;const t=`user_templates_${this.userId}`;localStorage.setItem(t,JSON.stringify(e))}catch(t){}}getTemplatesRef(){if(!this.userId)throw new Error("ID de usuario no definido para Firestore.");return h.doc(`artifacts/${this.appId}/users/${this.userId}/metadata/templates`)}async loadFromFirestore(){try{const e=this.getTemplatesRef(),t=await h.getDoc(e);if(t.exists()){const e=t.data();return e.templates||[]}return[]}catch(e){return null}}async saveToFirestore(e){try{if(!this.userId)return;const t=this.getTemplatesRef(),n={userId:this.userId,appId:this.appId,templates:e,lastUpdated:(new Date).toISOString(),count:e.length};await h.setDoc(t,n,{merge:!0}),await this.saveToLocalStorage(e)}catch(t){throw new Error("Fallo al guardar plantillas en la nube.")}}async migrateToFirestore(){const e=await this.loadFromLocalStorage();return e.length>0?(await this.saveToFirestore(e),{success:!0,migrated:e.length}):{success:!0,migrated:0}}async checkSyncStatus(e){if(!this.userId)return{synced:!1,error:"Usuario no autenticado"};const t=this.getTemplatesRef(),n=await h.getDoc(t);if(n.exists()){const t=n.data(),s=t.templates||[];return{synced:s.length===e.length,localCount:e.length,cloudCount:s.length,cloudTemplates:s,lastUpdated:t.lastUpdated,needsSync:s.length!==e.length}}return{synced:!1,localCount:e.length,cloudCount:0,needsSync:!0,cloudTemplates:[]}}}const E=[{value:"string",label:"Texto corto",inputType:"text"},{value:"text",label:"Texto largo",inputType:"textarea"},{value:"phone",label:"N√∫mero de tel√©fono",inputType:"tel"},{value:"number",label:"N√∫mero",inputType:"number"},{value:"currency",label:"Monto (Moneda)",inputType:"number"},{value:"percentage",label:"Porcentaje",inputType:"number"},{value:"boolean",label:"S√≠/No",inputType:"checkbox"},{value:"date",label:"Fecha",inputType:"date"},{value:"select",label:"Selecci√≥n Simple",inputType:"select"},{value:"url",label:"URL",inputType:"url"},{value:"email",label:"Email",inputType:"email"},{value:"secret",label:"Contrase√±a (Oculto)",inputType:"password"}],T=()=>E;const I=new class{getValidFieldTypes(){return T().map(e=>e.value)}generateFieldId(e,t){if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_$]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"");return n&&/^[a-zA-Z_$]/.test(n)?n:`campo_${t+1}`}validateField(e,t){const n=this.getValidFieldTypes();if(!n.includes(e.type))throw new Error(`Tipo de campo inv√°lido: "${e.type}". Tipos v√°lidos: ${n.join(", ")}`);return e.id||(e.id=this.generateFieldId(e.label,t)),void 0===e.sensitive&&(e.sensitive=!1),!0}validateTemplateData(e){if(!e.name||!e.fields)throw new Error("La plantilla debe tener nombre y campos");if(!Array.isArray(e.fields)||0===e.fields.length)throw new Error("La plantilla debe tener al menos un campo");return e.fields.forEach((e,t)=>{this.validateField(e,t)}),!0}getCategoryName(e){return{personal:"Personal",access:"Accesos",financial:"Financiero",health:"Salud",custom:"Personalizado"}[e]||e}getCategoryIcon(e){return{personal:"üë§",access:"üîê",financial:"üí∞",health:"üè•",custom:"üìã"}[e]||"üìÑ"}};const L=new class{constructor(){this.userId=null,this.appId="mi-gestion-v1",this.userTemplates=[],this.isInitialized=!1,this.storage=null}async initialize(e){this.isInitialized&&this.userId===e||(this.userId=e,this.storage=new w(e,this.appId),await this.loadUserTemplates(),this.isInitialized=!0)}async loadUserTemplates(){try{if(!this.userId)return void(this.userTemplates=[]);let e=await this.storage.loadFromFirestore();null===e&&(e=await this.storage.loadFromLocalStorage()),this.userTemplates=e||[],e&&0===e.length&&await this.storage.saveToFirestore(this.userTemplates)}catch(e){this.userTemplates=[]}}async createTemplate(e){if(!this.userId)throw new Error("Usuario no autenticado");I.validateTemplateData(e);const t={id:`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:this.userId,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),...e,settings:{allowDuplicates:!1,maxEntries:0,category:"custom",...e.settings,isSystemTemplate:!1}};return this.userTemplates.push(t),await this.storage.saveToFirestore(this.userTemplates),t}async updateTemplate(e,t){const n=this.userTemplates.findIndex(t=>t.id===e);if(-1===n)throw new Error("Plantilla no encontrada");const s={...this.userTemplates[n],...t};return I.validateTemplateData(s),this.userTemplates[n]={...s,updatedAt:(new Date).toISOString()},await this.storage.saveToFirestore(this.userTemplates),this.userTemplates[n]}async deleteTemplate(e){const t=this.userTemplates.length;if(this.userTemplates=this.userTemplates.filter(t=>t.id!==e),this.userTemplates.length===t)throw new Error("Plantilla no encontrada");return await this.storage.saveToFirestore(this.userTemplates),{success:!0,message:"Plantilla eliminada"}}async getUserTemplates(){if(!this.isInitialized)throw new Error("Servicio no inicializado");return this.userTemplates}async getTemplateById(e){return this.userTemplates.find(t=>t.id===e)||null}async getCategories(){const e=await this.getUserTemplates();return[...new Set(e.map(e=>e.settings.category))].map(t=>({id:t,count:e.filter(e=>e.settings.category===t).length}))}async checkSyncStatus(){return this.storage.checkSyncStatus(this.userTemplates)}async syncTemplates(){const e=await this.storage.checkSyncStatus(this.userTemplates);if(e.needsSync){if(e.cloudCount>e.localCount)return this.userTemplates=e.cloudTemplates,await this.storage.saveToLocalStorage(this.userTemplates),{synced:!0,message:`Descargadas ${e.cloudCount} plantillas.`};if(e.localCount>e.cloudCount)return await this.storage.saveToFirestore(this.userTemplates),{synced:!0,message:`Subidas ${e.localCount} plantillas.`}}return{synced:!0,message:"Sincronizado."}}},S=(e,t)=>{if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_$]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"");return n&&/^[a-zA-Z_$]/.test(n)?n:`campo_${t+1}`},C=e=>({personal:"Personal",access:"Accesos",financial:"Financiero",health:"Salud",home:"Hogar",car:"Veh√≠culo",job:"Trabajo",education:"Formaci√≥n",custom:"Personalizado",all:"Todas"}[e]||e),$=e=>({personal:"üë§",access:"üîê",financial:"üí∞",health:"üè•",home:"üè†",car:"üöó",job:"üíº",education:"üéì",custom:"üìã"}[e]||"üìÑ"),k=e=>{const t=(n=e,E.find(e=>e.value===n));var n;return t?t.label:e};class F{constructor(e){this.onTemplateSelect=e,this.currentView="list",this.editingTemplate=null,this.tempFormData=null,this.allTemplates=[],this.currentCategory="all"}render(){return`\n      <div class="bg-white rounded-xl shadow-lg overflow-hidden">\n        <div class="border-b border-gray-200 px-6 py-4">\n          <div class="flex justify-between items-center">\n            <div>\n              <h2 class="text-xl font-bold text-gray-800">\n                <i class="fas fa-layer-group mr-2"></i>\n                Plantillas de Datos\n              </h2>\n              <p class="text-gray-600 text-sm mt-1">\n                Crea y gestiona plantillas para organizar tu informaci√≥n\n              </p>\n            </div>\n            <button id="btnNewTemplate" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">\n              <i class="fas fa-plus mr-2"></i>\n              Nueva Plantilla\n            </button>\n          </div>\n        </div>\n\n        <div id="templateContent" class="p-6">\n          ${this.renderLoading()}\n        </div>\n      </div>\n    `}renderLoading(){return'\n      <div class="flex justify-center py-12">\n        <div class="text-center">\n          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>\n          <p class="mt-4 text-gray-600">Cargando plantillas...</p>\n        </div>\n      </div>\n    '}renderTemplateList(e,t){e.filter(e=>e.settings?.isSystemTemplate);const n=e.filter(e=>!e.settings?.isSystemTemplate);return`\n      <div class="space-y-6">\n        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">\n          <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-3 cursor-pointer transition category-filter ${"all"===this.currentCategory?"border-2 border-blue-500 bg-blue-100":""}" data-category="all">\n            <div class="flex items-center">\n              <span class="text-lg mr-2">‚≠ê</span>\n              <div>\n                <p class="font-medium text-gray-800">Todas</p>\n                <p class="text-xs text-gray-500">${this.allTemplates.length} plantilla${1!==this.allTemplates.length?"s":""}</p>\n              </div>\n            </div>\n          </div>\n          ${t.map(e=>`\n            <div class="bg-gray-50 hover:bg-gray-100 rounded-lg p-3 cursor-pointer transition category-filter ${e.id===this.currentCategory?"border-2 border-blue-500 bg-blue-100":""}" data-category="${e.id}">\n              <div class="flex items-center">\n                <span class="text-lg mr-2">${$(e.id)}</span>\n                <div>\n                  <p class="font-medium text-gray-800">${C(e.id)}</p>\n                  <p class="text-xs text-gray-500">${e.count} plantilla${1!==e.count?"s":""}</p>\n                </div>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n\n        <div id="customTemplatesSection">\n          <div id="customTemplatesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">\n            ${n.length>0?n.map(e=>this.renderTemplateCard(e)).join(""):""}\n          </div>\n          \n          <div id="noCustomTemplates" class="${n.length>0?"hidden":""} text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">\n            <p class="text-gray-600 font-medium">No hay plantillas${"all"!==this.currentCategory?` en ${C(this.currentCategory)}`:""}</p>\n            <p class="text-gray-500 text-sm mt-1">Crea tu primera plantilla para organizar tus datos</p>\n          </div>\n        </div>\n      </div>\n    `}renderTemplateCard(e){const t=e.fields.length,n=e.fields.filter(e=>e.sensitive).length;return e.id||(e.id="temp_"+Math.random()),`\n    <div class="template-card border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-md transition-all cursor-pointer bg-white" \n         data-template-id="${e.id}"\n         data-template-name="${e.name||""}">\n      <div class="p-4">\n        <div class="flex justify-between items-start mb-3">\n          <div class="flex items-center">\n            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg" style="background-color: ${e.color}20; color: ${e.color}">\n              ${e.icon||"üìã"}\n            </div>\n            <div class="ml-3">\n              <h4 class="font-bold text-gray-800">${e.name||"Sin nombre"}</h4>\n              <p class="text-xs text-gray-500 truncate max-w-[150px]">${e.description||"Sin descripci√≥n"}</p>\n            </div>\n          </div>\n          ${e.settings?.isSystemTemplate?'\n            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">\n              Sistema\n            </span>\n          ':`\n            <div class="flex space-x-1">\n              <button type="button" class="edit-template text-gray-400 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition" \n                      data-template-id="${e.id}"\n                      title="Editar plantilla">\n                <i class="fas fa-edit"></i>\n              </button>\n              <button type="button" class="delete-template text-gray-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition" \n                      data-template-id="${e.id}"\n                      title="Eliminar plantilla">\n                <i class="fas fa-trash"></i>\n              </button>\n            </div>\n          `}\n        </div>\n        \n        <div class="space-y-2">\n          <div class="flex justify-between text-sm">\n            <span class="text-gray-600">\n              <i class="fas fa-list-ul mr-1"></i>\n              ${t} campo${1!==t?"s":""}\n            </span>\n            ${n>0?`\n              <span class="text-red-600">\n                <i class="fas fa-lock mr-1"></i>\n                ${n} sensible${1!==n?"s":""}\n              </span>\n            `:""}\n          </div>\n          \n          <div class="flex flex-wrap gap-1">\n            ${e.fields.slice(0,3).map(e=>`\n              <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded border border-gray-200">\n                ${e.label||"Sin etiqueta"}\n              </span>\n            `).join("")}\n            ${e.fields.length>3?`\n              <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded border border-gray-200">\n                +${e.fields.length-3} m√°s\n              </span>\n            `:""}\n          </div>\n        </div>\n        \n        <button type="button" class="use-template-btn w-full mt-4 bg-gray-50 hover:bg-blue-50 text-blue-600 hover:text-blue-700 font-medium py-2 px-4 rounded-lg transition flex items-center justify-center border border-gray-200 hover:border-blue-200"\n                data-template-id="${e.id}">\n          <i class="fas fa-plus-circle mr-2"></i>\n          Usar esta plantilla\n        </button>\n      </div>\n    </div>\n  `}async loadTemplates(){try{const e=document.getElementById("templateContent");if(!e)return;e.innerHTML=this.renderLoading();const t=await L.checkSyncStatus();t.needsSync&&t.cloudCount>0&&(this.showMessage(`Hay ${t.cloudCount} plantillas en la nube. <button type="button" class="underline font-medium" id="quickSync">Sincronizar</button>`,"info",1e4),setTimeout(()=>{document.getElementById("quickSync")?.addEventListener("click",async()=>{const e=await L.syncTemplates();e.synced&&(this.showSuccess(e.message),this.loadTemplates())})},100)),this.allTemplates=await L.getUserTemplates();const n=await L.getCategories();this.currentCategory="all",e.innerHTML=this.renderTemplateList(this.allTemplates,n),this.setupTemplateListListeners()}catch(e){this.showError("Error al cargar plantillas: "+e.message)}}setupTemplateListListeners(){const e=document.getElementById("btnNewTemplate");e&&e.addEventListener("click",()=>this.showTemplateForm()),document.querySelectorAll(".category-filter").forEach(e=>{e.addEventListener("click",e=>this.filterTemplatesByCategory(e.currentTarget.dataset.category))});const t=document.getElementById("templateContent");t&&t.addEventListener("click",e=>{if(!e.target.closest("button, .template-card"))return;const t=e.target.closest(".template-card"),n=t?.dataset.templateId;e.target.closest(".use-template-btn")?(n&&this.onTemplateSelect&&this.onTemplateSelect(n),e.stopPropagation()):e.target.closest(".edit-template")?(n&&this.editTemplate(n),e.stopPropagation()):e.target.closest(".delete-template")?(n&&this.deleteTemplate(n),e.stopPropagation()):e.target.closest("#syncTemplates")?L.syncTemplates().then(e=>{e.synced?(this.showSuccess(e.message),setTimeout(()=>this.loadTemplates(),1e3)):this.showError("Error de sincronizaci√≥n: "+e.error)}).catch(e=>this.showError("Error: "+e.message)):!t||e.target.closest("button")||e.target.closest("a")||n&&this.showTemplatePreview(n)})}renderTemplateForm(e=null){const t=!!e,n=e?.fields?e.fields.map((e,t)=>this.renderFieldForm(e,t)).join(""):"",s=e?.settings?.category||"custom",a=e?.icon||$(s);return`\n      <div class="max-w-4xl mx-auto">\n        <div class="mb-6">\n          <h3 class="text-xl font-bold text-gray-800">\n            <i class="fas fa-${t?"edit":"plus-circle"} mr-2"></i>\n            ${t?"Editar Plantilla":"Nueva Plantilla"}\n          </h3>\n          <p class="text-gray-600 mt-1">\n            ${t?"Modifica los detalles de tu plantilla":"Crea una plantilla personalizada para organizar tus datos"}\n          </p>\n        </div>\n\n        <form id="templateForm" class="space-y-6">\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="font-semibold text-gray-800 mb-4">\n              <i class="fas fa-info-circle mr-2 text-blue-500"></i>\n              Informaci√≥n B√°sica\n            </h4>\n            \n            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n              <div>\n                <label for="templateName" class="block text-sm font-medium text-gray-700 mb-1">\n                  Nombre de la Plantilla *\n                </label>\n                <input type="text" id="templateName" value="${e?.name||""}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ej: Datos M√©dicos, Credenciales, etc." />\n              </div>\n              \n              <div>\n                <label for="templateCategory" class="block text-sm font-medium text-gray-700 mb-1">\n                  Categor√≠a *\n                </label>\n                <select id="templateCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">\n                  ${[{value:"custom",label:"Personalizado"},{value:"personal",label:"Personal"},{value:"access",label:"Accesos"},{value:"financial",label:"Financiero"},{value:"health",label:"Salud"},{value:"home",label:"Hogar"},{value:"car",label:"Veh√≠culo"},{value:"job",label:"Trabajo"},{value:"education",label:"Formaci√≥n"}].map(e=>`\n                    <option value="${e.value}" ${e.value===s?"selected":""}>\n                      ${$(e.value)} ${e.label}\n                    </option>\n                  `).join("")}\n                </select>\n              </div>\n              \n              <div>\n                <label for="templateIcon" class="block text-sm font-medium text-gray-700 mb-1">Icono</label>\n                <input type="text" id="templateIcon" value="${a}" \n                       maxlength="2" class="w-16 text-center px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="üìã" />\n              </div>\n              \n              <div>\n                <label for="templateColor" class="block text-sm font-medium text-gray-700 mb-1">Color</label>\n                <input type="color" id="templateColor" value="${e?.color||"#3B82F6"}" class="w-full h-10 px-1 border border-gray-300 rounded-lg cursor-pointer" />\n              </div>\n\n            </div>\n\n            <div class="mt-4">\n                <label for="templateDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>\n                <input type="text" id="templateDescription" value="${e?.description||""}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Breve descripci√≥n de la plantilla" />\n            </div>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <div class="flex justify-between items-center mb-4">\n              <h4 class="font-semibold text-gray-800">\n                <i class="fas fa-list-alt mr-2 text-green-500"></i>\n                Campos de la Plantilla\n              </h4>\n              <button type="button" id="addFieldBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition flex items-center">\n                <i class="fas fa-plus mr-2"></i>\n                Agregar Campo\n              </button>\n            </div>\n            \n            <div id="fieldsContainer" class="space-y-4">\n              ${n}\n            </div>\n            \n            <div id="noFieldsMessage" class="${e?.fields?.length?"hidden":"text-center py-8 border-2 border-dashed border-gray-300 rounded-lg"}">\n              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">\n                <i class="fas fa-list-ul text-gray-400 text-2xl"></i>\n              </div>\n              <p class="text-gray-600 font-medium">No hay campos definidos</p>\n              <p class="text-gray-500 text-sm mt-1">Agrega campos para capturar informaci√≥n</p>\n            </div>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="font-semibold text-gray-800 mb-4">\n              <i class="fas fa-cogs mr-2 text-purple-500"></i>\n              Configuraci√≥n Adicional\n            </h4>\n            \n            <div class="space-y-4">\n              <div class="flex items-center">\n                <input type="checkbox" id="allowDuplicates" ${e?.settings?.allowDuplicates?"checked":""} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />\n                <label for="allowDuplicates" class="ml-2 text-gray-700">Permitir m√∫ltiples entradas con esta plantilla</label>\n              </div>\n              \n              <div>\n                <label for="maxEntries" class="block text-sm font-medium text-gray-700 mb-1">L√≠mite de entradas (0 = ilimitado)</label>\n                <input type="number" id="maxEntries" value="${e?.settings?.maxEntries||0}" min="0" class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />\n              </div>\n              \n              </div>\n          </div>\n\n          <div class="flex justify-between pt-4 border-t border-gray-200">\n            <button type="button" id="cancelTemplate" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg transition">Cancelar</button>\n            <div class="space-x-3">\n              <button type="button" id="previewTemplate" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-lg transition"><i class="fas fa-eye mr-2"></i>Vista Previa</button>\n              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition"><i class="fas fa-save mr-2"></i>${t?"Actualizar Plantilla":"Crear Plantilla"}</button>\n            </div>\n          </div>\n        </form>\n      </div>\n    `}renderFieldForm(e=null,t=0){const n=e?.id||S(e?.label||`campo_${t+1}`,t),s=T();return`\n    <div class="field-item border border-gray-200 rounded-lg p-4 cursor-move" data-field-id="${n}">\n      <div class="flex justify-between items-start mb-4">\n        <span class="drag-handle text-gray-400 hover:text-gray-600 mr-3 p-1"><i class="fas fa-grip-lines"></i></span>\n        <h5 class="font-medium text-gray-800"><i class="fas fa-columns mr-2"></i>Campo ${t+1}</h5>\n        <button type="button" class="remove-field text-red-600 hover:text-red-800"><i class="fas fa-times"></i></button>\n      </div>\n      \n      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4"> \n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Campo *</label>\n          <input type="text" class="field-label w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" value="${e?.label||""}" placeholder="Ej: Nombre Completo" required />\n        </div>\n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Dato *</label>\n          <select class="field-type w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm">\n            ${s.map(t=>`\n                          <option value="${t.value}" ${e?.type===t.value?"selected":""}>\n                            ${t.label}\n                          </option>\n                        `).join("")}\n          </select>\n        </div>\n\n        <div class="options-input-group ${"select"===e?.type?"":"hidden"} mt-4">\n          <label class="block text-sm font-medium text-gray-700 mb-1">Opciones (separadas por coma) *</label>\n          <textarea\n            class="field-options w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"\n            placeholder="Ej: Banco, Tarjeta de Cr√©dito, Inversi√≥n"\n          >${(e?.options||[]).join(", ")}</textarea>\n        </div>\n        \n      </div>\n      \n      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">\n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-1">Texto de ayuda</label>\n          <input type="text" class="field-placeholder w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" value="${e?.placeholder||""}" placeholder="Placeholder..." />\n        </div>\n        <div class="space-y-2">\n          <div class="flex items-center">\n            <input type="checkbox" class="field-required h-4 w-4 text-blue-600 border-gray-300 rounded" ${e?.required?"checked":""} />\n            <label class="ml-2 text-sm text-gray-700">Obligatorio</label>\n          </div>\n          <div class="flex items-center">\n            <input type="checkbox" class="field-sensitive h-4 w-4 text-red-600 border-gray-300 rounded" ${e?.sensitive?"checked":""} />\n            <label class="ml-2 text-sm text-gray-700">Sensible</label>\n          </div>\n        </div>\n        <div class="encryption-level-container ${e?.sensitive?"":"hidden"}">\n          <label class="block text-sm font-medium text-gray-700 mb-1">Nivel cifrado</label>\n          <select class="field-encryption-level w-full px-3 py-2 border border-gray-300 rounded text-sm">\n            <option value="medium" ${"medium"===e?.encryptionLevel?"selected":""}>Medio</option>\n            <option value="high" ${"high"===e?.encryptionLevel?"selected":""}>Alto</option>\n          </select>\n        </div>\n      </div>\n    </div>\n      `}async showTemplateForm(e=null){const t=document.getElementById("templateContent");t&&(e?(this.editingTemplate=await L.getTemplateById(e),this.tempFormData=null,t.innerHTML=this.renderTemplateForm(this.editingTemplate)):this.tempFormData?(this.editingTemplate=null,t.innerHTML=this.renderTemplateForm(this.tempFormData)):(this.editingTemplate=null,this.tempFormData=null,t.innerHTML=this.renderTemplateForm()),this.setupTemplateFormListeners())}setupTemplateFormListeners(){const e=document.getElementById("templateCategory"),t=document.getElementById("templateIcon");e&&t&&e.addEventListener("change",e=>{t.value=$(e.target.value)}),document.getElementById("addFieldBtn")?.addEventListener("click",()=>this.addField());const n=document.getElementById("fieldsContainer");n&&(n.addEventListener("click",e=>{e.target.closest(".remove-field")&&(e.target.closest(".field-item").remove(),this.updateNoFieldsMessage())}),n.addEventListener("change",e=>{e.target.closest(".field-sensitive")&&e.target.closest(".field-item").querySelector(".encryption-level-container")?.classList.toggle("hidden",!e.target.checked)})),document.getElementById("cancelTemplate")?.addEventListener("click",()=>this.loadTemplates()),document.getElementById("previewTemplate")?.addEventListener("click",()=>this.previewTemplate()),document.getElementById("templateForm")?.addEventListener("submit",e=>{e.preventDefault(),this.saveTemplate()}),n.addEventListener("change",e=>{if(e.target.classList.contains("field-type")){const t=e.target.closest(".field-item").querySelector(".options-input-group");"select"===e.target.value?(t.classList.remove("hidden"),t.querySelector(".field-options").setAttribute("required","required")):(t.classList.add("hidden"),t.querySelector(".field-options").removeAttribute("required"))}}),this.setupFieldValidation(),this.initializeSortable()}initializeSortable(){const e=document.getElementById("fieldsContainer");e&&"undefined"!=typeof Sortable&&new Sortable(e,{animation:150,handle:".drag-handle",ghostClass:"sortable-ghost",onEnd:e=>{}})}addField(){const e=document.getElementById("fieldsContainer");if(e){const t=e.querySelectorAll(".field-item").length;e.insertAdjacentHTML("beforeend",this.renderFieldForm(null,t)),document.getElementById("noFieldsMessage")?.classList.add("hidden")}}updateNoFieldsMessage(){const e=document.getElementById("fieldsContainer");e&&0===e.querySelectorAll(".field-item").length&&document.getElementById("noFieldsMessage")?.classList.remove("hidden")}collectFormData(){const e=document.getElementById("templateName")?.value||"",t=document.getElementById("templateDescription")?.value||"",n=document.getElementById("templateIcon")?.value||"üìã",s=document.getElementById("templateColor")?.value||"#3B82F6",a=document.getElementById("allowDuplicates")?.checked||!1,r=parseInt(document.getElementById("maxEntries")?.value)||0,i=document.getElementById("templateCategory")?.value||"custom";if(!e.trim())throw new Error("El nombre de la plantilla es requerido.");const o=[],l=document.querySelectorAll("#fieldsContainer .field-item");if(0===l.length)throw new Error("La plantilla debe tener al menos un campo.");return l.forEach((e,t)=>{const n=e.querySelector(".field-label")?.value||"",s=e.querySelector(".field-type")?.value||"string";if(!n.trim())throw new Error(`Campo ${t+1}: Nombre requerido`);const a=S(n,t),r=e.querySelector(".field-sensitive")?.checked||!1;let i=[];if("select"===s){const t=e.querySelector(".field-options").value;if(!t)throw new Error(`El campo '${fieldTitle}' de tipo Selecci√≥n Simple requiere opciones.`);i=t.split(",").map(e=>e.trim()).filter(e=>e.length>0)}o.push({id:a,label:n.trim(),type:s,order:t+1,placeholder:e.querySelector(".field-placeholder")?.value||"",required:e.querySelector(".field-required")?.checked||!1,sensitive:r,encryptionLevel:r?e.querySelector(".field-encryption-level")?.value||"medium":void 0,...i.length>0&&{options:i}})}),{name:e.trim(),description:t.trim(),icon:n,color:s,fields:o,settings:{allowDuplicates:a,maxEntries:r,category:i,isSystemTemplate:!1}}}async saveTemplate(){try{const e=document.querySelector('#templateForm button[type="submit"]');e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Procesando...');const t=this.collectFormData();this.editingTemplate?(await L.updateTemplate(this.editingTemplate.id,t),this.showSuccess("‚úÖ Plantilla actualizada correctamente")):(await L.createTemplate(t),this.showSuccess("‚úÖ Plantilla creada correctamente")),setTimeout(()=>this.loadTemplates(),1500)}catch(e){this.showError(e.message);const t=document.querySelector('#templateForm button[type="submit"]');t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-save mr-2"></i> '+(this.editingTemplate?"Actualizar Plantilla":"Crear Plantilla"))}}async editTemplate(e){await this.showTemplateForm(e)}async deleteTemplate(e){if(confirm("¬øEst√°s seguro de que deseas eliminar esta plantilla? Esta acci√≥n es irreversible."))try{await L.deleteTemplate(e),this.showSuccess("‚úÖ Plantilla eliminada correctamente"),this.loadTemplates()}catch(t){this.showError("Error al eliminar: "+t.message)}}async previewTemplate(){try{this.tempFormData=this.collectFormData(),this.showTemplatePreviewData(this.tempFormData)}catch(e){this.showError(e.message)}}async showTemplatePreview(e){try{const t=await L.getTemplateById(e);if(!t)throw new Error("Plantilla no encontrada para previsualizar.");this.showTemplatePreviewData(t)}catch(t){this.showError("Error al cargar vista previa: "+t.message)}}showTemplatePreviewData(e){const t=document.getElementById("templateContent");t&&(t.innerHTML=`\n        <div class="max-w-4xl mx-auto">\n             <div class="mb-6"><h3 class="text-xl font-bold text-gray-800"><i class="fas fa-eye mr-2"></i>Vista Previa de Plantilla</h3></div>\n             <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">\n                <div class="flex items-center"><div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl mr-4" style="background-color:${e.color}20;color:${e.color}">${e.icon}</div>\n                <div><h4 class="font-bold text-gray-800">${e.name}</h4><p class="text-gray-600">${e.description}</p></div></div>\n             </div>\n             <div class="bg-white border border-gray-200 rounded-lg p-6">\n                <h4 class="font-semibold text-gray-800 mb-4">Formulario Ejemplo</h4>\n                <div class="space-y-4">${e.fields.map(e=>this.renderFieldPreview(e)).join("")}</div>\n             </div>\n             <div class="flex justify-between pt-4">\n               <button id="backToForm" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg transition">\n                  <i class="fas fa-arrow-left mr-2"></i> Volver a Editar\n               </button>\n               <button id="saveFromPreview" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition">\n                  <i class="fas fa-save mr-2"></i> Guardar Plantilla\n               </button>\n             </div>\n        </div>\n      `,document.getElementById("backToForm")?.addEventListener("click",()=>this.showTemplateForm(this.editingTemplate?.id)),document.getElementById("saveFromPreview")?.addEventListener("click",()=>{this.showTemplateForm(this.editingTemplate?.id),setTimeout(()=>document.getElementById("templateForm")?.requestSubmit(),50)}))}renderFieldPreview(e){const t=k(e.type);let n;if("select"===e.type){n=`<div class="p-3 bg-gray-100 border border-gray-200 rounded-lg">${(e.options||[]).map(e=>`<span class="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded">${e}</span>`).join(" ")}</div>`}else n=`\n            <input disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700" \n                   placeholder="${e.placeholder||"Campo de tipo: "+t}" \n                   value="">\n        `;return`\n        <div class="mb-4">\n           <label class="block text-sm font-medium text-gray-700">\n             ${e.label} \n             ${e.required?'<span class="text-red-600 ml-1 font-bold" title="Campo Obligatorio">*</span>':""}\n             ${e.sensitive?'<i class="fas fa-lock text-red-500 ml-1" title="Campo Sensible"></i>':""}\n           </label>\n           ${n} </div>\n      `}async filterTemplatesByCategory(e){if(this.currentCategory===e)return;this.currentCategory=e;const t=await L.getCategories(),n="all"===e?this.allTemplates:this.allTemplates.filter(t=>t.settings.category===e),s=document.getElementById("templateContent");s&&(s.innerHTML=this.renderTemplateList(n,t),this.setupTemplateListListeners());const a=C(e);this.showMessage(`Mostrando ${n.length} plantilla${1!==n.length?"s":""} en categor√≠a: ${a}`,"info",3e3)}showMessage(e,t="info",n=3e3){const s=document.createElement("div");s.className="fixed bottom-4 right-4 z-50 px-4 py-3 rounded text-white shadow-lg "+("error"===t?"bg-red-500":"success"===t?"bg-green-500":"bg-blue-500"),s.innerHTML=e,document.body.appendChild(s),setTimeout(()=>s.remove(),n)}showSuccess(e){this.showMessage(e,"success")}showError(e){this.showMessage(e,"error",5e3)}setupFieldValidation(){document.querySelectorAll(".field-label").forEach(e=>{e.addEventListener("blur",()=>{this.validateFieldLabel(e)}),e.addEventListener("input",()=>{this.clearFieldError(e)})})}validateFieldLabel(e){const t=e.value.trim();return t?t.length<2?(this.showFieldError(e,"El nombre debe tener al menos 2 caracteres"),!1):(this.clearFieldError(e),!0):(this.showFieldError(e,"El nombre del campo es requerido"),!1)}showFieldError(e,t){this.clearFieldError(e),e.classList.add("border-red-500","bg-red-50");const n=document.createElement("div");n.className="text-red-600 text-xs mt-1",n.textContent=t,n.id=`error-${e.id||e.name||e.classList[0]}`,e.parentNode.appendChild(n)}clearFieldError(e){e.classList.remove("border-red-500","bg-red-50");const t=`error-${e.id||e.name||e.classList[0]}`,n=document.getElementById(t);n&&n.remove()}}async function P(e,t){e?(D(e,t),L.initialize(e.uid).catch(e=>{}),await B(e)):function(e){const t=new y(e=>{});e.innerHTML='\n    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center p-4">\n      <div class="w-full max-w-lg">\n        <div class="text-center mb-8">\n          <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-4">\n            <i class="fas fa-shield-alt text-3xl text-blue-600"></i>\n          </div>\n          <h1 class="text-3xl font-bold text-gray-800 mb-2">Mi Gesti√≥n</h1>\n          <p class="text-gray-600">Protege tu informaci√≥n personal con cifrado de extremo a extremo</p>\n        </div>\n        \n        <div id="authContainer"></div>\n        \n        <div class="mt-8 text-center text-sm text-gray-500">\n          <p>\n            <i class="fas fa-lock mr-1"></i>\n            Tus datos nunca salen de tu dispositivo cifrados\n          </p>\n          <p class="mt-1">\n            <i class="fas fa-user-shield mr-1"></i>\n            Solo t√∫ puedes acceder a tu informaci√≥n\n          </p>\n        </div>\n      </div>\n    </div>\n  ';const n=document.getElementById("authContainer");n&&t.updateView(n)}(t)}async function B(e){setTimeout(async()=>{if(!f.isReady()){const t=new v(async e=>{try{return await b.initializeEncryption(e),!0}catch(t){return!1}},e.email);setTimeout(()=>{t.show()},500)}},1e3)}function D(e,t){t.innerHTML=`\n    <div class="min-h-screen bg-gray-50">\n      \x3c!-- Navbar --\x3e\n      <nav class="bg-white shadow-sm">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16">\n            <div class="flex items-center">\n              <div class="flex items-center">\n                <i class="fas fa-shield-alt text-xl text-blue-600 mr-3"></i>\n                <h1 class="text-xl font-bold text-gray-800">Mi Gesti√≥n</h1>\n              </div>\n              <div class="hidden md:block ml-10">\n                <div class="flex space-x-4">\n                  <a href="#" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">\n                    <i class="fas fa-home mr-1"></i> Inicio\n                  </a>\n                  <a href="#" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">\n                    <i class="fas fa-database mr-1"></i> Mis Datos\n                  </a>\n                  <a href="#" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">\n                    <i class="fas fa-cogs mr-1"></i> Configuraci√≥n\n                  </a>\n                </div>\n              </div>\n            </div>\n            \n            <div class="flex items-center">\n              <div class="flex items-center space-x-3">\n                <div class="text-right hidden md:block">\n                  <p class="text-sm font-medium text-gray-700">${e.email}</p>\n                  <p class="text-xs text-gray-500">Usuario Premium</p>\n                </div>\n                <div class="relative">\n                  <button id="userMenuButton" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">\n                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium">\n                      ${e.email.charAt(0).toUpperCase()}\n                    </div>\n                    <i class="fas fa-chevron-down text-gray-600"></i>\n                  </button>\n                  \n                  \x3c!-- Dropdown menu --\x3e\n                  <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">\n                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">\n                      <i class="fas fa-user mr-2"></i> Mi Perfil\n                    </a>\n                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">\n                      <i class="fas fa-cog mr-2"></i> Configuraci√≥n\n                    </a>\n                    <div class="border-t border-gray-100"></div>\n                    <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">\n                      <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesi√≥n\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      \x3c!-- Main Content --\x3e\n      <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">\n        <div class="mb-8">\n          <h2 class="text-2xl font-bold text-gray-800">Bienvenido, ${e.email.split("@")[0]}</h2>\n          <p class="text-gray-600">Tu informaci√≥n est√° segura y cifrada</p>\n        </div>\n\n        \x3c!-- Stats Cards --\x3e\n        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">\n          <div class="bg-white rounded-lg shadow p-6">\n            <div class="flex items-center">\n              <div class="p-3 bg-blue-100 rounded-lg">\n                <i class="fas fa-shield-alt text-blue-600 text-xl"></i>\n              </div>\n              <div class="ml-4">\n                <p class="text-sm text-gray-500">Documentos Protegidos</p>\n                <p class="text-2xl font-bold text-gray-800">0</p>\n              </div>\n            </div>\n          </div>\n          \n          <div class="bg-white rounded-lg shadow p-6">\n            <div class="flex items-center">\n              <div class="p-3 bg-green-100 rounded-lg">\n                <i class="fas fa-key text-green-600 text-xl"></i>\n              </div>\n              <div class="ml-4">\n                <p class="text-sm text-gray-500">Cifrado Activo</p>\n                <p class="text-2xl font-bold text-gray-800">E2EE</p>\n              </div>\n            </div>\n          </div>\n          \n          <div class="bg-white rounded-lg shadow p-6">\n            <div class="flex items-center">\n              <div class="p-3 bg-purple-100 rounded-lg">\n                <i class="fas fa-user-shield text-purple-600 text-xl"></i>\n              </div>\n              <div class="ml-4">\n                <p class="text-sm text-gray-500">Sesi√≥n Activa</p>\n                <p class="text-2xl font-bold text-gray-800">Ahora</p>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Quick Actions --\x3e\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">\n          <div class="bg-white rounded-lg shadow p-6">\n            <h3 class="text-lg font-semibold text-gray-800 mb-4">Acciones R√°pidas</h3>\n            <div class="space-y-3">\n              <button class="w-full flex items-center justify-between p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition">\n                <div class="flex items-center">\n                  <i class="fas fa-plus-circle text-blue-600 mr-3"></i>\n                  <span class="font-medium">Agregar Nuevo Dato</span>\n                </div>\n                <i class="fas fa-chevron-right text-gray-400"></i>\n              </button>\n              <button class="w-full flex items-center justify-between p-3 bg-green-50 hover:bg-green-100 rounded-lg transition">\n                <div class="flex items-center">\n                  <i class="fas fa-file-export text-green-600 mr-3"></i>\n                  <span class="font-medium">Crear Backup</span>\n                </div>\n                <i class="fas fa-chevron-right text-gray-400"></i>\n              </button>\n              <button id="initializeEncryptionBtn" class="w-full flex items-center justify-between p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition">\n                <div class="flex items-center">\n                  <i class="fas fa-shield-alt text-purple-600 mr-3"></i>\n                  <span class="font-medium">Activar Cifrado E2EE</span>\n                </div>\n                <i class="fas fa-chevron-right text-gray-400"></i>\n              </button>\n              <button id="manageTemplatesBtn" class="w-full flex items-center justify-between p-3 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition">\n                <div class="flex items-center">\n                  <i class="fas fa-layer-group text-indigo-600 mr-3"></i>\n                  <span class="font-medium">Gestionar Plantillas</span>\n                </div>\n                <i class="fas fa-chevron-right text-gray-400"></i>\n              </button>\n            </div>\n          </div>\n          \n          <div class="bg-white rounded-lg shadow p-6">\n            <h3 class="text-lg font-semibold text-gray-800 mb-4">Estado de Seguridad</h3>\n            <div class="space-y-4">\n              <div>\n                <div class="flex justify-between mb-1">\n                  <span class="text-sm font-medium text-gray-700">Fuerza de Cifrado</span>\n                  <span class="text-sm font-bold text-green-600">100%</span>\n                </div>\n                <div class="w-full bg-gray-200 rounded-full h-2">\n                  <div class="bg-green-600 h-2 rounded-full" style="width: 100%"></div>\n                </div>\n              </div>\n              <div class="flex items-center text-sm">\n                <i class="fas fa-check-circle text-green-500 mr-2"></i>\n                <span class="text-gray-600">Todos tus datos est√°n cifrados localmente</span>\n              </div>\n              <div class="flex items-center text-sm">\n                <i class="fas fa-check-circle text-green-500 mr-2"></i>\n                <span class="text-gray-600">Ning√∫n dato se transmite sin cifrar</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </main>\n    </div>\n  `,"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||(t.innerHTML+='\n      <div class="mt-12 max-w-7xl mx-auto px-4">\n        <div class="border-t border-gray-200 pt-8">\n          <h3 class="text-lg font-semibold text-gray-800 mb-4">\n            <i class="fas fa-flask mr-2"></i>\n            Pruebas de Desarrollo - Cifrado E2EE\n          </h3>\n          <div id="encryptionTestContainer"></div>\n        </div>\n      </div>\n    ',setTimeout(()=>{const e=new x,t=document.getElementById("encryptionTestContainer");t&&(t.innerHTML=e.render(),e.setupEventListeners())},100),L.initialize(e.uid)),function(){const e=document.getElementById("userMenuButton"),t=document.getElementById("userMenu"),n=document.getElementById("logoutButton");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("hidden")}),document.addEventListener("click",()=>{t.classList.add("hidden")}),t.addEventListener("click",e=>{e.stopPropagation()}));n&&n.addEventListener("click",async()=>{try{await b.logout()}catch(e){alert("Error al cerrar sesi√≥n. Intenta nuevamente.")}});const s=document.getElementById("initializeEncryptionBtn");s&&s.addEventListener("click",async()=>{const e=b.getCurrentUser();e&&await B(e)});const a=document.getElementById("manageTemplatesBtn");a&&a.addEventListener("click",()=>{!function(e){const t=document.getElementById("app");if(!t)return;const n=new F(e=>{alert(`Plantilla ${e} seleccionada. Aqu√≠ crear√≠as un nuevo documento.`)});t.innerHTML='\n    <div class="min-h-screen bg-gray-50">\n      \x3c!-- Navbar --\x3e\n      <nav class="bg-white shadow-sm">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16">\n            <div class="flex items-center">\n              <button id="backToDashboard" class="mr-4 text-gray-600 hover:text-blue-600">\n                <i class="fas fa-arrow-left text-lg"></i>\n              </button>\n              <div class="flex items-center">\n                <i class="fas fa-layer-group text-xl text-indigo-600 mr-3"></i>\n                <h1 class="text-xl font-bold text-gray-800">Gesti√≥n de Plantillas</h1>\n              </div>\n            </div>\n          </div>\n        </div>\n      </nav>\n      \n      \x3c!-- Contenido principal --\x3e\n      <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">\n        <div id="templateManagerContainer"></div>\n      </main>\n    </div>\n  ';const s=document.getElementById("templateManagerContainer");s&&(s.innerHTML=n.render(),L.initialize(e.uid),n.loadTemplates());document.getElementById("backToDashboard")?.addEventListener("click",()=>{const e=b.getCurrentUser();e&&D(e,t)})}(b.getCurrentUser())})}()}document.addEventListener("DOMContentLoaded",()=>{!async function(){const e=document.getElementById("app");if(!e)return;b.subscribe(async t=>{await P(t,e)});const t=b.getCurrentUser();await P(t,e)}()}),window.app={initializePostLogin:async function(e,t){await f.initialize(t,e.uid)}};
