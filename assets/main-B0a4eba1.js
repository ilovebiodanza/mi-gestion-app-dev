import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";import{getAuth as t,EmailAuthProvider as n,reauthenticateWithCredential as s,onAuthStateChanged as a,updatePassword as r,sendPasswordResetEmail as i,signOut as o,signInWithEmailAndPassword as l,createUserWithEmailAndPassword as d}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";import{getFirestore as c,writeBatch as u,deleteDoc as p,orderBy as m,query as f,getDocs as h,collection as b,getDoc as g,setDoc as x,doc as v}from"https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const y=e({apiKey:"AIzaSyBJgDqHiHD8mncuRNlw8eA1ismr_fcvj2E",authDomain:"mi-gestion-e2ee.firebaseapp.com",projectId:"mi-gestion-e2ee",storageBucket:"mi-gestion-e2ee.firebasestorage.app",messagingSenderId:"97671435614",appId:"1:97671435614:web:e0f35d92692ca1e63b2bcf",measurementId:"G-GLYJSXBC8E"}),w=t(y),E=c(y);window.firebaseModules={app:y,auth:w,db:E,createUserWithEmailAndPassword:d,signInWithEmailAndPassword:l,signOut:o,sendPasswordResetEmail:i,updatePassword:r,onAuthStateChanged:a,reauthenticateWithCredential:s,EmailAuthProvider:n,getFirestore:c,doc:v,setDoc:x,getDoc:g,collection:b,getDocs:h,query:f,orderBy:m,deleteDoc:p,writeBatch:u};const S={"auth/email-already-exists":"Este correo ya est√° en uso. Intenta iniciar sesi√≥n.","auth/user-not-found":"Usuario no encontrado. Verifica el correo.","auth/wrong-password":"La contrase√±a es incorrecta.","auth/invalid-email":"El formato del correo no es v√°lido.","auth/weak-password":"La contrase√±a debe tener al menos 6 caracteres.","auth/user-disabled":"Esta cuenta ha sido inhabilitada.","auth/too-many-requests":"Demasiados intentos fallidos. Intenta m√°s tarde.","auth/id-token-expired":"Tu sesi√≥n ha expirado. Inicia sesi√≥n de nuevo.","auth/session-cookie-expired":"La cookie de sesi√≥n ha caducado.",default:"Ocurri√≥ un error inesperado. Por favor intenta nuevamente."};const I=new class{constructor(){this.container=document.createElement("div"),this.container.className="fixed top-5 right-5 z-50 flex flex-col gap-3 pointer-events-none",document.body.appendChild(this.container)}show(e,t="error",n=null){const s=e.startsWith("auth/")?S[e]||S.default:e;const a=document.createElement("div");a.className=`${{error:"bg-red-50 border-l-4 border-red-500 text-red-700",success:"bg-green-50 border-l-4 border-green-500 text-green-700",info:"bg-blue-50 border-l-4 border-blue-500 text-blue-700"}[t]} shadow-lg rounded-md p-4 flex flex-col gap-2 transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto min-w-[300px] max-w-md`;let r=`\n      <div class="flex items-center justify-between">\n        <span class="font-medium text-sm flex-1 mr-2">${s}</span>\n        <button class="text-opacity-50 hover:text-opacity-100 focus:outline-none font-bold text-lg leading-none" data-close>\n          &times;\n        </button>\n      </div>\n    `;if(n&&(r+=`\n        <div class="flex justify-end mt-1">\n          <button id="toast-action-btn" class="text-xs font-bold uppercase tracking-wide underline hover:no-underline focus:outline-none transition-colors">\n            ${n.label} &rarr;\n          </button>\n        </div>\n      `),a.innerHTML=r,this.container.appendChild(a),a.querySelector("[data-close]").addEventListener("click",()=>this.remove(a)),n){a.querySelector("#toast-action-btn").addEventListener("click",()=>{n.onClick(),this.remove(a)})}requestAnimationFrame(()=>{a.classList.remove("translate-x-full","opacity-0")});setTimeout(()=>this.remove(a),n?8e3:4e3)}remove(e){e&&(e.classList.add("translate-x-full","opacity-0"),e.addEventListener("transitionend",()=>e.remove(),{once:!0}))}},L="AES-GCM",k="PBKDF2";function $(e){return(new TextEncoder).encode(e)}function T(e){return Array.prototype.map.call(new Uint8Array(e),e=>("00"+e.toString(16)).slice(-2)).join("")}function C(e){return new Uint8Array(e.match(/.{1,2}/g).map(e=>parseInt(e,16)))}async function D(e,t){const n=$(e),s=await window.crypto.subtle.importKey("raw",n,{name:k},!1,["deriveBits","deriveKey"]),a=$(t);return await window.crypto.subtle.deriveKey({name:k,salt:a,iterations:1e5,hash:"SHA-256"},s,{name:L,length:256},!1,["encrypt","decrypt"])}const B=new class{constructor(){this.key=null,this.userId=null,this.isUnlocked=!1}async initialize(e,t){try{this.userId=t;const n=await D(e,t);return this.key=n,this.isUnlocked=!0,!0}catch(n){throw this.lock(),n}}lock(){this.key=null,this.isUnlocked=!1,this.userId=null}isReady(){return!0===this.isUnlocked&&null!==this.key}async decryptDocument(e){if(!this.isReady())throw new Error("La b√≥veda est√° bloqueada. Se requiere contrase√±a.");try{return await async function(e,t){try{if(!e||!e.iv||!e.content)return e;const n=C(e.iv),s=C(e.content),a=await window.crypto.subtle.decrypt({name:L,iv:n},t,s),r=(new TextDecoder).decode(a);return JSON.parse(r)}catch(n){throw new Error("Contrase√±a incorrecta o datos corruptos.")}}(e,this.key)}catch(t){throw this.lock(),new Error("Contrase√±a incorrecta o datos corruptos.")}}async encryptDocument(e,t=null){const n=t||this.key;if(!n)throw new Error("B√≥veda cerrada (Encrypt).");return await async function(e,t){try{const n=$(JSON.stringify(e)),s=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:L,iv:s},t,n);return{iv:T(s),content:T(a)}}catch(n){throw new Error("No se pudo cifrar la informaci√≥n.")}}(e,n)}async deriveTemporaryKey(e){if(!this.userId)throw new Error("Usuario no identificado");return await D(e,this.userId)}setNewMasterKey(e){this.key=e,this.isUnlocked=!0}async validateKey(e){if(!this.userId)return!1;try{return await D(e,this.userId),!0}catch(t){return!1}}};const M=new class{constructor(){this.auth=null,this.db=null,this.user=null,this.observers=[],this.waitForFirebase()}async waitForFirebase(){let e=0;for(;!window.firebaseModules&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if(window.firebaseModules){this.auth=window.firebaseModules.auth,this.db=window.firebaseModules.db;const{onAuthStateChanged:e}=window.firebaseModules;e(this.auth,e=>{this.updateState(e)})}}updateState(e){this.user=e,this.notifyObservers(e)}subscribe(e){this.observers.push(e),null!==this.user&&e(this.user)}notifyObservers(e){this.observers.forEach(t=>t(e))}getCurrentUser(){return this.user}async login(e,t){if(!this.auth)throw new Error("Servicio no inicializado");try{const{signInWithEmailAndPassword:n}=window.firebaseModules,s=await n(this.auth,e,t);return this.updateState(s.user),{success:!0,user:s.user}}catch(n){throw n}}async register(e,t){if(!this.auth)throw new Error("Servicio no inicializado");try{const{createUserWithEmailAndPassword:n}=window.firebaseModules,s=await n(this.auth,e,t);return await this.initializeEncryption(t),this.updateState(s.user),{success:!0,user:s.user}}catch(n){throw n}}async logout(){try{B&&"function"==typeof B.clearKey&&B.clearKey();const{signOut:e}=window.firebaseModules;return await e(this.auth),this.updateState(null),{success:!0}}catch(e){throw e}}async resetPassword(e){if(!this.auth)throw new Error("Servicio no inicializado");try{const{sendPasswordResetEmail:t}=window.firebaseModules;return await t(this.auth,e),{success:!0}}catch(t){throw t}}async initializeEncryption(e){const t=this.user||this.auth?.currentUser;if(!t)throw new Error("Usuario no autenticado (AuthService)");return await B.initialize(e,t.uid)}};class j{constructor(e,t){this.onLoginSuccess=e,this.onError=t,this.isLoginMode=!0}updateView(e){e.innerHTML=this.render(),this.setupEventListeners(e)}render(){return`\n      <div class="flex p-1 mb-8 bg-slate-100 rounded-xl relative">\n        <div class="w-1/2 h-full absolute top-0 bottom-0 rounded-lg bg-white shadow-sm transition-all duration-300 ease-out" \n             style="left: ${this.isLoginMode?"4px":"calc(50% - 4px)"}; width: calc(50%); top: 4px; bottom: 4px;"></div>\n        \n        <button id="tabLogin" class="flex-1 relative z-10 py-2 text-sm font-medium transition-colors ${this.isLoginMode?"text-primary":"text-slate-500 hover:text-slate-700"}">\n          Iniciar Sesi√≥n\n        </button>\n        <button id="tabRegister" class="flex-1 relative z-10 py-2 text-sm font-medium transition-colors ${this.isLoginMode?"text-slate-500 hover:text-slate-700":"text-primary"}">\n          Registrarse\n        </button>\n      </div>\n\n      <form id="authForm" class="space-y-5">\n        <div class="space-y-4">\n          <div class="group">\n            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Correo Electr√≥nico</label>\n            <div class="relative">\n              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">\n                <i class="fas fa-envelope text-slate-400 group-focus-within:text-primary transition-colors"></i>\n              </div>\n              <input type="email" id="email" required \n                class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none text-slate-700 placeholder-slate-400"\n                placeholder="tu@email.com">\n            </div>\n          </div>\n\n          <div class="group">\n            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Contrase√±a</label>\n            <div class="relative">\n              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">\n                <i class="fas fa-lock text-slate-400 group-focus-within:text-secondary transition-colors"></i>\n              </div>\n              <input type="password" id="password" required \n                class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-secondary/50 focus:border-secondary transition-all outline-none text-slate-700 placeholder-slate-400"\n                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">\n            </div>\n          </div>\n        </div>\n\n        <button type="submit" \n          class="w-full py-3.5 px-4 bg-gradient-to-r from-primary to-secondary hover:from-primary-hover hover:to-secondary-hover text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transform transition-all active:scale-[0.98] flex justify-center items-center gap-2">\n          <span>${this.isLoginMode?"Acceder a mi B√≥veda":"Crear Cuenta Segura"}</span>\n          <i class="fas fa-arrow-right text-sm opacity-80"></i>\n        </button>\n        \n        ${this.isLoginMode?'\n          <div class="text-center mt-4">\n            <a href="#" id="forgotPassword" class="text-sm text-slate-500 hover:text-primary transition-colors font-medium">¬øOlvidaste tu contrase√±a?</a>\n          </div>':""}\n      </form>\n    `}setupEventListeners(e){const t=e.querySelector("#authForm"),n=e.querySelector("#tabLogin"),s=e.querySelector("#tabRegister"),a=t=>{this.isLoginMode=t,this.updateView(e)};n?.addEventListener("click",()=>a(!0)),s?.addEventListener("click",()=>a(!1)),t.addEventListener("submit",async e=>{e.preventDefault();const n=t.email.value,s=t.password.value,a=t.querySelector('button[type="submit"]'),r=a.innerHTML;a.disabled=!0,a.innerHTML='<i class="fas fa-circle-notch fa-spin"></i> Procesando...';try{this.isLoginMode?await M.login(n,s):await M.register(n,s),this.onLoginSuccess()}catch(i){a.disabled=!1,a.innerHTML=r,this.onError?this.onError(i):alert(i.message)}}),e.querySelector("#forgotPassword")?.addEventListener("click",t=>{t.preventDefault();const n=e.querySelector("#email").value;n?M.resetPassword(n).then(()=>{alert("Se ha enviado un correo de recuperaci√≥n.")}).catch(e=>{this.onError&&this.onError(e)}):this.onError&&this.onError({code:"auth/missing-email",message:"Falta email"})})}}class A{constructor(e,t){this.onSubmit=e,this.email=t,this.modalElement=null}show(){if(document.getElementById("password-prompt-modal"))return;this.modalElement=document.createElement("div"),this.modalElement.id="password-prompt-modal",this.modalElement.className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm transition-opacity duration-300 animate-fade-in",this.modalElement.innerHTML=`\n      <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 animate-fade-in-up">\n        <div class="h-2 bg-gradient-to-r from-primary via-secondary to-accent"></div>\n        \n        <div class="p-8">\n          <div class="text-center mb-6">\n            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-50 text-primary mb-4 ring-8 ring-indigo-50/50">\n              <i class="fas fa-key text-2xl"></i>\n            </div>\n            <h3 class="text-xl font-bold text-slate-800">Desbloquear B√≥veda</h3>\n            <p class="text-sm text-slate-500 mt-1">Confirma tu identidad para descifrar los datos de <br><span class="font-medium text-slate-700">${this.email}</span></p>\n          </div>\n\n          <form id="promptForm" class="space-y-4">\n            <div class="relative">\n               <input type="password" id="promptPassword" required autofocus\n                class="w-full px-4 py-3 text-center text-lg tracking-widest bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none placeholder-slate-300"\n                placeholder="Contrase√±a Maestra">\n            </div>\n\n            <div id="promptError" class="hidden text-center text-xs font-bold text-red-500 bg-red-50 p-2 rounded-lg border border-red-100">\n              Contrase√±a incorrecta\n            </div>\n\n            <div class="flex gap-3 mt-6">\n              <button type="button" id="btnCancel" class="flex-1 py-2.5 px-4 bg-white border border-slate-200 text-slate-600 font-medium rounded-xl hover:bg-slate-50 hover:text-slate-800 transition-colors">\n                Cancelar\n              </button>\n              <button type="submit" id="btnUnlock" class="flex-1 py-2.5 px-4 bg-primary hover:bg-primary-hover text-white font-bold rounded-xl shadow-lg shadow-indigo-500/20 transition-all active:scale-95">\n                Desbloquear\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    `,document.body.appendChild(this.modalElement);const e=this.modalElement.querySelector("#promptForm"),t=this.modalElement.querySelector("#promptPassword"),n=this.modalElement.querySelector("#btnCancel"),s=this.modalElement.querySelector("#btnUnlock"),a=this.modalElement.querySelector("#promptError");t.focus(),n.addEventListener("click",()=>this.close()),e.addEventListener("submit",async e=>{e.preventDefault();const n=t.value;s.disabled=!0,s.innerHTML='<i class="fas fa-circle-notch fa-spin"></i>',t.disabled=!0,a.classList.add("hidden");await this.onSubmit(n)?(s.classList.remove("bg-primary","hover:bg-primary-hover"),s.classList.add("bg-emerald-500"),s.innerHTML='<i class="fas fa-check"></i>',setTimeout(()=>this.close(),500)):(a.classList.remove("hidden"),a.classList.add("animate-pulse"),t.value="",t.disabled=!1,t.focus(),s.disabled=!1,s.textContent="Desbloquear")})}close(){this.modalElement&&(this.modalElement.style.opacity="0",setTimeout(()=>{this.modalElement.remove(),this.modalElement=null},300))}}const q=new class{constructor(){if(!window.firebaseModules)throw new Error("Firebase no est√° inicializado. Recarga la p√°gina.");this.modules=window.firebaseModules,this.auth=this.modules.auth,this.db=this.modules.db,this.app=this.modules.app}_cleanObject(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map(e=>this._cleanObject(e));const t={};for(const n in e)if(e.hasOwnProperty(n)){const s=e[n];void 0!==s&&(t[n]=this._cleanObject(s))}return t}getAuth(){return this.auth}getFirestore(){return this.db}getApp(){return this.app}async createUser(e,t){return this.modules.createUserWithEmailAndPassword(this.auth,e,t)}async signIn(e,t){return this.modules.signInWithEmailAndPassword(this.auth,e,t)}async signOut(){return this.modules.signOut(this.auth)}async resetPassword(e){return this.modules.sendPasswordResetEmail(this.auth,e)}async updatePassword(e,t){return this.modules.updatePassword(e,t)}onAuthStateChanged(e){return this.modules.onAuthStateChanged(this.auth,e)}getDoc(e){return this.modules.getDoc(e)}setDoc(e,t,n){const s=this._cleanObject(t);return this.modules.setDoc(e,s,n)}deleteDoc(e){return this.modules.deleteDoc(e)}doc(e){return this.modules.doc(this.db,e)}};class N{constructor(e,t="mi-gestion-v1"){this.userId=e,this.appId=t}async loadFromLocalStorage(){const e=`user_templates_${this.userId}`,t=localStorage.getItem(e);return t?JSON.parse(t):[]}async saveToLocalStorage(e){try{if(!this.userId)return;const t=`user_templates_${this.userId}`;localStorage.setItem(t,JSON.stringify(e))}catch(t){}}getTemplatesRef(){if(!this.userId)throw new Error("ID de usuario no definido para Firestore.");return q.doc(`users/${this.userId}/templates/config`)}async loadFromFirestore(){try{const e=this.getTemplatesRef(),t=await q.getDoc(e);if(t.exists()){const e=t.data();return e.templates||[]}return[]}catch(e){return null}}async saveToFirestore(e){try{if(!this.userId)return;const t=this.getTemplatesRef(),n={updatedAt:(new Date).toISOString(),count:e.length,templates:e};await q.setDoc(t,n,{merge:!0}),await this.saveToLocalStorage(e)}catch(t){throw t}}async checkSyncStatus(e){if(!this.userId)return{synced:!1,error:"Usuario no autenticado"};try{const t=this.getTemplatesRef(),n=await q.getDoc(t);if(n.exists()){const t=n.data(),s=t.templates||[];return{synced:s.length===e.length,localCount:e.length,cloudCount:s.length,cloudTemplates:s,lastUpdated:t.updatedAt,needsSync:s.length!==e.length}}return{synced:!1,localCount:e.length,cloudCount:0,needsSync:!0,cloudTemplates:[]}}catch(t){return{synced:!1,error:t.message}}}}const P=[{value:"string",label:"Texto Breve",inputType:"text",icon:"fas fa-font",description:"Nombres, t√≠tulos o datos cortos."},{value:"text",label:"Texto Largo / Notas",inputType:"textarea",icon:"fas fa-align-left",description:"Descripciones detalladas o p√°rrafos."},{value:"currency",label:"Moneda / Dinero",inputType:"text",icon:"fas fa-dollar-sign",description:"Importes financieros."},{value:"number",label:"N√∫mero",inputType:"text",icon:"fas fa-hashtag",description:"Cantidades, edades, unidades."},{value:"percentage",label:"Porcentaje",inputType:"text",icon:"fas fa-percent",description:"Valores porcentuales (0-100)."},{value:"boolean",label:"S√≠ / No (Interruptor)",inputType:"checkbox",icon:"fas fa-check-square",description:"Opci√≥n binaria verdadero/falso."},{value:"select",label:"Lista de Opciones",inputType:"select",icon:"fas fa-list-ul",description:"Men√∫ desplegable con opciones predefinidas."},{value:"date",label:"Fecha",inputType:"date",icon:"far fa-calendar-alt",description:"Selector de calendario."},{value:"email",label:"Correo Electr√≥nico",inputType:"email",icon:"fas fa-envelope",description:"Validaci√≥n de formato email."},{value:"url",label:"Enlace Web (URL)",inputType:"url",icon:"fas fa-link",description:"Link a sitio web con etiqueta opcional."},{value:"secret",label:"Dato Sensible (Oculto)",inputType:"password",icon:"fas fa-key",description:"Se visualiza con desenfoque/asteriscos."},{value:"table",label:"Tabla Din√°mica",inputType:"table",icon:"fas fa-table",description:"Lista de √≠tems con columnas personalizadas."},{value:"separator",label:"--- SEPARADOR / T√çTULO ---",inputType:"separator",icon:"fas fa-heading",description:"Divisor visual para organizar secciones."}],F=()=>P;const H=new class{getValidFieldTypes(){return F().map(e=>e.value)}generateFieldId(e,t){if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_$]/g,"_").replace(/_{2,}/g,"_").replace(/^_|_$/g,"");return n&&/^[a-zA-Z_$]/.test(n)?n:`campo_${t+1}`}validateField(e,t){const n=this.getValidFieldTypes();if(!n.includes(e.type))throw new Error(`Tipo de campo inv√°lido: "${e.type}". Tipos v√°lidos: ${n.join(", ")}`);return e.id||(e.id=this.generateFieldId(e.label,t)),"table"===e.type&&e.columns&&Array.isArray(e.columns)&&0!==e.columns.length&&e.columns.forEach((t,s)=>{if(!t.label)throw new Error(`La columna ${s+1} de la tabla '${e.label}' no tiene nombre (etiqueta).`);if(!n.includes(t.type))throw new Error(`Tipo inv√°lido en columna '${t.label}'`);t.id||(t.id=this.generateFieldId(t.label,s))}),void 0===e.sensitive&&(e.sensitive=!1),!0}validateTemplateData(e){if(!e.name)throw new Error("La plantilla debe tener un nombre");if(!e.fields||!Array.isArray(e.fields)||0===e.fields.length)throw new Error("La plantilla debe tener al menos un campo");return e.fields.forEach((e,t)=>{this.validateField(e,t)}),!0}getCategoryName(e){return{personal:"Personal",access:"Accesos",financial:"Financiero",health:"Salud",custom:"Personalizado"}[e]||e}getCategoryIcon(e){return{personal:"üë§",access:"üîê",financial:"üí∞",health:"üè•",custom:"üìã"}[e]||"üìÑ"}};const O=new class{constructor(){this.userId=null,this.appId="mi-gestion-v1",this.userTemplates=[],this.isInitialized=!1,this.storage=null}async initialize(e){this.isInitialized&&this.userId===e||(this.userId=e,this.storage=new N(e,this.appId),await this.loadUserTemplates(),this.isInitialized=!0)}async loadUserTemplates(){try{if(!this.userId)return void(this.userTemplates=[]);let e=await this.storage.loadFromFirestore();null===e&&(e=await this.storage.loadFromLocalStorage()),e&&0!==e.length||(e=this.getDefaultTemplates(),await this.storage.saveToFirestore(e)),this.userTemplates=e}catch(e){this.userTemplates=this.getDefaultTemplates()}}async createTemplate(e){if(!this.userId)throw new Error("Usuario no autenticado");H.validateTemplateData(e);const t={id:`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:this.userId,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),...e,settings:{allowDuplicates:!1,maxEntries:0,category:"custom",...e.settings,isSystemTemplate:!1}};return this.userTemplates.push(t),await this.storage.saveToFirestore(this.userTemplates),t}async updateTemplate(e,t){const n=this.userTemplates.findIndex(t=>t.id===e);if(-1===n)throw new Error("Plantilla no encontrada");const s={...this.userTemplates[n],...t};return H.validateTemplateData(s),this.userTemplates[n]={...s,updatedAt:(new Date).toISOString()},await this.storage.saveToFirestore(this.userTemplates),this.userTemplates[n]}async deleteTemplate(e){const t=this.userTemplates.length;if(this.userTemplates=this.userTemplates.filter(t=>t.id!==e),this.userTemplates.length===t)throw new Error("Plantilla no encontrada");return await this.storage.saveToFirestore(this.userTemplates),{success:!0,message:"Plantilla eliminada"}}async exportTemplate(e){const t=await this.getTemplateById(e);if(!t)throw new Error("Plantilla no encontrada");const{id:n,userId:s,createdAt:a,updatedAt:r,...i}=t;return i}async importTemplate(e){return await this.createTemplate(e)}async getUserTemplates(){if(!this.isInitialized)throw new Error("Servicio no inicializado");return 0===this.userTemplates.length?this.getDefaultTemplates():this.userTemplates}async getTemplateById(e){return this.userTemplates.find(t=>t.id===e)||null}async getCategories(){const e=await this.getUserTemplates();return[...new Set(e.map(e=>e.settings.category))].map(t=>({id:t,count:e.filter(e=>e.settings.category===t).length}))}getDefaultTemplates(){return[{id:"tpl_default_access",name:"Accesos y Contrase√±as",description:"Gesti√≥n segura de credenciales",icon:"üîê",color:"#F59E0B",settings:{category:"access",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_site",label:"Sitio / Aplicaci√≥n",type:"string",order:1,required:!0},{id:"f_user",label:"Usuario / Email",type:"string",order:2,required:!1},{id:"f_pass",label:"Contrase√±a",type:"secret",order:3,required:!0},{id:"f_url",label:"URL de acceso",type:"url",order:4,required:!1},{id:"f_notes",label:"Notas adicionales",type:"text",order:5,required:!1}]},{id:"tpl_default_health",name:"Historial M√©dico",description:"Registro b√°sico de salud",icon:"‚öïÔ∏è",color:"#EF4444",settings:{category:"health",allowDuplicates:!1},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_blood",label:"Tipo de Sangre",type:"string",order:1,required:!1},{id:"f_allergies",label:"Alergias",type:"text",order:2,required:!1},{id:"f_meds",label:"Medicaci√≥n Actual",type:"text",order:3,required:!1},{id:"f_contact",label:"Contacto Emergencia",type:"string",order:4,required:!0}]},{id:"tpl_default_finance",name:"Tarjeta de Cr√©dito",description:"Datos de tarjetas bancarias",icon:"üí≥",color:"#10B981",settings:{category:"financial",allowDuplicates:!0},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),fields:[{id:"f_bank",label:"Banco / Emisor",type:"string",order:1,required:!0},{id:"f_number",label:"N√∫mero de Tarjeta",type:"secret",order:2,required:!0},{id:"f_exp",label:"Vencimiento (MM/AA)",type:"string",order:3,required:!0},{id:"f_cvv",label:"CVV",type:"secret",order:4,required:!0},{id:"f_pin",label:"PIN Cajero",type:"secret",order:5,required:!1}]}]}async checkSyncStatus(){return this.storage.checkSyncStatus(this.userTemplates)}async syncTemplates(){const e=await this.storage.checkSyncStatus(this.userTemplates);if(e.needsSync){if(e.cloudCount>e.localCount)return this.userTemplates=e.cloudTemplates,await this.storage.saveToLocalStorage(this.userTemplates),{synced:!0,message:`Descargadas ${e.cloudCount} plantillas.`};if(e.localCount>e.cloudCount)return await this.storage.saveToFirestore(this.userTemplates),{synced:!0,message:`Subidas ${e.localCount} plantillas.`}}return{synced:!0,message:"Sincronizado."}}},_=Object.freeze(Object.defineProperty({__proto__:null,templateService:O},Symbol.toStringTag,{value:"Module"})),R={"es-VE":{moneda:"Bol√≠var",codigo:"VES"},"es-ES":{moneda:"Euro",codigo:"EUR"},"en-US":{moneda:"D√≥lar USD",codigo:"USD"},"en-GB":{moneda:"Libra",codigo:"GBP"},"fr-FR":{moneda:"Euro",codigo:"EUR"},"es-AR":{moneda:"Peso Arg",codigo:"ARS"},"es-CO":{moneda:"Peso Col",codigo:"COP"},"es-MX":{moneda:"Peso Mex",codigo:"MXN"},es:{moneda:"D√≥lar USD",codigo:"USD"},"es-419":{moneda:"D√≥lar USD",codigo:"USD"}},z=()=>{const e=navigator.language;if(R[e])return{locale:e,...R[e]};const t=e.split("-")[0];return R[t]?{locale:t,...R[t]}:{locale:"en-US",...R["en-US"]}},V=(e,t)=>{if(!e||"string"!=typeof e)return`campo_${t+1}`;const n=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"");return n.length<2||/^\d/.test(n)?`campo_${t+1}_${n}`:n},U=e=>({personal:"Personal",access:"Accesos / Claves",financial:"Financiero",health:"Salud",home:"Hogar",car:"Veh√≠culo",job:"Laboral",education:"Educaci√≥n",custom:"Personalizado",all:"Todas"}[e]||"Otros"),J=e=>({personal:"üë§",access:"üîê",financial:"üí≥",health:"‚ù§Ô∏è",home:"üè†",car:"üöó",job:"üíº",education:"üéì",custom:"‚ö°",all:"üìÇ"}[e]||"üìã");class G{constructor(e){this.handlers=e}render(e,t,n){const s=e.filter(e=>!e.settings?.isSystemTemplate),a=t.map(e=>{const t=e.id===n;return`\n        <button class="flex items-center px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border cursor-pointer whitespace-nowrap ${t?"bg-slate-800 text-white border-slate-800 shadow-lg shadow-slate-200 scale-105":"bg-white text-slate-600 border-slate-200 hover:border-primary/50 hover:bg-slate-50 hover:text-slate-800"} category-filter" data-category="${e.id}">\n            <span class="mr-2 text-lg">${J(e.id)}</span>\n            ${U(e.id)}\n            <span class="ml-2 ${t?"bg-white/20":"bg-slate-100 text-slate-500"} px-2 py-0.5 rounded-full text-xs transition-colors">\n                ${e.count}\n            </span>\n        </button>`}).join(""),r="all"===n;return`\n      <div class="animate-fade-in space-y-8">\n        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">\n            <div class="flex items-center gap-4">\n              <div class="p-3 bg-white rounded-xl shadow-sm border border-slate-100">\n                <i class="fas fa-swatchbook text-2xl text-indigo-600"></i>\n              </div>\n              <div>\n                <h2 class="text-2xl font-bold text-slate-800">Mis Plantillas</h2>\n                <p class="text-slate-500 text-sm">Dise√±a las estructuras para tus datos.</p>\n              </div>\n            </div>\n            \n            <div class="flex gap-3 w-full md:w-auto">\n              <input type="file" id="importTemplateInput" accept=".json" class="hidden" />\n              <button id="btnImportTemplate" class="flex-1 md:flex-none px-4 py-2.5 bg-white border border-slate-200 text-slate-700 hover:text-indigo-600 hover:border-indigo-200 font-medium rounded-xl transition shadow-sm flex items-center justify-center gap-2">\n                <i class="fas fa-file-import"></i> <span>Importar</span>\n              </button>\n              <button id="btnNewTemplate" class="flex-1 md:flex-none px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2">\n                <i class="fas fa-plus"></i> <span>Nueva Plantilla</span>\n              </button>\n            </div>\n        </div>\n\n        <div class="flex space-x-3 overflow-x-auto pb-4 no-scrollbar">\n            ${`\n        <button class="flex items-center px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border cursor-pointer whitespace-nowrap category-filter ${r?"bg-slate-800 text-white border-slate-800 shadow-lg":"bg-white text-slate-600 border-slate-200 hover:bg-slate-50"}" data-category="all">\n            <span class="mr-2 text-lg">üí†</span> Todas\n            <span class="ml-2 ${r?"bg-white/20":"bg-slate-100 text-slate-500"} px-2 py-0.5 rounded-full text-xs">${e.length}</span>\n        </button>\n    `}\n            ${a}\n        </div>\n\n        <div id="customTemplatesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">\n            ${s.map(e=>this.renderCard(e)).join("")}\n        </div>\n        \n        ${0===s.length?'\n            <div class="text-center py-16 bg-white rounded-2xl border border-dashed border-slate-300">\n                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üì≠</div>\n                <p class="text-slate-500 font-medium">No hay plantillas en esta categor√≠a.</p>\n                <button class="mt-4 text-indigo-600 font-medium text-sm hover:underline" onclick="document.querySelector(\'[data-category=all]\').click()">\n                    Ver todas las plantillas\n                </button>\n            </div>\n        ':""}\n      </div>`}renderCard(e){const t=e.fields.length,n=`background-color: ${e.color}15; color: ${e.color}`;return`\n    <div class="template-card group relative bg-white border border-slate-200 rounded-2xl p-5 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer overflow-hidden" \n         data-template-id="${e.id}">\n      \n      <div class="absolute top-0 left-0 right-0 h-1" style="background-color: ${e.color}"></div>\n\n      <div class="flex justify-between items-start mb-4">\n          <div class="flex items-center gap-4">\n            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-inner border border-slate-50" style="${n}">\n                ${e.icon||"üìã"}\n            </div>\n            <div>\n                <h4 class="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition-colors">${e.name}</h4>\n                <div class="flex items-center text-xs text-slate-500 mt-1">\n                    <span class="bg-slate-100 px-2 py-0.5 rounded uppercase tracking-wider font-semibold mr-2">${U(e.settings?.category)}</span>\n                </div>\n            </div>\n          </div>\n          \n          <div class="flex flex-col gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity duration-200 absolute top-4 right-4 sm:relative sm:top-auto sm:right-auto bg-white sm:bg-transparent shadow-sm sm:shadow-none rounded-lg p-1 sm:p-0 border sm:border-0 border-slate-100">\n              <button class="edit-template w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition" title="Editar Estructura">\n                <i class="fas fa-pencil-alt"></i>\n              </button>\n              <button class="export-template w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 transition" title="Exportar JSON">\n                <i class="fas fa-file-export"></i>\n              </button>\n              <button class="delete-template w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 transition" title="Eliminar">\n                <i class="fas fa-trash-alt"></i>\n              </button>\n          </div>\n      </div>\n      \n      <p class="text-sm text-slate-500 mb-6 line-clamp-2 h-10 leading-relaxed">\n        ${e.description||"Sin descripci√≥n disponible."}\n      </p>\n\n      <div class="flex items-center justify-between pt-4 border-t border-slate-100">\n        <div class="text-xs font-medium text-slate-400 flex items-center">\n            <i class="fas fa-layer-group mr-1.5"></i> ${t} Campos\n        </div>\n        <button class="use-template-btn px-4 py-2 bg-slate-50 hover:bg-indigo-600 hover:text-white text-indigo-600 text-sm font-bold rounded-lg transition-colors">\n            Usar Plantilla\n        </button>\n      </div>\n    </div>`}setupListeners(e){e.querySelector("#btnNewTemplate")?.addEventListener("click",this.handlers.onNew);const t=e.querySelector("#importTemplateInput");e.querySelector("#btnImportTemplate")?.addEventListener("click",()=>t.click()),t?.addEventListener("change",e=>{e.target.files.length&&this.handlers.onImport(e.target.files[0])}),e.querySelectorAll(".category-filter").forEach(e=>{e.addEventListener("click",e=>this.handlers.onFilter(e.currentTarget.dataset.category))}),e.addEventListener("click",e=>{if(e.target.closest(".use-template-btn")){e.stopPropagation();const t=e.target.closest(".template-card");return void(t&&this.handlers.onSelect(t.dataset.templateId))}const t=e.target.closest(".edit-template");if(t){e.stopPropagation();const n=t.closest(".template-card");return void this.handlers.onEdit(n.dataset.templateId)}const n=e.target.closest(".delete-template");if(n){e.stopPropagation();const t=n.closest(".template-card");return void this.handlers.onDelete(t.dataset.templateId)}const s=e.target.closest(".export-template");if(s){e.stopPropagation();const t=s.closest(".template-card");return void this.handlers.onExport(t.dataset.templateId)}const a=e.target.closest(".template-card");a&&!e.target.closest("button")&&this.handlers.onSelect(a.dataset.templateId)})}}function W(e=null,t=0){const n=e?.id||V(e?.label||`campo_${t+1}`,t),s=F(),a="separator"===e?.type,r=a?"bg-slate-50 border-slate-300 shadow-inner":"bg-white border-slate-200 hover:shadow-lg hover:border-primary/50",i="table"===e?.type&&e.columns?e.columns.length:0,o="table"===e?.type?JSON.stringify(e.columns):"[]";return`\n    <div class="field-item group relative ${r} border rounded-2xl p-1 transition-all duration-300 hover:z-10" data-field-id="${n}">\n      <div class="flex items-stretch">\n        <div class="w-10 flex flex-col items-center justify-center text-slate-300 cursor-grab active:cursor-grabbing hover:text-indigo-500 drag-handle rounded-l-xl border-r border-slate-200/50 transition-colors">\n            <i class="fas fa-grip-vertical"></i>\n        </div>\n\n        <div class="flex-grow p-4">\n            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-3">\n                <div class="md:col-span-7">\n                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">\n                        ${a?"T√≠tulo de la Secci√≥n":"Etiqueta del Campo"}\n                    </label>\n                    <input type="text" class="field-label w-full px-3 py-2 bg-white/60 border border-slate-200 rounded-lg focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition font-semibold text-slate-700 text-sm" \n                           value="${e?.label||""}" \n                           placeholder="${a?"Ej: Datos Bancarios":"Ej: Usuario"}" required />\n                </div>\n                \n                <div class="md:col-span-5">\n                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Tipo de Dato</label>\n                    <div class="relative">\n                        <select class="field-type w-full px-3 py-2 bg-white border border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none transition appearance-none cursor-pointer text-sm font-medium text-slate-600">\n                            ${s.map(t=>`<option value="${t.value}" ${e?.type===t.value?"selected":""}>${t.label}</option>`).join("")}\n                        </select>\n                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div>\n                    </div>\n                </div>\n            </div>\n\n            <div class="space-y-3 ${a?"hidden":""}">\n                \n                <div class="options-input-group ${"select"===e?.type?"animate-fade-in":"hidden"}">\n                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Opciones (Separadas por coma)</label>\n                    <input type="text" class="field-options w-full px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800 placeholder-amber-800/50 focus:ring-2 focus:ring-amber-200 outline-none" \n                           value="${(e?.options||[]).join(", ")}" placeholder="Opci√≥n A, Opci√≥n B, Opci√≥n C">\n                </div>\n\n                <div class="table-config-group ${"table"===e?.type?"animate-fade-in":"hidden"}">\n                    <input type="hidden" class="field-columns-data" value='${o}'>\n                    <div class="flex items-center justify-between p-3 bg-indigo-50 rounded-xl border border-indigo-100 group-hover:bg-indigo-100/50 transition-colors">\n                        <div class="flex items-center gap-3">\n                            <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center text-indigo-600 shadow-sm border border-indigo-100"><i class="fas fa-table"></i></div>\n                            <div>\n                                <p class="text-sm font-bold text-indigo-900">Estructura de Tabla</p>\n                                <p class="text-xs text-indigo-600 font-medium"><span class="columns-count-badge font-extrabold bg-white px-1.5 rounded text-indigo-800">${i}</span> columnas definidas</p>\n                            </div>\n                        </div>\n                        <button type="button" class="configure-table-btn px-4 py-1.5 bg-white text-indigo-600 text-xs font-bold border border-indigo-200 rounded-lg hover:bg-indigo-600 hover:text-white shadow-sm transition-all transform hover:scale-105">\n                            Configurar\n                        </button>\n                    </div>\n                </div>\n\n                <div class="flex items-center justify-end pt-2">\n                    <label class="flex items-center cursor-pointer select-none group/check p-1.5 rounded-lg hover:bg-slate-50 transition">\n                        <input type="checkbox" class="field-required form-checkbox h-4 w-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 transition" ${e?.required?"checked":""}>\n                        <span class="ml-2 text-xs font-bold text-slate-400 group-hover/check:text-slate-600 transition-colors">Campo Obligatorio</span>\n                    </label>\n                </div>\n            </div>\n            \n            <div class="${a?"block":"hidden"} pt-2 pb-1 text-center opacity-60">\n                <div class="h-px bg-slate-300 w-full flex items-center justify-center">\n                    <span class="bg-slate-200 px-3 py-0.5 rounded text-[10px] text-slate-500 font-bold uppercase tracking-widest">Divisor Visual</span>\n                </div>\n            </div>\n        </div>\n\n        <button type="button" class="remove-field absolute -top-3 -right-3 w-8 h-8 bg-white text-slate-300 hover:text-white hover:bg-red-500 border border-slate-200 hover:border-red-500 rounded-full shadow-md flex items-center justify-center transition-all z-20 opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100">\n            <i class="fas fa-times text-sm"></i>\n        </button>\n      </div>\n    </div>`}class K{constructor(e){this.handlers=e,this.activeFieldItem=null,this.mainSortable=null,this.modalSortable=null}render(e=null){return function(e,t,n=""){const s=t?.settings?.category||"custom",a=t?.icon||"üìã",r=t?.color||"#4F46E5";return`\n      <div class="max-w-4xl mx-auto animate-fade-in-up pb-24 flex flex-col gap-6">\n          \n          <div class="bg-white/90 backdrop-blur-md border border-slate-200 rounded-2xl p-4 shadow-sm sticky top-4 z-40 transition-all">\n            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">\n                <div class="flex items-center">\n                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center mr-4 shadow-lg shadow-indigo-500/20 flex-shrink-0">\n                        <i class="fas fa-${e?"pen-nib":"magic"} text-xl"></i>\n                    </div>\n                    <div>\n                        <h3 class="text-xl font-bold text-slate-800 leading-tight">\n                            ${e?"Editar Plantilla":"Nueva Estructura"}\n                        </h3>\n                        <p class="text-xs text-slate-500 font-medium">Dise√±a los campos de tu documento</p>\n                    </div>\n                </div>\n                <div class="flex gap-3 w-full sm:w-auto">\n                     <button type="button" id="cancelTemplate" class="flex-1 sm:flex-none px-5 py-2.5 bg-white border border-slate-300 text-slate-600 rounded-xl hover:bg-slate-50 hover:text-slate-800 transition font-bold text-sm shadow-sm">\n                        Cancelar\n                     </button>\n                     <button type="button" id="saveTemplateBtnHeader" class="flex-1 sm:flex-none px-6 py-2.5 bg-gradient-to-r from-primary to-secondary hover:from-primary-hover hover:to-secondary-hover text-white rounded-xl shadow-lg shadow-indigo-500/30 transition transform active:scale-95 font-bold text-sm flex items-center justify-center gap-2">\n                          <i class="fas fa-save"></i> <span>Guardar</span>\n                     </button>\n                </div>\n            </div>\n          </div>\n          \n          <form id="templateForm" class="space-y-6">\n              \n              <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100">\n                  <div class="flex items-center gap-2 mb-6 border-b border-slate-100 pb-4">\n                     <i class="fas fa-info-circle text-indigo-400"></i>\n                     <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Informaci√≥n B√°sica</h4>\n                  </div>\n\n                  <div class="grid grid-cols-1 md:grid-cols-12 gap-6">\n                      <div class="md:col-span-8">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Nombre</label>\n                          <input type="text" id="templateName" value="${t?.name||""}" \n                                 class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition text-slate-800 font-bold placeholder-slate-400 text-lg" \n                                 required placeholder="Ej: Tarjeta de Cr√©dito">\n                      </div>\n\n                      <div class="md:col-span-4">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Categor√≠a</label>\n                          <div class="relative">\n                              <select id="templateCategory" class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition appearance-none cursor-pointer font-medium text-slate-700">\n                                  ${[{value:"custom",label:"Personalizado"},{value:"personal",label:"Personal"},{value:"access",label:"Accesos"},{value:"financial",label:"Financiero"},{value:"health",label:"Salud"},{value:"home",label:"Hogar"},{value:"car",label:"Veh√≠culo"},{value:"job",label:"Trabajo"},{value:"education",label:"Formaci√≥n"}].map(e=>`<option value="${e.value}" ${e.value===s?"selected":""}>${e.label}</option>`).join("")}\n                              </select>\n                              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div>\n                          </div>\n                      </div>\n\n                      <div class="md:col-span-3">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Icono</label>\n                          <input type="text" id="templateIcon" value="${a}" \n                                 class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-center text-2xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition" \n                                 placeholder="üìã">\n                      </div>\n                      \n                      <div class="md:col-span-9">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Color de Identidad</label>\n                          <div class="flex items-center gap-3 h-[52px] border border-slate-200 rounded-xl p-2 bg-slate-50">\n                              <input type="color" id="templateColor" value="${r}" class="h-full w-16 rounded-lg cursor-pointer border-none p-0 bg-transparent shadow-sm">\n                              <span class="text-xs text-slate-400 font-medium">Selecciona un color para identificar r√°pidamente esta plantilla.</span>\n                          </div>\n                      </div>\n\n                      <div class="md:col-span-12">\n                          <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Descripci√≥n (Opcional)</label>\n                          <input type="text" id="templateDescription" value="${t?.description||""}" \n                                 class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 outline-none transition text-slate-600" \n                                 placeholder="Describe brevemente el prop√≥sito de este documento...">\n                      </div>\n                  </div>\n              </div>\n              \n              <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 relative min-h-[400px]">\n                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 border-b border-slate-100 pb-6">\n                    <div>\n                        <div class="flex items-center gap-2 mb-1">\n                             <i class="fas fa-layer-group text-secondary"></i>\n                             <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Campos del Documento</h4>\n                        </div>\n                        <p class="text-xs text-slate-400 ml-6">Arrastra desde <i class="fas fa-grip-vertical text-[10px] mx-1"></i> para ordenar.</p>\n                    </div>\n                    <button type="button" id="addFieldBtn" class="w-full sm:w-auto px-5 py-2.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-xl transition font-bold border border-indigo-200 shadow-sm flex items-center justify-center gap-2 group">\n                        <div class="w-5 h-5 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-700 group-hover:scale-110 transition-transform"><i class="fas fa-plus text-[10px]"></i></div>\n                        <span>Agregar Campo</span>\n                    </button>\n                  </div>\n\n                  <div id="fieldsContainer" class="space-y-4">${n}\n                      </div>\n                  \n                  <div id="noFieldsMessage" class="hidden flex flex-col items-center justify-center py-16 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/30 mt-4 transition-all hover:bg-slate-50 hover:border-indigo-200 group cursor-pointer" onclick="document.getElementById('addFieldBtn').click()">\n                      <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm border border-slate-100 group-hover:scale-110 transition-transform duration-300">\n                          <i class="fas fa-plus text-3xl text-slate-300 group-hover:text-indigo-400"></i>\n                      </div>\n                      <p class="text-slate-600 font-bold text-lg">Lienzo Vac√≠o</p>\n                      <p class="text-sm text-slate-400 group-hover:text-indigo-500 transition-colors">Haz clic para agregar tu primer campo</p>\n                  </div>\n              </div>\n          </form>\n      </div>\n      \n      <div id="columnsModal" class="fixed inset-0 z-[60] hidden">\n        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity animate-fade-in" id="closeModalBackdrop"></div>\n        <div class="relative w-full h-full flex items-center justify-center p-4">\n            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh] relative animate-fade-in-up overflow-hidden ring-1 ring-slate-900/5">\n                \n                <div class="px-8 py-6 bg-white border-b border-slate-100 flex justify-between items-center z-10">\n                    <div class="flex items-center gap-4">\n                        <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-lg">\n                            <i class="fas fa-table"></i>\n                        </div>\n                        <div>\n                            <h3 class="text-lg font-bold text-slate-800">Columnas de la Tabla</h3>\n                            <p class="text-xs text-slate-500 font-medium">Define qu√© datos tendr√° cada fila.</p>\n                        </div>\n                    </div>\n                    <button type="button" id="closeModalTop" class="text-slate-400 hover:text-slate-600 bg-slate-50 hover:bg-slate-100 w-8 h-8 rounded-full transition flex items-center justify-center"><i class="fas fa-times"></i></button>\n                </div>\n                \n                <div class="p-8 overflow-y-auto flex-grow bg-slate-50/50 custom-scrollbar">\n                    <div id="modalColumnsContainer" class="space-y-3"></div>\n                    \n                    <div id="noColumnsMessage" class="flex flex-col items-center justify-center py-12 border-2 border-dashed border-slate-300 rounded-2xl bg-white mt-2">\n                         <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 mb-2"><i class="fas fa-columns"></i></div>\n                        <p class="text-slate-500 font-medium text-sm">No hay columnas definidas</p>\n                        <button type="button" id="addColBtnEmpty" class="text-indigo-600 text-sm font-bold hover:underline mt-1">Agregar la primera</button>\n                    </div>\n\n                    <button type="button" id="addColBtn" class="mt-6 w-full py-3.5 border-2 border-dashed border-indigo-200 bg-indigo-50/40 text-indigo-600 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 hover:shadow-sm transition flex items-center justify-center font-bold text-sm gap-2">\n                        <i class="fas fa-plus-circle"></i> Agregar Nueva Columna\n                    </button>\n                </div>\n\n                <div class="px-8 py-5 border-t border-slate-100 flex justify-end space-x-3 bg-white z-10">\n                    <button type="button" id="cancelModalBtn" class="px-5 py-2.5 text-slate-600 font-bold hover:bg-slate-50 rounded-xl transition text-sm">Cancelar</button>\n                    <button type="button" id="saveModalBtn" class="px-6 py-2.5 text-white bg-indigo-600 hover:bg-indigo-700 font-bold rounded-xl shadow-lg shadow-indigo-500/20 transition text-sm flex items-center gap-2">\n                        <i class="fas fa-check"></i> Aplicar Cambios\n                    </button>\n                </div>\n            </div>\n        </div>\n      </div>\n    `}(!!e,e,(e?.fields||[]).map((e,t)=>W(e,t)).join(""))}setupListeners(e){const t=e.querySelector("#templateCategory"),n=e.querySelector("#templateIcon");t&&n&&t.addEventListener("change",e=>n.value=J(e.target.value)),e.querySelector("#addFieldBtn")?.addEventListener("click",()=>this.addField(e)),this.initSortable(e.querySelector("#fieldsContainer"),"main"),this.updateNoFieldsMessage(e);const s=e.querySelector("#fieldsContainer");s&&(s.addEventListener("click",t=>{t.target.closest(".remove-field")&&(t.target.closest(".field-item").remove(),this.updateNoFieldsMessage(e)),t.target.closest(".configure-table-btn")&&this.openColumnsModal(t.target.closest(".field-item"))}),s.addEventListener("change",e=>{if(e.target.classList.contains("field-type")){const t=e.target.closest(".field-item"),n=t.querySelector(".field-label").value,s={id:t.dataset.fieldId,label:n,type:e.target.value,options:[],columns:[],required:!1};t.outerHTML=W(s)}}));const a=e.querySelector("#templateForm");a&&a.addEventListener("submit",e=>{e.preventDefault(),this.saveData()}),e.querySelector("#saveTemplateBtnHeader")?.addEventListener("click",()=>{a&&a.dispatchEvent(new Event("submit"))}),e.querySelector("#cancelTemplate")?.addEventListener("click",()=>this.handlers.onCancel()),this.setupModalListeners()}initSortable(e,t){if(!e||!window.Sortable)return;"main"===t&&this.mainSortable&&(this.mainSortable.destroy(),this.mainSortable=null),"modal"===t&&this.modalSortable&&(this.modalSortable.destroy(),this.modalSortable=null);const n=new window.Sortable(e,{animation:200,handle:".drag-handle",ghostClass:"sortable-ghost",dragClass:"sortable-drag",forceFallback:!0});"main"===t?this.mainSortable=n:this.modalSortable=n}addField(e){const t=e.querySelector("#fieldsContainer"),n=t.querySelectorAll(".field-item").length;t.insertAdjacentHTML("beforeend",W(null,n)),this.updateNoFieldsMessage(e)}updateNoFieldsMessage(e){const t=e.querySelector("#fieldsContainer"),n=e.querySelector("#noFieldsMessage");t&&n&&n.classList.toggle("hidden",t.children.length>0)}setupModalListeners(){const e=document.getElementById("columnsModal");if(!e)return;const t=()=>e.classList.add("hidden"),n=e.querySelector("#closeModalTop"),s=e.querySelector("#cancelModalBtn"),a=e.querySelector("#closeModalBackdrop");n&&(n.onclick=t),s&&(s.onclick=t),a&&(a.onclick=t);const r=()=>{const t=e.querySelector("#modalColumnsContainer"),n=t.querySelectorAll(".field-item").length;t.insertAdjacentHTML("beforeend",W(null,n));const s=t.lastElementChild;[...s.querySelector(".field-type").options].forEach(e=>{"table"!==e.value&&"separator"!==e.value||e.remove()}),s.classList.remove("p-1"),s.classList.add("p-0","border-slate-200");const a=e.querySelector("#noColumnsMessage");a&&a.classList.add("hidden")},i=e.querySelector("#addColBtn"),o=e.querySelector("#addColBtnEmpty");i&&(i.onclick=r),o&&(o.onclick=r);const l=e.querySelector("#modalColumnsContainer");l&&(l.onclick=t=>{if(t.target.closest(".remove-field")&&(t.target.closest(".field-item").remove(),0===l.children.length)){const t=e.querySelector("#noColumnsMessage");t&&t.classList.remove("hidden")}},l.onchange=e=>{if(e.target.classList.contains("field-type")){const t=e.target.closest(".field-item").querySelector(".options-input-group");t&&t.classList.toggle("hidden","select"!==e.target.value)}});const d=e.querySelector("#saveModalBtn");d&&(d.onclick=()=>{const e=this.collectFields(l),n=this.activeFieldItem;if(n){n.querySelector(".field-columns-data").value=JSON.stringify(e);const t=n.querySelector(".columns-count-badge");t&&(t.textContent=e.length)}t()})}openColumnsModal(e){this.activeFieldItem=e;const t=document.getElementById("columnsModal"),n=document.getElementById("modalColumnsContainer"),s=e.querySelector(".field-columns-data");let a=[];try{a=JSON.parse(s.value||"[]")}catch(i){}n.innerHTML="",a.forEach((e,t)=>{n.insertAdjacentHTML("beforeend",W(e,t));const s=n.lastElementChild;s.classList.remove("p-1"),s.classList.add("p-0");if([...s.querySelector(".field-type").options].forEach(e=>{"table"!==e.value&&"separator"!==e.value||e.remove()}),"select"===e.type){const e=s.querySelector(".options-input-group");e&&e.classList.remove("hidden")}}),this.initSortable(n,"modal");const r=t.querySelector("#noColumnsMessage");r&&r.classList.toggle("hidden",a.length>0),t.classList.remove("hidden")}collectFields(e){const t=[];return e.querySelectorAll(".field-item").forEach((e,n)=>{const s=e.querySelector(".field-label"),a=s?s.value.trim():"";if(!a)return;const r=e.querySelector(".field-type"),i=r?r.value:"text",o=e.dataset.fieldId||V(a,n);let l=[];if("select"===i){const t=e.querySelector(".field-options"),n=t?t.value:"";n&&(l=n.split(",").map(e=>e.trim()).filter(e=>e))}let d=[];if("table"===i)try{const t=e.querySelector(".field-columns-data");d=JSON.parse(t?t.value:"[]")}catch(u){}const c=e.querySelector(".field-required");t.push({id:o,label:a,type:i,order:n+1,required:!!c&&c.checked,...l.length&&{options:l},...d.length&&{columns:d}})}),t}saveData(){try{const e=document.getElementById("templateName"),t=e?e.value.trim():"";if(!t)throw new Error("Por favor, asigna un nombre a la plantilla.");const n=this.collectFields(document.getElementById("fieldsContainer"));if(0===n.length)throw new Error("Agrega al menos un campo para guardar la plantilla.");const s={name:t,category:document.getElementById("templateCategory").value,icon:document.getElementById("templateIcon").value,color:document.getElementById("templateColor").value,description:document.getElementById("templateDescription").value,fields:n};this.handlers.onSave(s)}catch(e){alert(e.message)}}}class Z{constructor(e){this.onTemplateSelect=e,this.currentView="list",this.editingTemplateId=null,this.listComponent=new G({onNew:()=>this.setView("create"),onImport:e=>this.handleImport(e),onSelect:e=>this.onTemplateSelect(e),onEdit:e=>this.setView("edit",e),onDelete:e=>this.handleDelete(e),onExport:e=>this.handleExport(e),onFilter:e=>this.loadTemplates(e)}),this.formComponent=new K({onSave:e=>this.handleSave(e),onCancel:()=>this.setView("list")})}render(){return'<div id="templateContent" class="min-h-[500px] w-full animate-fade-in"></div>'}async setView(e,t=null){this.currentView=e,this.editingTemplateId=t;const n=document.getElementById("templateContent");if(n)if("list"!==e||n.querySelector(".template-card")||this.renderLoading(n),"list"===e)await this.loadTemplates();else{let e=null;t&&(n.innerHTML='<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>',e=await O.getTemplateById(t)),n.innerHTML=this.formComponent.render(e),this.formComponent.setupListeners(n)}}async loadTemplates(e="all"){const t=document.getElementById("templateContent");if(t){"list"!==this.currentView&&this.renderLoading(t);try{const n=await O.getUserTemplates(),s=n.reduce((e,t)=>{const n=t.settings?.category||"custom";return e[n]=(e[n]||0)+1,e},{}),a=Object.keys(s).sort((e,t)=>"custom"===e?-1:"custom"===t?1:e.localeCompare(t)).map(e=>({id:e,count:s[e]}));let r=n;"all"!==e&&(r=n.filter(t=>(t.settings?.category||"custom")===e)),t.innerHTML=this.listComponent.render(r,a,e),this.listComponent.setupListeners(t)}catch(n){this.renderError(t,n.message)}}}renderLoading(e){e.innerHTML='\n        <div class="flex flex-col items-center justify-center h-96">\n            <div class="relative">\n                <div class="w-16 h-16 rounded-full border-4 border-indigo-50 border-t-primary animate-spin"></div>\n                <div class="absolute inset-0 flex items-center justify-center">\n                    <i class="fas fa-layer-group text-indigo-300 text-xs"></i>\n                </div>\n            </div>\n            <p class="text-slate-500 font-medium mt-4 animate-pulse">Cargando cat√°logo...</p>\n        </div>'}renderError(e,t){e.innerHTML=`\n        <div class="max-w-md mx-auto mt-10 p-6 bg-red-50 border border-red-100 rounded-2xl text-center">\n            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm text-red-500">\n                <i class="fas fa-wifi-slash"></i>\n            </div>\n            <h3 class="text-red-800 font-bold">Error de Conexi√≥n</h3>\n            <p class="text-red-600 text-sm mt-1">${t}</p>\n            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg hover:bg-red-50 text-sm font-bold transition">Reintentar</button>\n        </div>`}async handleSave(e){try{"edit"===this.currentView&&this.editingTemplateId?await O.updateTemplate(this.editingTemplateId,e):await O.createTemplate(e),this.setView("list")}catch(t){alert("Error: "+t.message)}}async handleDelete(e){if(confirm("¬øEst√°s seguro de eliminar esta plantilla?"))try{await O.deleteTemplate(e),this.loadTemplates()}catch(t){alert("Error: "+t.message)}}async handleExport(e){try{const t=await O.exportTemplate(e),n=`${(t.name||"plantilla").replace(/[^a-z0-9]/gi,"_").toLowerCase()}.json`,s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(t){alert("Error exportando: "+t.message)}}async handleImport(e){if(!e)return;const t=new FileReader;t.onload=async e=>{try{const t=JSON.parse(e.target.result);await O.importTemplate(t),this.loadTemplates()}catch(t){alert("El archivo no es v√°lido.")}},t.readAsText(e)}}const Y=new class{get inputBaseClass(){return"block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 text-sm placeholder-slate-400 focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none"}renderField(e,t=""){if(!e||!e.type)return'<p class="text-red-500 text-xs">Error: Campo sin tipo.</p>';const n=e.required?"required":"",s=(a=e.type,P.find(e=>e.value===a)||P[0]);var a;let r=s?.inputType||"text",i="";if("separator"===r)return`\n            <div class="col-span-1 md:col-span-2 mt-6 mb-2 group animate-fade-in">\n                <div class="flex items-center gap-4">\n                    <h3 class="text-lg font-bold text-slate-700 whitespace-nowrap">${e.label}</h3>\n                    <div class="h-px bg-slate-200 w-full rounded-full"></div>\n                </div>\n            </div>\n        `;if("checkbox"===r)i=`\n        <div class="flex items-center h-full min-h-[50px]">\n          <label class="relative inline-flex items-center cursor-pointer group">\n            <input type="checkbox" id="${e.id}" name="${e.id}" \n                   class="peer sr-only form-checkbox" ${t?"checked":""} />\n            <div class="w-12 h-7 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-emerald-500 transition-colors"></div>\n            <span class="ml-3 text-sm font-medium text-slate-500 group-hover:text-slate-700 transition-colors">Habilitado</span>\n          </label>\n        </div>`;else if("textarea"===r)i=`<textarea id="${e.id}" name="${e.id}" rows="4"\n        class="${this.inputBaseClass} resize-y" \n        placeholder="${e.placeholder||"Escribe aqu√≠..."}" ${n}>${t}</textarea>`;else if("url"===r){let s=t?.url||("string"==typeof t?t:""),a=t?.text||"";i=`\n          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 url-group p-1">\n             <div class="relative group/url">\n               <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Enlace Web</label>\n               <div class="absolute inset-y-0 left-0 pl-4 top-6 flex items-center pointer-events-none text-slate-400 group-focus-within/url:text-blue-500 transition-colors"><i class="fas fa-link text-sm"></i></div>\n               <input type="url" id="${e.id}_url" class="${this.inputBaseClass} pl-11 font-mono text-blue-600" placeholder="https://..." value="${s}" ${n} />\n             </div>\n             <div class="relative group/text">\n               <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Nombre Visible (Opcional)</label>\n               <div class="absolute inset-y-0 left-0 pl-4 top-6 flex items-center pointer-events-none text-slate-400 group-focus-within/text:text-slate-600 transition-colors"><i class="fas fa-font text-sm"></i></div>\n               <input type="text" id="${e.id}_text" class="${this.inputBaseClass} pl-11" placeholder="Ej: Acceso Cliente" value="${a}" />\n             </div>\n          </div>\n        `}else if("select"===r){const s=(e.options||[]).map(e=>`<option value="${e}" ${t===e?"selected":""}>${e}</option>`).join("");i=`\n        <div class="relative group/select">\n          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within/select:text-primary transition-colors"><i class="fas fa-list-ul"></i></div>\n          <select id="${e.id}" name="${e.id}" class="${this.inputBaseClass} appearance-none cursor-pointer pl-11" ${n}>\n            <option value="" disabled ${t?"":"selected"}>Seleccionar opci√≥n...</option>\n            ${s}\n          </select>\n          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-400"><i class="fas fa-chevron-down text-xs"></i></div>\n        </div>`}else if("table"===r){const n=(e.columns||[]).map(e=>`<th class="px-4 py-3 text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-50 border-b border-slate-100 first:rounded-tl-lg">${e.label}</th>`).join(""),s=Array.isArray(t)?t:[],a=JSON.stringify(s).replace(/"/g,"&quot;");i=`\n        <div class="table-input-container w-full overflow-hidden border border-slate-200 rounded-2xl bg-white shadow-sm ring-1 ring-slate-100/50" data-field-id="${e.id}">\n          <input type="hidden" id="${e.id}" name="${e.id}" value="${a}" class="form-table-data">\n          \n          <div class="overflow-x-auto custom-scrollbar">\n            <table class="min-w-full divide-y divide-slate-100">\n              <thead><tr>${n}<th class="w-12 bg-slate-50 border-b border-slate-100 rounded-tr-lg"></th></tr></thead>\n              <tbody class="bg-white divide-y divide-slate-100 table-body"></tbody>\n            </table>\n          </div>\n          <button type="button" class="add-row-btn w-full py-3.5 bg-slate-50 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 font-bold text-xs uppercase tracking-wide transition-colors border-t border-slate-100 flex items-center justify-center gap-2 group">\n            <i class="fas fa-plus-circle group-hover:scale-110 transition-transform"></i> Agregar Registro\n          </button>\n        </div>\n        <script type="application/json" class="columns-def">${JSON.stringify(e.columns||[])}<\/script>\n      `}else if("secret"===e.type)i=`\n        <div class="relative group/pass">\n            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within/pass:text-secondary transition-colors"><i class="fas fa-key"></i></div>\n            <input type="password" id="${e.id}" name="${e.id}" class="${this.inputBaseClass} pl-11 pr-12 font-mono tracking-wider" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="${t}" ${n} />\n            <button type="button" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-secondary cursor-pointer focus:outline-none transition-colors toggle-pass-visibility" tabindex="-1"><i class="fas fa-eye"></i></button>\n        </div>\n        <script>\n            document.currentScript.previousElementSibling.querySelector('.toggle-pass-visibility').onclick = function(e) {\n                const input = e.currentTarget.previousElementSibling;\n                const icon = e.currentTarget.querySelector('i');\n                if(input.type === 'password') { input.type = 'text'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); e.currentTarget.classList.add('text-secondary'); } \n                else { input.type = 'password'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); e.currentTarget.classList.remove('text-secondary'); }\n            };\n        <\/script>\n      `;else{let s=["number","currency","percentage"].includes(e.type)?"text":r,a="",o="";"email"===e.type?a="fa-envelope":"date"===e.type?a="fa-calendar-alt":"currency"===e.type?(a="fa-dollar-sign",o="font-mono text-right"):"percentage"===e.type?(a="fa-percent",o="font-mono text-right"):"number"===e.type&&(a="fa-hashtag",o="font-mono text-right");const l=a?"pl-11":"";i=`<div class="relative group/std">${a?`<div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within/std:text-primary transition-colors"><i class="fas ${a}"></i></div>`:""}<input type="${s}" id="${e.id}" name="${e.id}" class="${this.inputBaseClass} ${l} ${o}" placeholder="${e.placeholder||""}" value="${t}" ${n} /></div>`}return`\n      <div class="field-wrapper ${["table","text","url","textarea","separator"].includes(e.type)?"md:col-span-2":"md:col-span-1"} group animate-fade-in-up">\n        ${"separator"!==r?`<label for="${e.id}" class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2 ml-1 flex items-center justify-between"><span>${e.label}</span>${e.required?'<span class="text-[10px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded border border-red-100 font-bold">REQ</span>':""}</label>`:""}\n        ${i}\n      </div>\n    `}generateFormHtml(e,t={}){return e&&e.fields?e.fields.map(e=>this.renderField(e,t[e.id]||"")).join(""):'<div class="p-4 bg-red-50 text-red-600 rounded-lg">Error: Plantilla da√±ada.</div>'}},X={},Q=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),a=n?.nonce||n?.getAttribute("nonce");s=e(t.map(e=>{if((e=function(e){return"/"+e}(e))in X)return;X[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,a&&s.setAttribute("nonce",a),document.head.appendChild(s),t?new Promise((t,n)=>{s.addEventListener("load",t),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return s.then(t=>{for(const e of t||[])"rejected"===e.status&&a(e.reason);return e().catch(a)})};const ee=new class{constructor(){this.db=null,this.collectionName="documents",setTimeout(()=>{window.firebaseModules&&(this.db=window.firebaseModules.db)},500)}getCollection(){if(!this.db||!window.firebaseModules)throw new Error("Firebase no inicializado");const e=M.getCurrentUser();if(!e)throw new Error("Usuario no autenticado");const{collection:t}=window.firebaseModules;return t(this.db,`users/${e.uid}/${this.collectionName}`)}async listDocuments(){return(await this.getAllDocuments()).map(e=>({id:e.id,templateId:e.templateId,title:e.metadata?.title||"Sin T√≠tulo",updatedAt:e.metadata?.updatedAt||(new Date).toISOString(),createdAt:e.metadata?.createdAt||(new Date).toISOString(),icon:e.metadata?.icon,color:e.metadata?.color,templateName:e.metadata?.templateName,...e}))}async createDocument(e,t,n){const s={title:n||"Nuevo Documento",templateName:e.name,icon:e.icon,color:e.color,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},a=await B.encryptDocument(t),{doc:r,setDoc:i}=window.firebaseModules,o=r(this.getCollection()),l={id:o.id,templateId:e.id,encryptedContent:a,encryptionMetadata:{version:1,algo:"AES-GCM"},metadata:s};return await i(o,l),l}async getAllDocuments(){try{if(!window.firebaseModules)return[];const{getDocs:e,query:t,orderBy:n}=window.firebaseModules,s=t(this.getCollection(),n("metadata.updatedAt","desc"));return(await e(s)).docs.map(e=>({id:e.id,...e.data()}))}catch(e){return[]}}async getDocumentById(e){const{doc:t,getDoc:n}=window.firebaseModules,s=await n(t(this.getCollection(),e));if(!s.exists())throw new Error("No encontrado");return{id:s.id,...s.data()}}async updateDocument(e,t,n,s){const a=await B.encryptDocument(n),r=s||"Documento Actualizado",{doc:i,setDoc:o}=window.firebaseModules,l=i(this.getCollection(),e),d={encryptedContent:a,"metadata.title":r,"metadata.updatedAt":(new Date).toISOString(),"metadata.icon":t.icon,"metadata.color":t.color,"metadata.templateName":t.name};return await o(l,d,{merge:!0}),{id:e,...d}}async deleteDocument(e){const{doc:t,deleteDoc:n}=window.firebaseModules;await n(t(this.getCollection(),e))}async loadDocumentForEditing(e){const t=await this.getDocumentById(e),{templateService:n}=await Q(async()=>{const{templateService:e}=await Promise.resolve().then(()=>_);return{templateService:e}},void 0),s=await n.getTemplateById(t.templateId);if(!s)throw new Error("Plantilla no existe");return{document:t,template:s,formData:await B.decryptDocument(t.encryptedContent),metadata:t.metadata}}async reEncryptAllDocuments(e){const t=await B.deriveTemporaryKey(e),n=await this.getAllDocuments();if(0===n.length)return!0;const{writeBatch:s,doc:a}=window.firebaseModules,r=s(this.db);for(const o of n)try{const e=await B.decryptDocument(o.encryptedContent),n=await B.encryptDocument(e,t),s=a(this.getCollection(),o.id);r.update(s,{encryptedContent:n,"encryptionMetadata.updatedAt":(new Date).toISOString()})}catch(i){throw new Error(`Error integridad doc ${o.id}`)}return await r.commit(),B.setNewMasterKey(t),!0}},te=Object.freeze(Object.defineProperty({__proto__:null,documentService:ee},Symbol.toStringTag,{value:"Module"}));const ne=new class{constructor(){this.modalId="table-row-editor-modal",this.formId="table-row-editor-form",this.onSave=null,this.currentColumns=[],this.renderBase()}renderBase(){if(document.getElementById(this.modalId))return;const e=`\n        <div id="${this.modalId}" class="fixed inset-0 z-[80] hidden">\n            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" id="${this.modalId}-backdrop"></div>\n            \n            <div class="relative w-full h-full flex items-center justify-center p-4">\n                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-100 flex flex-col max-h-[90vh] animate-fade-in-up">\n                    \n                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl">\n                        <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">\n                            <i class="fas fa-edit text-indigo-500"></i> <span id="${this.modalId}-title">Editar Registro</span>\n                        </h3>\n                        <button type="button" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition" id="${this.modalId}-close">\n                            <i class="fas fa-times"></i>\n                        </button>\n                    </div>\n\n                    <div class="p-6 overflow-y-auto custom-scrollbar">\n                        <form id="${this.formId}" class="space-y-5">\n                            </form>\n                    </div>\n\n                    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">\n                        <button type="button" class="px-4 py-2 text-slate-600 font-bold hover:bg-white hover:shadow-sm rounded-lg border border-transparent hover:border-slate-200 transition text-sm" id="${this.modalId}-cancel">\n                            Cancelar\n                        </button>\n                        <button type="button" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition transform active:scale-95 text-sm" id="${this.modalId}-save">\n                            <i class="fas fa-check mr-1.5"></i> Guardar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>`;document.body.insertAdjacentHTML("beforeend",e);const t=()=>document.getElementById(this.modalId).classList.add("hidden");document.getElementById(`${this.modalId}-backdrop`).onclick=t,document.getElementById(`${this.modalId}-close`).onclick=t,document.getElementById(`${this.modalId}-cancel`).onclick=t,document.getElementById(`${this.modalId}-save`).onclick=()=>this.handleSave()}open(e,t,n,s){this.currentColumns=e,this.onSave=s,this.rowIndex=n;document.getElementById(`${this.modalId}-title`).textContent=null!==n?"Editar Registro":"Nuevo Registro";const a=document.getElementById(this.formId);a.innerHTML="",e.forEach(e=>{const n=function(e,t){const n="w-full text-sm border-0 bg-transparent focus:ring-0 p-2 placeholder-slate-300 font-medium text-slate-700",s=null!=t?t:"";if("url"===e.type){let n=t?.url||("string"==typeof t?t:"")||"",s=t?.text||"";const a=JSON.stringify({url:n,text:s}).replace(/"/g,"&quot;");return`\n        <div class="url-cell-group min-w-[200px] space-y-1.5 p-1">\n            <input type="hidden" class="cell-input url-json-store" data-col-id="${e.id}" value="${a}">\n            <div class="flex items-center bg-slate-50 rounded-lg border border-slate-200 px-2 focus-within:border-primary focus-within:ring-1 focus-within:ring-primary/20 transition-all">\n                <i class="fas fa-link text-[10px] text-slate-400 mr-2"></i>\n                <input type="text" class="url-part-link w-full bg-transparent border-none text-xs py-1.5 focus:ring-0 text-blue-600 placeholder-slate-400 font-mono" \n                       placeholder="https://..." value="${n}">\n            </div>\n            <div class="flex items-center bg-white rounded-lg border border-slate-200 px-2 focus-within:border-slate-300 transition-colors">\n                <i class="fas fa-font text-[10px] text-slate-300 mr-2"></i>\n                <input type="text" class="url-part-text w-full bg-transparent border-none text-xs py-1.5 focus:ring-0 text-slate-600 placeholder-slate-300" \n                       placeholder="Texto descriptivo" value="${s}">\n            </div>\n        </div>`}if("secret"===e.type)return`\n        <div class="relative group p-1">\n            <div class="flex items-center bg-slate-50 rounded-lg border border-slate-200 focus-within:border-secondary focus-within:bg-white transition-colors">\n                <input type="password" class="${n} rounded-lg cell-input" data-col-id="${e.id}" value="${s}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">\n                <button type="button" class="toggle-pass-cell px-3 text-slate-400 hover:text-secondary focus:outline-none" tabindex="-1">\n                    <i class="fas fa-eye text-xs"></i>\n                </button>\n            </div>\n        </div>`;if("boolean"===e.type)return`\n        <div class="flex justify-center items-center h-full py-2">\n            <input type="checkbox" class="w-5 h-5 text-primary border-slate-300 rounded focus:ring-primary cursor-pointer cell-input transition-all" \n                   data-col-id="${e.id}" ${s?"checked":""}>\n        </div>`;if("select"===e.type){const t=(e.options||[]).map(e=>`<option value="${e}" ${s===e?"selected":""}>${e}</option>`).join("");return`\n        <div class="p-1">\n            <select class="${n} bg-slate-50 rounded-lg cursor-pointer cell-input" data-col-id="${e.id}">\n                <option value="">--</option>\n                ${t}\n            </select>\n        </div>`}if("text"===e.type)return`\n      <div class="p-1">\n        <textarea class="${n} rounded-lg hover:bg-slate-50 focus:bg-white focus:ring-2 focus:ring-primary/10 transition-all cell-input resize-y min-h-[40px]" \n                  data-col-id="${e.id}" \n                  rows="4"\n                  placeholder="Escribir...">${s}</textarea>\n      </div>`;const a=["number","currency","percentage"].includes(e.type),r=`${n} ${a?"font-mono text-right math-input":""}`,i=a?"0.00":"date"===e.type?"":"Escribir...";return`\n    <div class="p-1">\n        <input type="${"date"===e.type?"date":"text"}" \n               class="${r} rounded-lg hover:bg-slate-50 focus:bg-white focus:ring-2 focus:ring-primary/10 transition-all cell-input" \n               data-col-id="${e.id}" \n               value="${s}" \n               placeholder="${i}">\n    </div>`}(e,t?t[e.id]:null),s=document.createElement("div");s.innerHTML=`\n                <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">${e.label}</label>\n                <div class="input-wrapper-modal relative">${n}</div>\n            `;const r=s.querySelector(".p-1");if(r){const e=r.innerHTML;r.outerHTML=e}a.appendChild(s)}),this.transformInputsToModalStyle(a),this.attachListeners(a),document.getElementById(this.modalId).classList.remove("hidden")}transformInputsToModalStyle(e){e.querySelectorAll("input, select, textarea").forEach(e=>{e.classList.remove("bg-transparent","border-0","focus:ring-0","text-right"),e.classList.add("w-full","bg-slate-50","border","border-slate-200","rounded-xl","focus:bg-white","focus:ring-2","focus:ring-primary/50","focus:border-primary","transition-all","px-4","py-3"),"TEXTAREA"===e.tagName&&e.classList.add("min-h-[100px]"),e.classList.contains("math-input")}),e.querySelectorAll(".url-cell-group").forEach(e=>{e.classList.remove("p-1"),e.classList.add("space-y-3"),e.querySelectorAll(".border-none").forEach(e=>e.classList.remove("border-none"))})}handleSave(){const e=document.getElementById(this.formId),t={};e.querySelectorAll(".cell-input").forEach(e=>{const n=e.dataset.colId,s=this.currentColumns.find(e=>e.id===n);let a;if(s&&"url"===s.type)try{a=JSON.parse(e.value)}catch(r){a={url:e.value,text:""}}else"checkbox"===e.type?a=e.checked:(a=e.value,s&&["number","currency","percentage"].includes(s.type)&&(e.classList.contains("math-input")&&this.evaluateMathInput(e),a=""===e.value||isNaN(e.value)?null:Number(e.value)));t[n]=a}),this.onSave&&this.onSave(t,this.rowIndex),document.getElementById(this.modalId).classList.add("hidden")}attachListeners(e){e.querySelectorAll(".toggle-pass-cell").forEach(e=>{e.classList.add("absolute","right-3","top-3","z-10"),e.onclick=t=>{t.preventDefault();const n=e.closest(".input-wrapper-modal").querySelector("input"),s=e.querySelector("i");"password"===n.type?(n.type="text",s.className="fas fa-eye-slash",e.classList.add("text-secondary")):(n.type="password",s.className="fas fa-eye",e.classList.remove("text-secondary"))}}),e.querySelectorAll(".url-cell-group").forEach(e=>{const t=e.querySelector(".url-json-store"),n=e.querySelector(".url-part-link"),s=e.querySelector(".url-part-text"),a=()=>{t.value=JSON.stringify({url:n.value.trim(),text:s.value.trim()})};n.oninput=a,s.oninput=a}),e.querySelectorAll(".math-input").forEach(e=>{const t=()=>this.evaluateMathInput(e);e.addEventListener("blur",t),e.addEventListener("keydown",e=>{"Enter"!==e.key&&"="!==e.key||(e.preventDefault(),t())})})}evaluateMathInput(e){const t=e.value.trim();if(t&&/^[\d\s\.\+\-\*\/\(\)]+$/.test(t)&&/[\+\-\*\/]/.test(t))try{const n=new Function('"use strict";return ('+t+")")();if(isFinite(n)){e.value=Math.round(100*n)/100;const t=e.style.borderColor;e.style.borderColor="#10b981",e.style.backgroundColor="#ecfdf5",setTimeout(()=>{e.style.borderColor=t,e.style.backgroundColor=""},800)}}catch(n){}}};class se{constructor(e,t,n){this.initialData=e,this.onSaveSuccess=t,this.onCancel=n,this.isEditing=!!e.documentId,this.documentId=e.documentId||null,this.template=e.template||null,this.initialFormData=e.formData||{},this.documentMetadata=e.metadata||{},this.isSubmitting=!1,this.isEditing&&!this.template&&this.checkSecurityAndLoad()}checkSecurityAndLoad(){B.isReady()?this.loadExistingDocument():window.app&&window.app.requireEncryption?window.app.requireEncryption(()=>this.loadExistingDocument()):this.renderError("Sistema de seguridad no disponible. Recarga la p√°gina.")}async loadExistingDocument(){this.updateEditorState(!0,"Descifrando datos...");try{const e=await ee.loadDocumentForEditing(this.documentId);this.template=e.template,this.initialFormData=e.formData,this.documentMetadata=e.metadata,this.render(),this.setupEventListeners(),this.updateEditorState(!1)}catch(e){this.renderError("Error al cargar datos cifrados: "+e.message)}}render(){if(!this.template&&this.isEditing)return'\n        <div id="editorContainer" class="flex flex-col justify-center items-center py-32 animate-fade-in">\n            <div class="relative">\n                <div class="w-16 h-16 rounded-full border-4 border-slate-100 border-t-primary animate-spin"></div>\n                <div class="absolute inset-0 flex items-center justify-center text-primary"><i class="fas fa-lock-open"></i></div>\n            </div>\n            <p class="mt-4 text-slate-400 font-medium animate-pulse">Descifrando documento seguro...</p>\n        </div>';if(!this.template)return'<div id="editorContainer" class="p-8 text-center bg-red-50 rounded-2xl text-red-600 font-bold border border-red-100">Error: Plantilla no definida.</div>';const e=this.isEditing?this.documentMetadata?.title:"",t=this.isEditing?"Actualizar":"Guardar",n=this.isEditing?"fa-sync-alt":"fa-save";return`\n      <div id="editorContainer" class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden animate-fade-in-up mb-20 relative">\n        \n        <div class="px-6 py-4 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-30 bg-white/90 backdrop-blur-md transition-all shadow-sm gap-4">\n          \n          <div class="flex items-center gap-4 w-full sm:w-auto overflow-hidden flex-1 mr-4">\n            <div class="flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center text-2xl shadow-inner" \n                 style="background-color: ${this.template.color}15; color: ${this.template.color}">\n                ${this.template.icon}\n            </div>\n            <div class="flex-1">\n              <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Identificaci√≥n del Registro</label>\n              <input type="text" id="documentTitleInput" \n                     class="w-full bg-transparent border-none p-0 text-lg font-bold text-slate-800 placeholder-slate-300 focus:ring-0 focus:outline-none truncate" \n                     placeholder="Ej: Tarjeta de Cr√©dito Banesco" \n                     value="${e}" required autofocus>\n            </div>\n          </div>\n\n          <div class="flex items-center gap-2 w-full sm:w-auto">\n             <button id="cancelDocBtn" class="flex-1 sm:flex-none p-2 sm:px-4 sm:py-2 text-slate-500 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition font-medium text-sm border border-transparent hover:border-slate-200">\n                <span class="hidden sm:inline">Cancelar</span>\n                <span class="sm:hidden">Cancelar</span>\n             </button>\n             <button id="saveDocBtn" class="flex-1 sm:flex-none px-6 py-2.5 bg-gradient-to-r from-primary to-secondary hover:from-primary-hover hover:to-secondary-hover text-white rounded-xl shadow-lg shadow-indigo-500/30 font-bold transition-all transform active:scale-95 flex items-center justify-center gap-2 text-sm">\n               <i class="fas ${n}"></i> <span>${t}</span>\n             </button>\n          </div>\n        </div>\n\n        <div class="p-6 sm:p-10 bg-slate-50/50 min-h-[500px]">\n          \n          <div id="dynamicFormContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">\n            ${Y.generateFormHtml(this.template,this.initialFormData)}\n          </div>\n\n          <div class="mt-12 flex items-center justify-center p-4 bg-indigo-50/50 border border-indigo-100 rounded-2xl text-center">\n            <div class="text-xs text-indigo-400 font-medium">\n              <i class="fas fa-info-circle mr-1"></i>\n              Todos los campos son cifrados localmente antes de guardarse.\n            </div>\n          </div>\n\n        </div>\n      </div>\n      \n      <style>\n        #dynamicFormContainer > div:has(textarea),\n        #dynamicFormContainer > div:has(.table-input-container) {\n            grid-column: span 1;\n        }\n        @media (min-width: 768px) {\n            #dynamicFormContainer > div:has(textarea),\n            #dynamicFormContainer > div:has(.table-input-container) {\n                grid-column: span 2;\n            }\n        }\n        #documentTitleInput:placeholder-shown { font-style: italic; }\n      </style>\n    `}setupEventListeners(){document.getElementById("cancelDocBtn")?.addEventListener("click",()=>this.onCancel()),document.getElementById("saveDocBtn")?.addEventListener("click",()=>this.handleSave()),this.setupMathCalculations(),this.setupTableInteractivity(),this.setupPasswordToggles()}setupPasswordToggles(){const e=document.getElementById("dynamicFormContainer");if(!e)return;e.querySelectorAll("button:has(.fa-eye), .toggle-pass-cell").forEach(e=>{e.onclick=t=>{t.preventDefault();const n=e.closest("div");if(!n)return;const s=n.querySelector("input"),a=e.querySelector("i");s&&a&&("password"===s.type?(s.type="text",a.className="fas fa-eye-slash",e.classList.add("text-secondary")):(s.type="password",a.className="fas fa-eye",e.classList.remove("text-secondary")))}})}setupTableInteractivity(){document.querySelectorAll(".table-input-container").forEach(e=>{e.className="table-input-container w-full overflow-hidden border border-slate-200 rounded-2xl bg-white shadow-sm ring-1 ring-slate-100";const t=e.dataset.fieldId,n=e.querySelector(`#${t}`),s=e.querySelector(".table-body");let a=[];try{a=JSON.parse(e.nextElementSibling.textContent)}catch(o){}const r=()=>{s.innerHTML="";let e=[];try{e=JSON.parse(n.value||"[]")}catch(o){return e=[],void(s.innerHTML='<tr><td colspan="100%" class="p-4 text-red-500 bg-red-50 text-xs font-bold text-center">Error cargando datos.</td></tr>')}0!==e.length?e.forEach((e,t)=>{const n=document.createElement("tr");n.className="border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group";let r="";a.forEach(t=>{r+=`<td class="px-4 py-3 align-top border-r border-slate-50 last:border-0">${function(e,t){if(null==t||""===t)return'<span class="text-slate-300 italic text-xs">--</span>';if("url"===e.type){const e=t?.url||("string"==typeof t?t:"")||"";return`<div class="flex items-center gap-1.5 overflow-hidden">\n                  <i class="fas fa-link text-[10px] text-indigo-400 flex-shrink-0"></i>\n                  <span class="truncate text-xs text-slate-600 font-medium" title="${e}">${t?.text||e}</span>\n                </div>`}if("boolean"===e.type)return t?'<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-700"><i class="fas fa-check mr-1"></i> S√≠</span>':'<span class="text-slate-400 text-xs">No</span>';if("secret"===e.type)return'<span class="text-slate-400 text-xs tracking-widest">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>';if(["currency","percentage"].includes(e.type))return`<span class="font-mono text-xs text-slate-700 font-bold">${t}${"percentage"===e.type?"%":""}</span>`;if("text"===e.type){const e="string"==typeof t&&t.length>30?t.substring(0,30)+"...":t;return`<span class="text-xs text-slate-600 truncate block" title="${t}"><i class="fas fa-paragraph text-slate-300 mr-1"></i>${e}</span>`}return`<span class="text-xs text-slate-600 truncate block" title="${t}">${t}</span>`}(t,e[t.id])}</td>`}),r+=`\n             <td class="w-24 text-center p-0 align-middle whitespace-nowrap">\n                 <div class="flex items-center justify-center gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">\n                     <button type="button" class="edit-row-btn w-8 h-8 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors" data-index="${t}" title="Editar">\n                        <i class="fas fa-pencil-alt text-xs"></i>\n                     </button>\n                     <button type="button" class="remove-row-btn w-8 h-8 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 transition-colors" data-index="${t}" title="Eliminar">\n                        <i class="fas fa-trash-alt text-xs"></i>\n                     </button>\n                 </div>\n             </td>`,n.innerHTML=r,s.appendChild(n)}):s.innerHTML=`<tr><td colspan="${a.length+1}" class="p-6 text-center text-xs text-slate-400 italic">No hay registros a√∫n.</td></tr>`};r();const i=e.querySelector(".add-row-btn");i&&(i.className="add-row-btn w-full py-3 bg-slate-50 hover:bg-indigo-50 text-slate-500 hover:text-indigo-600 font-bold text-xs uppercase tracking-wider transition-colors border-t border-slate-100 flex items-center justify-center gap-2 group",i.innerHTML='<i class="fas fa-plus-circle group-hover:scale-110 transition-transform"></i> Agregar Registro',i.addEventListener("click",()=>{ne.open(a,{},null,e=>{const t=JSON.parse(n.value||"[]");t.push(e),n.value=JSON.stringify(t),r()})})),s.addEventListener("click",e=>{const t=e.target.closest(".remove-row-btn");if(t){const e=parseInt(t.dataset.index),s=JSON.parse(n.value||"[]");s.splice(e,1),n.value=JSON.stringify(s),r()}const s=e.target.closest(".edit-row-btn");if(s){const e=parseInt(s.dataset.index),t=JSON.parse(n.value||"[]")[e];ne.open(a,t,e,(e,t)=>{const s=JSON.parse(n.value||"[]");s[t]=e,n.value=JSON.stringify(s),r()})}})})}setupMathCalculations(){this.template.fields.filter(e=>["number","currency","percentage"].includes(e.type)).forEach(e=>{const t=document.getElementById(e.id);t&&(t.classList.add("font-mono","text-right"),t.addEventListener("keydown",e=>("Enter"===e.key||"="===e.key)&&(e.preventDefault(),this.evaluateMathInput(t))),t.addEventListener("blur",()=>this.evaluateMathInput(t)))})}evaluateMathInput(e){const t=e.value.trim();if(t&&/^[\d\s\.\+\-\*\/\(\)]+$/.test(t)&&/[\+\-\*\/]/.test(t))try{const n=new Function('"use strict";return ('+t+")")();isFinite(n)&&(e.value=Math.round(100*n)/100,e.dispatchEvent(new Event("input",{bubbles:!0})),e.classList.add("text-emerald-600","font-bold","bg-emerald-50"),setTimeout(()=>e.classList.remove("text-emerald-600","font-bold","bg-emerald-50"),800))}catch(n){}}async handleSave(){if(this.isSubmitting)return;const e=document.getElementById("documentTitleInput"),t=e.value.trim();if(!t)return alert("Por favor, asigna un nombre o identificaci√≥n al registro en el encabezado."),e.focus(),e.classList.add("ring-2","ring-red-500","bg-red-50"),void setTimeout(()=>e.classList.remove("ring-2","ring-red-500","bg-red-50"),2e3);const n=document.querySelectorAll("[required]");let s=!0;if(n.forEach(e=>{e.value||"documentTitleInput"===e.id||(s=!1,e.classList.add("border-red-500"))}),s)if(B.isReady()){this.updateEditorState(!0,this.isEditing?"Cifrando cambios...":"Creando seguro...");try{document.querySelectorAll(".math-input").forEach(e=>this.evaluateMathInput(e)),await new Promise(e=>setTimeout(e,100));const e=this.collectFormData();let n;n=this.isEditing?await ee.updateDocument(this.documentId,this.template,e,t):await ee.createDocument(this.template,e,t),this.onSaveSuccess&&this.onSaveSuccess(n)}catch(a){alert("Error: "+a.message),this.updateEditorState(!1)}}else window.app&&window.app.requireEncryption&&window.app.requireEncryption(()=>this.handleSave());else alert("Por favor completa los campos requeridos marcados.")}collectFormData(){const e={};return this.template.fields.forEach(t=>{if("separator"===t.type)return;if("url"===t.type){const n=document.getElementById(`${t.id}_url`),s=document.getElementById(`${t.id}_text`);return void(n&&(e[t.id]={url:n.value.trim(),text:s?s.value.trim():""}))}const n=document.getElementById(t.id);if(n)if("boolean"===t.type)e[t.id]=n.checked;else if(["number","currency","percentage"].includes(t.type)){let s=n.value;e[t.id]=""===s||isNaN(s)?null:Number(s)}else if("table"===t.type)try{e[t.id]=JSON.parse(n.value||"[]")}catch(s){e[t.id]=[]}else e[t.id]=n.value}),e}updateEditorState(e,t=null){this.isSubmitting=e;const n=document.getElementById("saveDocBtn");if(n)if(e)n.disabled=!0,n.innerHTML=`<i class="fas fa-circle-notch fa-spin mr-2"></i> ${t}`,n.classList.add("opacity-75","cursor-wait");else{n.disabled=!1;const e=this.isEditing?"fa-sync-alt":"fa-save",t=this.isEditing?"Actualizar":"Guardar";n.innerHTML=`<i class="fas ${e} mr-2"></i> ${t}`,n.classList.remove("opacity-75","cursor-wait")}}renderError(e){document.getElementById("editorContainer").innerHTML=`\n        <div class="p-8 text-center bg-white rounded-3xl border border-red-100 shadow-xl">\n            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-50 text-red-500 mb-4 animate-bounce">\n                <i class="fas fa-bug text-2xl"></i>\n            </div>\n            <h3 class="text-xl font-bold text-slate-800 mb-2">Algo sali√≥ mal</h3>\n            <p class="text-slate-500 mb-6">${e}</p>\n            <button id="cancelDocBtn" class="px-6 py-2 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 transition font-bold">Volver</button>\n        </div>`,document.getElementById("cancelDocBtn")?.addEventListener("click",()=>this.onCancel())}}class ae{constructor(e,t){this.onViewDocument=e,this.onNewDocument=t,this.documents=[]}async loadDocuments(){const e=document.getElementById("vaultListContainer");if(e){e.innerHTML=`\n      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">\n        ${[1,2,3].map(()=>'\n          <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 h-32 animate-pulse flex flex-col justify-between">\n            <div class="flex items-center gap-4">\n               <div class="w-12 h-12 bg-slate-200 rounded-xl flex-shrink-0"></div>\n               <div class="flex-1 space-y-2">\n                 <div class="h-4 bg-slate-200 rounded w-3/4"></div>\n                 <div class="h-3 bg-slate-200 rounded w-1/3"></div>\n               </div>\n            </div>\n            <div class="h-6 bg-slate-100 rounded-lg w-full mt-2"></div>\n          </div>\n        ').join("")}\n      </div>`;try{this.documents=await ee.listDocuments(),this.render(e)}catch(t){e.innerHTML='\n        <div class="text-center py-12 bg-red-50 rounded-2xl border border-red-100">\n          <div class="inline-flex bg-red-100 p-3 rounded-full text-red-500 mb-3"><i class="fas fa-exclamation-triangle"></i></div>\n          <p class="text-red-600 font-medium">No se pudieron cargar los documentos.</p>\n          <button onclick="location.reload()" class="mt-4 text-sm text-red-700 underline hover:text-red-900">Reintentar</button>\n        </div>'}}}render(e){if(0===this.documents.length)return e.innerHTML='\n        <div class="text-center py-16 px-4">\n          <div class="inline-block p-6 rounded-full bg-slate-50 mb-4 animate-fade-in-up">\n            <i class="fas fa-folder-open text-4xl text-slate-300"></i>\n          </div>\n          <h3 class="text-lg font-bold text-slate-700">Tu b√≥veda est√° vac√≠a</h3>\n          <p class="text-slate-500 max-w-xs mx-auto mt-2 mb-6">Comienza a proteger tu informaci√≥n importante hoy mismo.</p>\n          <button id="btnEmptyStateNew" class="px-6 py-2 bg-primary text-white rounded-xl shadow-lg hover:bg-primary-hover transition font-bold">\n            Crear primer documento\n          </button>\n        </div>',void e.querySelector("#btnEmptyStateNew")?.addEventListener("click",this.onNewDocument);const t=document.createElement("div");t.className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 pb-20",this.documents.forEach(e=>{const n=e.icon||"üìã",s=e.color||"#4f46e5",a=e.templateName||"Documento",r=document.createElement("div");r.className="group relative bg-white hover:bg-slate-50 rounded-3xl p-5 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border border-slate-100 cursor-pointer overflow-hidden",r.innerHTML=`\n        <div class="absolute top-0 left-0 w-full h-1.5" style="background-color: ${s}"></div>\n        \n        <div class="absolute top-5 right-5 text-slate-300 group-hover:text-slate-500 transition-colors">\n             <i class="fas fa-chevron-right text-xs"></i>\n        </div>\n\n        <div class="flex items-center gap-4 mb-4 pr-6">\n            \n            <div class="flex-shrink-0 flex items-center justify-center w-12 h-12 rounded-2xl text-xl shadow-sm transition-transform duration-300 group-hover:scale-110"\n                 style="background-color: ${s}15; color: ${s}">\n                ${n}\n            </div>\n            \n            <div class="flex-1 min-w-0"> <h3 class="text-base font-bold text-slate-800 truncate leading-tight group-hover:text-slate-900 transition-colors mb-1">\n                    ${e.title||"Sin t√≠tulo"}\n                </h3>\n                <span class="inline-block px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide border border-slate-100 bg-white text-slate-500 shadow-sm truncate max-w-full">\n                    ${a}\n                </span>\n            </div>\n        </div>\n\n        <div class="flex items-center justify-between text-xs text-slate-400 pt-3 border-t border-slate-100">\n            <div class="flex items-center gap-1.5 truncate">\n                <i class="far fa-clock"></i>\n                <span>${new Date(e.updatedAt).toLocaleDateString()}</span>\n            </div>\n            <div class="flex items-center gap-1 text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full font-medium flex-shrink-0">\n                <i class="fas fa-lock text-[10px]"></i>\n                <span>E2EE</span>\n            </div>\n        </div>\n      `,r.addEventListener("click",()=>this.onViewDocument(e.id)),t.appendChild(r)}),e.innerHTML="",e.appendChild(t)}}function re(e,t,n){if(null==t||""===t)return"_N/A_";if("object"==typeof t&&null!==t){if(t.url){return`${t.text&&t.text!==t.url?`${t.text}: `:""}${t.url}`}return JSON.stringify(t)}switch(e){case"boolean":return t?"S√≠":"No";case"currency":return new Intl.NumberFormat(n.locale).format(Number(t));case"date":try{if(String(t).includes("-")){const[e,n,s]=String(t).split("-");return`${s}/${n}/${e}`}}catch(s){}return String(t);case"percentage":return`${t}%`;default:return String(t)}}const ie=new class{constructor(){this.containerId="global-media-player",this.contentId="global-player-content",this.titleId="global-player-title",this.isRendered=!1}renderBase(){if(document.getElementById(this.containerId))return;const e=`\n            <div id="${this.containerId}" class="fixed bottom-5 right-5 w-80 z-[100] hidden transition-all duration-300 transform translate-y-4 opacity-0 bg-white/95 backdrop-blur-md border border-slate-200 shadow-2xl rounded-2xl overflow-hidden ring-1 ring-black/5">\n                <div class="flex items-center justify-between px-4 py-3 bg-slate-50 border-b border-slate-100">\n                    <span id="${this.titleId}" class="text-xs font-bold text-slate-500 uppercase tracking-wider">Vista Previa</span>\n                    <button id="close-global-player" class="text-slate-400 hover:text-slate-700 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-200 transition">\n                        <i class="fas fa-times text-sm"></i>\n                    </button>\n                </div>\n                <div id="${this.contentId}" class="p-4 flex justify-center bg-white min-h-[100px] items-center">\n                    </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",e),document.getElementById("close-global-player").addEventListener("click",()=>this.close()),this.isRendered=!0}open(e,t,n){this.isRendered||this.renderBase();const s=document.getElementById(this.containerId),a=document.getElementById(this.contentId),r=document.getElementById(this.titleId);a.innerHTML="",r.textContent=n||("audio"===e?"Reproduciendo Audio":"Visualizando Imagen"),"image"===e?a.innerHTML=`<img src="${t}" class="max-w-full rounded-lg shadow-sm object-contain max-h-60" alt="Vista previa">`:"audio"===e&&(a.innerHTML=`\n                <div class="w-full">\n                    <audio controls autoplay class="w-full h-10 block rounded bg-slate-50">\n                        <source src="${t}">\n                        Tu navegador no soporta audio.\n                    </audio>\n                </div>`),s.classList.remove("hidden"),setTimeout(()=>{s.classList.remove("translate-y-4","opacity-0")},10)}close(){const e=document.getElementById(this.containerId);if(!e)return;const t=e.querySelector("audio");t&&t.pause(),e.classList.add("translate-y-4","opacity-0"),setTimeout(()=>{e.classList.add("hidden"),document.getElementById(this.contentId).innerHTML=""},300)}};class oe{constructor(e,t){this.docId=e,this.onBack=t,this.document=null,this.template=null,this.decryptedData=null,this.currencyConfig=z(),this.tableStates={}}render(){return'<div id="documentViewerPlaceholder" class="animate-fade-in-up pb-16"></div>'}async load(){if(this.renderLoading(),!B.isReady())return window.app&&window.app.requireEncryption?void window.app.requireEncryption(()=>this.load()):void this.renderError("Sistema de cifrado no disponible.");try{if(this.document=await ee.getDocumentById(this.docId),this.template=await O.getTemplateById(this.document.templateId),!this.template)throw new Error("La plantilla original ya no existe.");this.decryptedData=await B.decryptDocument(this.document.encryptedContent),this.template.fields.forEach(e=>{"table"===e.type&&(this.tableStates[e.id]={search:"",sortCol:null,sortDir:"asc"})}),this.renderContent()}catch(e){this.renderError(e.message)}}renderFieldValue(e,t,n=!1){if(null==t||"string"==typeof t&&""===t.trim())return'<span class="text-slate-300 italic text-xs select-none">Vac√≠o</span>';switch(e){case"url":return function(e,t=!1){let n="object"==typeof e?e.url:e,s="object"==typeof e?e.text||n:e;if(!n)return'<span class="text-slate-300 italic text-xs">--</span>';const a=(e=>{if(!e||"string"!=typeof e)return"link";let t=e.split("?")[0].toLowerCase();return[".jpg",".jpeg",".png",".gif",".webp",".svg",".bmp"].some(e=>t.endsWith(e))?"image":[".mp3",".wav",".ogg",".m4a",".aac"].some(e=>t.endsWith(e))?"audio":"link"})(n),r=s===n?"audio"===a?"Archivo de Audio":"Imagen Adjunta":s,i=t&&r.length>25?r.substring(0,22)+"...":r;if("audio"===a||"image"===a)return`\n            <div class="flex items-center gap-3 group">\n                <button type="button" \n                        class="trigger-media-btn w-9 h-9 flex items-center justify-center rounded-full border border-slate-200 ${"audio"===a?"bg-pink-50 group-hover:bg-pink-100":"bg-indigo-50 group-hover:bg-indigo-100"} transition-all shadow-sm hover:scale-105"\n                        data-type="${a}" \n                        data-src="${n}" \n                        data-title="${r}"\n                        title="Ver ${"audio"===a?"Audio":"Imagen"}">\n                    <i class="fas ${"audio"===a?"fa-music":"fa-image"} ${"audio"===a?"text-pink-500 group-hover:text-pink-600":"text-indigo-500 group-hover:text-indigo-600"} text-sm"></i>\n                </button>\n                <a href="${n}" target="_blank" class="text-sm font-medium text-slate-700 hover:text-primary hover:underline truncate">\n                    ${i}\n                    <i class="fas fa-external-link-alt text-[10px] ml-1 text-slate-300"></i>\n                </a>\n            </div>\n        `;return`\n        <a href="${n}" target="_blank" class="inline-flex items-center gap-1.5 text-blue-600 hover:text-blue-800 hover:underline font-medium transition-colors break-all text-sm">\n            <i class="fas fa-link text-xs opacity-50 flex-shrink-0"></i> ${i}\n        </a>`}(t,n);case"boolean":return function(e){return e?'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700"><i class="fas fa-check mr-1"></i> S√≠</span>':'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-500">No</span>'}(t);case"date":return function(e){try{const[t,n,s]=String(e).split("-");return`<span class="font-semibold text-slate-700"><i class="far fa-calendar text-slate-400 mr-2"></i>${new Date(t,n-1,s).toLocaleDateString()}</span>`}catch{return e}}(t);case"currency":return function(e,t){return`<span class="font-mono font-bold text-slate-700 bg-slate-50 px-2 py-0.5 rounded border border-slate-100">${new Intl.NumberFormat(t.locale,{style:"currency",currency:t.codigo}).format(Number(e))}</span>`}(t,this.currencyConfig);case"percentage":return function(e){return`<span class="font-mono font-bold text-slate-700">${e}%</span>`}(t);case"secret":return function(e,t){return e?t?`\n        <div class="group/secret flex items-center gap-2 select-none h-full">\n            <div class="relative font-mono text-xs text-slate-500">\n                <span class="secret-mask tracking-widest align-middle">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>\n                <span class="secret-revealed hidden font-bold text-slate-800 align-middle">${e}</span>\n            </div>\n\n            <div class="flex items-center gap-0.5 opacity-0 group-hover/secret:opacity-100 transition-opacity duration-200">\n                <button type="button" class="toggle-secret-btn w-6 h-6 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded transition-colors" title="Mostrar/Ocultar">\n                    <i class="fas fa-eye text-[10px]"></i>\n                </button>\n\n                <button type="button" class="copy-btn w-6 h-6 flex items-center justify-center text-slate-400 hover:text-emerald-600 hover:bg-slate-100 rounded transition-colors" data-value="${e}" title="Copiar">\n                    <i class="far fa-copy text-[10px]"></i>\n                </button>\n            </div>\n        </div>`:`\n        <div class="flex items-center gap-2">\n            <div class="relative group overflow-hidden rounded-lg border border-slate-200 bg-white px-3 py-2 transition-all hover:border-indigo-200 hover:shadow-sm w-full">\n                <span class="secret-mask filter blur-[5px] select-none transition-all duration-300 group-hover:blur-none font-mono text-sm text-slate-800 tracking-wider">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>\n                <span class="secret-revealed hidden font-mono text-sm text-slate-800 select-all font-bold tracking-wide">${e}</span>\n            </div>\n            <button class="toggle-secret-btn w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-colors bg-white border border-slate-200" title="Revelar"><i class="fas fa-eye"></i></button>\n            <button class="copy-btn w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 transition-colors bg-white border border-slate-200" data-value="${e}" title="Copiar"><i class="far fa-copy"></i></button>\n        </div>`:'<span class="text-slate-300 text-xs italic">--</span>'}(t,n);case"text":return function(e,t){return t?e.length>30?e.substring(0,30)+"...":e:`<div class="prose prose-sm max-w-none text-slate-600 whitespace-pre-line">${e}</div>`}(t,n);default:return String(t)}}renderContent(){const e=document.getElementById("documentViewerPlaceholder");if(!e)return;ie.renderBase();const t=new Date(this.document.metadata.updatedAt).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}),n=this.template.fields.map(e=>{const t=["separator","table","text"].includes(e.type)?"col-span-1 md:col-span-2 print:col-span-2":"col-span-1";if("separator"===e.type)return`\n            <div class="${t} mt-6 mb-2 border-b border-slate-200 pb-2 flex items-center gap-3">\n                <div class="w-1.5 h-6 bg-gradient-to-b from-primary to-secondary rounded-full"></div>\n                <h3 class="text-lg font-bold text-slate-800 tracking-tight">${e.label}</h3>\n            </div>\n          `;const n=this.decryptedData[e.id];if("table"===e.type)return`<div class="${t}">${this.renderTableField(e,n)}</div>`;const s=this.renderFieldValue(e.type,n);return`\n        <div class="${t} bg-slate-50/50 rounded-xl p-4 border border-slate-100 hover:bg-slate-50 hover:shadow-sm transition-all group print:break-inside-avoid print:bg-white print:border-slate-300">\n          <dt class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-1.5 flex items-center gap-2">\n             ${e.label}\n          </dt>\n          <dd class="text-sm text-slate-800 break-words leading-relaxed font-medium">\n             ${s}\n          </dd>\n        </div>\n      `}).join("");e.innerHTML=`\n      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 no-print">\n         <button id="backBtn" class="group flex items-center text-slate-500 hover:text-primary transition-colors font-medium">\n            <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center mr-2 shadow-sm group-hover:-translate-x-1 transition-transform"><i class="fas fa-arrow-left text-xs"></i></div>\n            <span>Volver</span>\n         </button>\n         <div class="flex items-center gap-2 self-end sm:self-auto bg-white p-1.5 rounded-xl shadow-sm border border-slate-200">\n            <button id="whatsappDocBtn" class="p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="WhatsApp"><i class="fab fa-whatsapp text-lg"></i></button>\n            <button id="pdfDocBtn" class="p-2 text-slate-400 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors" title="Imprimir"><i class="fas fa-print text-lg"></i></button>\n            <div class="h-6 w-px bg-slate-100 mx-1"></div>\n            <button id="deleteDocBtn" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar"><i class="far fa-trash-alt text-lg"></i></button>\n            <button id="editDocBtn" class="flex items-center px-4 py-1.5 bg-slate-800 hover:bg-slate-900 text-white rounded-lg shadow-md hover:shadow-lg transition-all text-sm font-bold ml-1"><i class="fas fa-pen mr-2 text-xs"></i> <span>Editar</span></button>\n         </div>\n      </div>\n\n      <div id="documentCard" class="bg-white rounded-3xl shadow-2xl shadow-slate-200/60 border border-slate-100 overflow-hidden relative print:shadow-none print:border-none">\n        <div class="relative px-8 py-10 overflow-hidden">\n             <div class="absolute inset-0 opacity-10" style="background-color: ${this.template.color}"></div>\n             <div class="absolute top-0 left-0 w-full h-1.5" style="background-color: ${this.template.color}"></div>\n             <div class="relative z-10 flex gap-6 items-start">\n                <div class="flex-shrink-0 w-20 h-20 rounded-2xl flex items-center justify-center text-4xl shadow-lg bg-white text-gradient" style="color: ${this.template.color}">${this.template.icon}</div>\n                <div>\n                   <h1 class="text-2xl sm:text-4xl font-extrabold text-slate-800 tracking-tight leading-tight mb-2">${this.document.metadata.title}</h1>\n                   <div class="flex flex-wrap items-center gap-3 text-sm">\n                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-lg font-bold text-xs uppercase tracking-wide bg-white/60 border border-slate-200/50 text-slate-600 backdrop-blur-sm">${this.template.name}</span>\n                      <span class="text-slate-400 flex items-center text-xs"><i class="far fa-clock mr-1.5"></i> Actualizado: ${t}</span>\n                   </div>\n                </div>\n             </div>\n        </div>\n        <div class="p-6 sm:p-8">\n           <dl class="grid grid-cols-1 md:grid-cols-2 print:grid-cols-2 gap-6">\n              ${n}\n           </dl>\n        </div>\n        <div class="bg-slate-50 px-8 py-4 border-t border-slate-100 flex items-center justify-between mt-4">\n           <div class="flex items-center text-emerald-600 text-xs font-bold uppercase tracking-wider"><i class="fas fa-shield-alt mr-2 text-lg"></i> Cifrado E2EE Verificado</div>\n           <div class="hidden sm:block text-slate-300 text-[10px] font-mono">UUID: ${this.document.id}</div>\n        </div>\n      </div>\n\n      <div id="rowDetailModal" class="fixed inset-0 z-50 hidden">\n         <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" id="modalBackdrop"></div>\n         <div class="flex items-center justify-center min-h-screen p-4">\n            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg transform transition-all scale-100 relative overflow-hidden flex flex-col max-h-[85vh] animate-fade-in-up">\n                <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">\n                    <h3 class="font-bold text-lg text-slate-800">Detalles del Registro</h3>\n                    <button class="close-modal w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition"><i class="fas fa-times"></i></button>\n                </div>\n                <div class="p-6 overflow-y-auto" id="rowDetailContent"></div>\n            </div>\n         </div>\n      </div>\n    `,this.setupContentListeners()}showPrintOptions(){if(!document.getElementById("printOptionsModal")){const e='\n        <div id="printOptionsModal" class="fixed inset-0 z-[70] flex items-center justify-center p-4 hidden"> <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" id="printModalBackdrop"></div>\n            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in-up">\n                <div class="p-6 text-center">\n                    <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl">\n                        <i class="fas fa-print"></i>\n                    </div>\n                    <h3 class="text-lg font-bold text-slate-800 mb-2">Selecciona Formato</h3>\n                    <p class="text-sm text-slate-500 mb-6">¬øC√≥mo deseas imprimir este documento?</p>\n                    \n                    <div class="space-y-3">\n                        <button id="printStandardBtn" class="w-full flex items-center p-3 border border-slate-200 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-all group text-left">\n                            <div class="w-10 h-10 rounded-lg bg-white border border-slate-100 flex items-center justify-center text-slate-400 group-hover:text-indigo-600 shadow-sm mr-3">\n                                <i class="fas fa-id-card"></i>\n                            </div>\n                            <div>\n                                <span class="block font-bold text-slate-700 text-sm">Estilo Tarjeta (Visual)</span>\n                                <span class="block text-xs text-slate-400">Mejor para presentaci√≥n</span>\n                            </div>\n                        </button>\n\n                        <button id="printCompactBtn" class="w-full flex items-center p-3 border border-slate-200 rounded-xl hover:border-emerald-500 hover:bg-emerald-50 transition-all group text-left">\n                            <div class="w-10 h-10 rounded-lg bg-white border border-slate-100 flex items-center justify-center text-slate-400 group-hover:text-emerald-600 shadow-sm mr-3">\n                                <i class="fas fa-compress-alt"></i>\n                            </div>\n                            <div>\n                                <span class="block font-bold text-slate-700 text-sm">Compacto (Ahorro)</span>\n                                <span class="block text-xs text-slate-400">Menos espacio, m√°s datos</span>\n                            </div>\n                        </button>\n                    </div>\n                </div>\n                <div class="bg-slate-50 p-3 text-center border-t border-slate-100">\n                    <button id="cancelPrintBtn" class="text-xs font-bold text-slate-500 hover:text-slate-800 uppercase tracking-wide">Cancelar</button>\n                </div>\n            </div>\n        </div>';document.body.insertAdjacentHTML("beforeend",e)}const e=document.getElementById("printOptionsModal"),t=()=>e.classList.add("hidden");document.getElementById("printModalBackdrop").onclick=t,document.getElementById("cancelPrintBtn").onclick=t,document.getElementById("printStandardBtn").onclick=()=>{this.triggerPrint(!1),t()},document.getElementById("printCompactBtn").onclick=()=>{this.triggerPrint(!0),t()},e.classList.remove("hidden")}triggerPrint(e){const t={...this.document.metadata,id:this.document.id};Q(()=>import("./PrintExporter-3ALwLJVR.js"),[]).then(n=>{n.printDocument(t,this.template,this.decryptedData,e)})}setupContentListeners(){["backBtn"].forEach(e=>document.getElementById(e)?.addEventListener("click",()=>this.onBack())),document.getElementById("deleteDocBtn")?.addEventListener("click",()=>this.handleDelete()),document.getElementById("editDocBtn")?.addEventListener("click",()=>this.handleEdit()),document.getElementById("pdfDocBtn")?.addEventListener("click",()=>this.showPrintOptions()),document.getElementById("whatsappDocBtn")?.addEventListener("click",()=>this.handleCopyToWhatsApp());const e=document.getElementById("documentViewerPlaceholder");e.querySelectorAll(".table-search-input").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.dataset.fieldId;this.tableStates[t].search=e.target.value,this.updateTableUI(t)})}),e.addEventListener("click",e=>{const t=e.target.closest(".trigger-media-btn");if(t){e.preventDefault();const n=t.dataset.src,s=t.dataset.type,a=t.dataset.title;return void ie.open(s,n,a)}const n=e.target.closest(".table-header-sort");if(n){const e=n.dataset.fieldId,t=n.dataset.colId,s=this.tableStates[e];s.sortCol===t?s.sortDir="asc"===s.sortDir?"desc":"asc":(s.sortCol=t,s.sortDir="asc"),this.refreshTableFieldHTML(e)}const s=e.target.closest(".toggle-secret-btn");if(s){let e=s.parentElement;for(;e&&!e.querySelector(".secret-mask");)e=e.parentElement;if(e){const t=e.querySelector(".secret-mask"),n=e.querySelector(".secret-revealed"),a=s.querySelector("i");n.classList.contains("hidden")?(t.classList.add("hidden"),n.classList.remove("hidden"),a.classList.remove("fa-eye"),a.classList.add("fa-eye-slash"),s.classList.add("text-indigo-600")):(t.classList.remove("hidden"),n.classList.add("hidden"),a.classList.remove("fa-eye-slash"),a.classList.add("fa-eye"),s.classList.remove("text-indigo-600"))}}const a=e.target.closest(".copy-btn");if(a){navigator.clipboard.writeText(a.dataset.value);const e=a.querySelector("i");e.className="fas fa-check text-emerald-500",setTimeout(()=>e.className="far fa-copy",1500)}const r=e.target.closest(".view-row-btn");r&&this.openRowModal(r.dataset.fieldId,parseInt(r.dataset.rowIndex))});const t=document.getElementById("rowDetailModal"),n=()=>t.classList.add("hidden");t?.querySelectorAll(".close-modal").forEach(e=>e.addEventListener("click",n)),document.getElementById("modalBackdrop")?.addEventListener("click",n)}renderTableField(e,t){const n=Array.isArray(t)?t:[];if(0===n.length)return'<div class="p-6 border border-dashed border-slate-200 rounded-xl bg-slate-50 text-center text-xs text-slate-400 flex flex-col items-center gap-2"><i class="fas fa-table text-xl opacity-20"></i>Tabla vac√≠a</div>';const s=this.tableStates[e.id]||{sortCol:null,sortDir:"asc"},a=this.getProcessedRows(e,n),r=e.columns.length>3,i=r?e.columns.slice(0,3):e.columns,o=i.map(t=>`<th class="px-4 py-3 text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider cursor-pointer hover:text-primary transition select-none table-header-sort" data-field-id="${e.id}" data-col-id="${t.id}">${t.label} ${s.sortCol===t.id?"asc"===s.sortDir?"‚Üë":"‚Üì":""}</th>`).join(""),l=a.map((t,n)=>`<tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors last:border-0">${i.map(e=>`<td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">${this.renderFieldValue(e.type,t[e.id],!0)}</td>`).join("")}${r?`<td class="px-4 py-3 text-right"><button class="view-row-btn text-primary bg-indigo-50 hover:bg-indigo-100 p-1.5 rounded-lg transition" data-field-id="${e.id}" data-row-index="${n}"><i class="fas fa-eye text-xs"></i></button></td>`:""}</tr>`).join("");return`<div class="col-span-full mt-2 mb-2"><div class="flex items-center justify-between mb-3"><label class="text-xs font-bold text-slate-400 uppercase tracking-wide flex items-center gap-2"><i class="fas fa-table"></i> ${e.label} <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-[10px]">${n.length}</span></label><input type="text" class="table-search-input text-xs border border-slate-200 rounded-lg px-2 py-1.5 w-40 focus:ring-2 focus:ring-primary/20 outline-none bg-slate-50" placeholder="Buscar..." data-field-id="${e.id}"></div><div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm ring-1 ring-slate-100"><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50/50 border-b border-slate-100"><tr>${o}${r?"<th></th>":""}</tr></thead><tbody id="tbody-${e.id}">${l}</tbody></table></div></div></div>`}getProcessedRows(e,t){const n=this.tableStates[e.id]||{search:"",sortCol:null,sortDir:"asc"};let s=[...t];if(n.search){const t=n.search.toLowerCase(),a=e.columns.slice(0,3);s=s.filter(e=>a.some(n=>{let s=e[n.id];return"object"==typeof s&&null!==s&&(s=s.text||s.url||""),String(s||"").toLowerCase().includes(t)}))}if(n.sortCol){const t=n.sortCol,a=e.columns.find(e=>e.id===t);s.sort((e,s)=>{let r=e[t],i=s[t];return null==r&&(r=""),null==i&&(i=""),"object"==typeof r&&(r=r.text||r.url||""),"object"==typeof i&&(i=i.text||i.url||""),a&&["number","currency","percentage"].includes(a.type)?"asc"===n.sortDir?r-i:i-r:"asc"===n.sortDir?String(r).localeCompare(String(i)):String(i).localeCompare(String(r))})}return s}updateTableUI(e){const t=this.template.fields.find(t=>t.id===e),n=this.decryptedData[e]||[],s=this.getProcessedRows(t,n),a=document.getElementById(`tbody-${e}`);a&&(a.innerHTML=this.generateTableBodyHtml(t,s))}generateTableBodyHtml(e,t){return this.renderTableField(e,t).match(/<tbody>(.*?)<\/tbody>/)[1]}refreshTableFieldHTML(e){const t=this.template.fields.find(t=>t.id===e),n=this.decryptedData[e]||[];document.getElementById(`table-${e}`);const s=document.querySelector(`.table-search-input[data-field-id="${e}"]`).closest(".col-span-full");if(s){s.outerHTML=this.renderTableField(t,n);const a=document.querySelector(`.table-search-input[data-field-id="${e}"]`).closest(".col-span-full").querySelector(".table-search-input");a&&a.addEventListener("input",t=>{this.tableStates[e].search=t.target.value,this.updateTableUI(e)})}}openRowModal(e,t){const n=this.template.fields.find(t=>t.id===e);if(!n)return;const s=this.decryptedData[e]||[],a=this.getProcessedRows(n,s)[t],r=n.columns.map(e=>`<div class="py-3 border-b border-slate-100 last:border-0">\n                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">\n                    ${e.label||e.name}\n                </p>\n                <div class="text-slate-800 text-sm break-words">\n                    ${this.renderFieldValue(e.type,a[e.id],"secret"===e.type)}\n                </div>\n           </div>`).join("");document.getElementById("rowDetailContent").innerHTML=r,document.getElementById("rowDetailModal").classList.remove("hidden")}renderLoading(){document.getElementById("documentViewerPlaceholder").innerHTML='<div class="flex flex-col items-center justify-center py-24"><div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-primary mb-4"></div><p class="text-slate-400 animate-pulse">Desencriptando documento...</p></div>'}renderError(e){document.getElementById("documentViewerPlaceholder").innerHTML=`<div class="max-w-2xl mx-auto mt-10 p-6 bg-red-50 border border-red-100 rounded-xl text-center"><i class="fas fa-exclamation-circle text-4xl text-red-400 mb-4"></i><h3 class="text-red-800 font-bold text-lg">Error de Carga</h3><p class="text-red-600 mt-2">${e}</p><button id="backBtn" class="mt-6 px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition">Volver</button></div>`,document.getElementById("backBtn")?.addEventListener("click",()=>this.onBack())}async handleDelete(){if(confirm("¬øEst√°s seguro de eliminar este documento permanentemente?"))try{await ee.deleteDocument(this.docId),this.onBack()}catch(e){alert(e.message)}}handleEdit(){this.onBack({documentId:this.docId,template:this.template,formData:this.decryptedData,metadata:this.document.metadata})}async handleCopyToWhatsApp(){const e=document.getElementById("whatsappDocBtn"),t=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin text-lg"></i>';try{await async function(e,t,n,s){try{let a=`*${e.title}*\n_${t.name}_\n\n`;return t.fields.forEach(e=>{if("separator"===e.type)return;const t=n[e.id];if("table"===e.type){const n=Array.isArray(t)?t:[];a+=`*${e.label}:* ${0===n.length?"_Sin datos_":""}\n`,n.forEach((t,n)=>{a+=`  ${n+1}. `,e.columns&&e.columns.forEach((n,r)=>{const i=t[n.id],o=re(n.type,i,s),l=r<e.columns.length-1?" | ":"";a+=`${n.label}: ${o}${l}`}),a+="\n"}),a+="\n"}else a+=`*${e.label}:* ${re(e.type,t,s)}\n`}),a+="\n_Enviado desde Mi Gesti√≥n_",await navigator.clipboard.writeText(a),!0}catch(a){throw a}}(this.document.metadata,this.template,this.decryptedData,this.currencyConfig),e.innerHTML='<i class="fas fa-check text-green-500 text-lg"></i>',setTimeout(()=>e.innerHTML=t,2e3)}catch(n){alert("Error al copiar para WhatsApp"),e.innerHTML=t}}}const le=new class{async createBackup(){const e=await ee.getAllDocuments(),t=await O.getUserTemplates(),n={version:1,createdAt:(new Date).toISOString(),documents:e,templates:t,type:"mi_gestion_backup_e2ee"},s=`backup_migestion_${(new Date).toISOString().slice(0,10)}.json`,a=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(a),i=document.createElement("a");return i.href=r,i.download=s,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),{count:e.length}}async restoreBackup(e,t=null){return new Promise((n,s)=>{const a=new FileReader;a.onload=async e=>{try{const r=JSON.parse(e.target.result);if("mi_gestion_backup_e2ee"!==r.type)throw new Error("Formato de archivo no v√°lido");const i=r.documents||[],o=r.templates||[];let l=null;if(t&&(l=await B.deriveTemporaryKey(t)),i.length>0)try{await B.decryptDocument(i[0].encryptedContent,l)}catch(a){return s({type:"KEY_MISMATCH",message:"La contrase√±a actual no puede descifrar este respaldo."})}let d=0;for(const e of i){const t=await B.decryptDocument(e.encryptedContent,l),n=o.find(t=>t.id===e.templateId)||await O.getTemplateById(e.templateId);n&&(await ee.createDocument(n,t),d++)}let c=0;for(const e of o){await O.getTemplateById(e.id)||(await O.importTemplate(e),c++)}n({docsRestored:d,templatesRestored:c})}catch(r){s(r)}},a.readAsText(e)})}};class de{render(){return'\n      <div class="max-w-5xl mx-auto space-y-8 animate-fade-in-up pb-20">\n        \n        <div class="flex items-center space-x-5 mb-8 px-4 sm:px-0">\n          <div class="p-4 bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-100 flex items-center justify-center">\n             <i class="fas fa-shield-halved text-3xl text-indigo-600 bg-clip-text"></i>\n          </div>\n          <div>\n            <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Centro de Seguridad</h2>\n            <p class="text-slate-500 font-medium">Gestiona tus credenciales y protege tu legado digital.</p>\n          </div>\n        </div>\n\n        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">\n            \n            <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/40 border border-slate-100 overflow-hidden flex flex-col h-full">\n                <div class="bg-gradient-to-r from-blue-50 to-white px-8 py-6 border-b border-blue-100/50 flex items-center justify-between">\n                    <div class="flex items-center gap-3">\n                        <div class="w-10 h-10 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center shadow-sm">\n                            <i class="fas fa-user-lock"></i>\n                        </div>\n                        <h3 class="font-bold text-slate-800 text-lg">Acceso a la Cuenta</h3>\n                    </div>\n                    <span class="text-[10px] uppercase font-bold tracking-wider bg-white border border-blue-100 text-blue-600 px-3 py-1 rounded-full shadow-sm">Nube Firebase</span>\n                </div>\n                \n                <div class="p-8 flex-grow">\n                    <p class="text-sm text-slate-500 mb-6 leading-relaxed">\n                        Esta es la contrase√±a que usas para iniciar sesi√≥n (Login). Cambiarla no afecta el cifrado de tus documentos.\n                    </p>\n                    \n                    <form id="changeAccessPassForm" class="space-y-5">\n                        <div class="group">\n                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Contrase√±a Actual</label>\n                            <div class="relative">\n                                <i class="fas fa-lock absolute left-4 top-3.5 text-slate-300"></i>\n                                <input type="password" id="currentAccessPass" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none text-slate-700 font-medium" required>\n                            </div>\n                        </div>\n                        <div class="group">\n                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Nueva Contrase√±a</label>\n                            <div class="relative">\n                                <i class="fas fa-key absolute left-4 top-3.5 text-slate-300"></i>\n                                <input type="password" id="newAccessPass" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none text-slate-700 font-medium" required minlength="6">\n                            </div>\n                        </div>\n                        <button type="submit" id="btnChangeAccess" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 transition-all hover:-translate-y-0.5 mt-2">\n                            Actualizar Credenciales\n                        </button>\n                    </form>\n                </div>\n            </div>\n\n            <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/40 border border-amber-100 overflow-hidden flex flex-col h-full relative">\n                <div class="absolute top-0 right-0 w-20 h-20 overflow-hidden pointer-events-none">\n                     <div class="bg-amber-400 text-amber-900 text-[10px] font-bold py-1 text-center w-32 -rotate-45 absolute top-4 -right-10 shadow-sm">CR√çTICO</div>\n                </div>\n\n                <div class="bg-gradient-to-r from-amber-50 to-white px-8 py-6 border-b border-amber-100/50 flex items-center justify-between">\n                     <div class="flex items-center gap-3">\n                        <div class="w-10 h-10 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center shadow-sm">\n                            <i class="fas fa-key"></i>\n                        </div>\n                        <h3 class="font-bold text-slate-800 text-lg">Llave Maestra B√≥veda</h3>\n                    </div>\n                </div>\n                \n                <div class="p-8 flex-grow">\n                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 flex items-start gap-3">\n                        <i class="fas fa-exclamation-triangle text-amber-500 mt-0.5"></i>\n                        <p class="text-xs text-amber-800 leading-relaxed font-medium">\n                            Esta llave <strong>cifra tus datos</strong>. Si la cambias, el sistema deber√° descifrar y volver a cifrar todos tus documentos (Re-Keying).\n                        </p>\n                    </div>\n                    \n                    <form id="changeVaultPassForm" class="space-y-4">\n                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">\n                            <div class="sm:col-span-2">\n                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Llave Maestra Actual</label>\n                                <input type="password" id="currentVaultPass" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition font-mono text-sm" required>\n                            </div>\n                            <div>\n                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Nueva Llave</label>\n                                <input type="password" id="newVaultPass" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition font-mono text-sm" required minlength="8">\n                            </div>\n                            <div>\n                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Confirmar</label>\n                                <input type="password" id="confirmVaultPass" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition font-mono text-sm" required>\n                            </div>\n                        </div>\n                        <button type="submit" id="btnChangeVault" class="w-full py-3.5 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold rounded-xl shadow-lg shadow-amber-500/20 transition-all hover:-translate-y-0.5 mt-2 flex items-center justify-center gap-2">\n                            <i class="fas fa-sync-alt"></i> Re-Cifrar B√≥veda\n                        </button>\n                    </form>\n                </div>\n            </div>\n        </div>\n\n        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/40 border border-slate-100 overflow-hidden mt-8">\n            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/30">\n                <h3 class="font-bold text-lg text-slate-800 flex items-center">\n                    <span class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mr-3 text-sm"><i class="fas fa-database"></i></span>\n                    Respaldo y Restauraci√≥n\n                </h3>\n            </div>\n            \n            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-10 items-center">\n                \n                <div class="group">\n                    <h4 class="font-bold text-slate-700 mb-2 flex items-center"><i class="fas fa-file-export text-slate-400 mr-2 group-hover:text-primary transition-colors"></i> Exportar Datos</h4>\n                    <p class="text-xs text-slate-500 mb-5 leading-relaxed">\n                        Descarga un archivo JSON cifrado con tu <strong>Llave de B√≥veda</strong> actual. Gu√°rdalo en un lugar seguro (USB, Disco Externo).\n                    </p>\n                    <button id="btnExport" class="w-full sm:w-auto px-6 py-2.5 bg-white border-2 border-slate-100 hover:border-primary/50 text-slate-600 hover:text-primary font-bold rounded-xl transition-all shadow-sm hover:shadow-md flex items-center justify-center">\n                        <i class="fas fa-download mr-2"></i> Descargar Respaldo\n                    </button>\n                </div>\n\n                <div class="border-t md:border-t-0 md:border-l border-slate-100 pt-8 md:pt-0 md:pl-10 group relative">\n                    <h4 class="font-bold text-slate-700 mb-2 flex items-center"><i class="fas fa-file-import text-slate-400 mr-2 group-hover:text-primary transition-colors"></i> Restaurar Datos</h4>\n                    <p class="text-xs text-slate-500 mb-5 leading-relaxed">\n                        Importa un respaldo. Si el archivo usa una llave antigua, el sistema te la pedir√° autom√°ticamente.\n                    </p>\n                    \n                    <div class="flex flex-col sm:flex-row gap-3">\n                        <input type="file" id="fileImport" accept=".json" class="hidden" />\n                        \n                        <button onclick="document.getElementById(\'fileImport\').click()" class="flex-1 px-5 py-2.5 bg-slate-50 border border-slate-200 hover:bg-slate-100 text-slate-700 font-bold rounded-xl transition text-sm">\n                            <i class="fas fa-folder-open mr-2"></i> Elegir Archivo\n                        </button>\n                        \n                        <button id="btnRestore" disabled class="flex-1 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 disabled:text-slate-400 disabled:cursor-not-allowed text-white font-bold rounded-xl transition shadow-lg shadow-indigo-500/20 text-sm">\n                            Restaurar\n                        </button>\n                    </div>\n                    <div id="restoreStatus" class="mt-4 text-xs font-medium min-h-[20px]"></div>\n                </div>\n            </div>\n        </div>\n\n      </div>\n    '}setupEventListeners(){document.getElementById("changeAccessPassForm")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("currentAccessPass").value,n=document.getElementById("newAccessPass").value,s=document.getElementById("btnChangeAccess"),a=s.innerHTML;s.innerHTML='<i class="fas fa-circle-notch fa-spin"></i> Procesando...',s.disabled=!0;try{const s=await M.changeAccessPassword(n,t);s.success?(alert("‚úÖ Clave de acceso actualizada correctamente."),e.target.reset()):alert("‚ùå Error: "+s.error)}catch(r){alert("Error de conexi√≥n")}s.innerHTML=a,s.disabled=!1}),document.getElementById("changeVaultPassForm")?.addEventListener("submit",async e=>{if(e.preventDefault(),!B.isReady())return void(window.app&&window.app.requireEncryption&&window.app.requireEncryption(()=>document.getElementById("btnChangeVault").click()));const t=document.getElementById("newVaultPass").value;if(t!==document.getElementById("confirmVaultPass").value)return alert("Las llaves nuevas no coinciden.");if(t.length<8)return alert("La llave debe tener al menos 8 caracteres.");if(!confirm("‚ö†Ô∏è ATENCI√ìN: Se re-cifrar√°n todos tus documentos.\nEste proceso es delicado. No cierres la ventana.\n\n¬øContinuar?"))return;const n=document.getElementById("btnChangeVault"),s=n.innerHTML;n.innerHTML='<i class="fas fa-circle-notch fa-spin mr-2"></i> Re-cifrando...',n.disabled=!0;try{const{documentService:n}=await Q(async()=>{const{documentService:e}=await Promise.resolve().then(()=>te);return{documentService:e}},void 0);await n.reEncryptAllDocuments(t),alert("‚úÖ ¬°√âxito! Tu B√≥veda ha sido re-cifrada con la nueva llave.\nNo la olvides."),e.target.reset()}catch(a){alert("‚ùå Error cr√≠tico: "+a.message)}finally{n.innerHTML=s,n.disabled=!1}}),document.getElementById("btnExport")?.addEventListener("click",async()=>{if(B.isReady())try{await le.createBackup();const e=document.getElementById("btnExport"),t=e.innerHTML;e.innerHTML='<i class="fas fa-check mr-2"></i> ¬°Listo!',e.classList.add("bg-green-50","text-green-600","border-green-200"),setTimeout(()=>{e.innerHTML=t,e.classList.remove("bg-green-50","text-green-600","border-green-200")},3e3)}catch(e){alert("Error: "+e.message)}else window.app&&window.app.requireEncryption&&window.app.requireEncryption(()=>document.getElementById("btnExport").click())});const e=document.getElementById("fileImport"),t=document.getElementById("btnRestore"),n=document.getElementById("restoreStatus");e?.addEventListener("change",()=>{e.files.length?(t.disabled=!1,n.innerHTML=`<span class="text-slate-500"><i class="fas fa-file-alt mr-1"></i> ${e.files[0].name} seleccionado.</span>`):(t.disabled=!0,n.innerHTML="")}),t?.addEventListener("click",async()=>{if(!B.isReady())return void(window.app&&window.app.requireEncryption&&window.app.requireEncryption(()=>t.click()));n.innerHTML='<span class="text-blue-600 flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> Analizando y descifrando...</span>',t.disabled=!0;const s=e.files[0];try{const t=await le.restoreBackup(s);n.innerHTML=`<span class="text-emerald-600 font-bold flex items-center gap-2"><i class="fas fa-check-circle"></i> Restaurados ${t.docsRestored} documentos exitosamente.</span>`,e.value=""}catch(a){if("KEY_MISMATCH"===a.type){const t=prompt("üîê LLAVE INCORRECTA\nEste respaldo fue creado con una llave antigua.\nIngr√©sala para descifrarlo:");if(t)try{n.innerHTML='<span class="text-amber-600 flex items-center gap-2"><i class="fas fa-circle-notch fa-spin"></i> Intentando con llave antigua...</span>';const a=await le.restoreBackup(s,t);n.innerHTML=`<span class="text-emerald-600 font-bold flex items-center gap-2"><i class="fas fa-check-double"></i> Recuperados ${a.docsRestored} docs (Llave antigua).</span>`,alert("Restauraci√≥n exitosa. Los documentos se han actualizado a tu llave actual."),e.value=""}catch(r){n.innerHTML='<span class="text-red-500 font-bold"><i class="fas fa-times-circle"></i> La llave antigua tampoco funcion√≥.</span>'}else n.innerHTML='<span class="text-slate-400">Cancelado por el usuario.</span>'}else n.innerHTML=`<span class="text-red-500 font-bold"><i class="fas fa-times-circle"></i> Error: ${a.message}</span>`}finally{e.files.length&&(t.disabled=!1)}})}}async function ce(e,t){if(e){try{await O.initialize(e.uid)}catch(n){}!async function(e,t){t.innerHTML=`\n    <div class="min-h-screen flex flex-col">\n      <nav class="sticky top-0 z-50 w-full glass-nav border-b border-white/40 bg-white/80 backdrop-blur-md">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="flex justify-between h-16 sm:h-20 items-center">\n            \n            <div class="flex items-center gap-3 cursor-pointer group" id="navHome">\n              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary via-secondary to-accent flex items-center justify-center text-white shadow-lg shadow-indigo-500/20 group-hover:scale-110 transition-transform duration-300">\n                 <i class="fas fa-fingerprint text-lg"></i>\n              </div>\n              <div>\n                <span class="block font-bold text-slate-800 text-lg leading-none tracking-tight">Mi Gesti√≥n</span>\n                <span class="text-[10px] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary uppercase tracking-widest">B√≥veda Privada</span>\n              </div>\n            </div>\n\n            <div class="flex items-center gap-4">\n                <div class="hidden md:flex flex-col items-end mr-2">\n                    <p class="text-xs font-bold text-slate-700">${e.email}</p>\n                    <div class="flex items-center gap-1.5">\n                      <span class="relative flex h-2 w-2">\n                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>\n                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>\n                      </span>\n                      <p class="text-[10px] text-slate-500 font-medium">Conectado</p>\n                    </div>\n                </div>\n                \n                <button id="logoutButton" class="group relative px-4 py-2 rounded-xl bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all duration-300 overflow-hidden shadow-sm hover:shadow-red-500/30">\n                    <span class="relative z-10 flex items-center gap-2">\n                      <i class="fas fa-power-off text-sm"></i>\n                      <span class="hidden sm:inline text-sm font-semibold">Salir</span>\n                    </span>\n                </button>\n            </div>\n          </div>\n        </div>\n      </nav>\n\n      <main class="flex-grow max-w-7xl w-full mx-auto py-8 px-4 sm:px-6 lg:px-8 relative z-10">\n        <div id="dynamicContent" class="animate-fade-in-up"></div>\n      </main>\n    </div>`,document.getElementById("logoutButton")?.addEventListener("click",()=>M.logout()),document.getElementById("navHome")?.addEventListener("click",()=>pe(e)),pe(e)}(e,t)}else!function(e){const t=new j(()=>{},e=>{"auth/user-not-found"===e.code?I.show("No encontramos una cuenta con este correo.","error",{label:"Crear cuenta nueva",onClick:()=>{const e=document.getElementById("tabRegister");e&&e.click()}}):I.show(e.code,"error")});e.innerHTML='\n    <div class="min-h-screen flex items-center justify-center p-4 sm:p-6 relative overflow-hidden">\n      <div class="absolute inset-0 bg-gradient-to-br from-indigo-50/50 via-purple-50/50 to-pink-50/50 -z-20"></div>\n\n      <div class="w-full max-w-md glass rounded-3xl overflow-hidden transform transition-all duration-500 hover:scale-[1.01] animate-fade-in-up">\n        \n        <div class="relative h-32 bg-gradient-to-r from-primary via-secondary to-accent overflow-hidden">\n          <div class="absolute inset-0 bg-[url(\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjIiIGZpbGw9IiZmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4yIi8+PC9zdmc+\')] opacity-30"></div>\n          <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-white/20 rounded-full blur-2xl"></div>\n          \n          <div class="relative z-10 flex flex-col items-center justify-center h-full pt-4">\n            <div class="w-14 h-14 bg-white rounded-2xl shadow-lg flex items-center justify-center mb-2 transform rotate-3 hover:rotate-6 transition-transform">\n               <i class="fas fa-shield-halved text-2xl text-transparent bg-clip-text bg-gradient-to-br from-primary to-accent"></i>\n            </div>\n            <h1 class="text-2xl font-bold text-white tracking-tight text-shadow-sm">Mi Gesti√≥n</h1>\n          </div>\n        </div>\n\n        <div id="authContainer" class="p-8"></div>\n\n        <div class="px-8 pb-6 text-center">\n          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-50 border border-slate-100 shadow-sm">\n            <i class="fas fa-lock text-emerald-500 text-xs"></i> \n            <span class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Seguridad E2EE Activa</span>\n          </div>\n        </div>\n      </div>\n    </div>',t.updateView(document.getElementById("authContainer"))}(t)}function ue(e){const t=M.getCurrentUser();if(!t)return;if(B.isReady())return void e();new A(async t=>{try{return await M.initializeEncryption(t),!!B.isReady()&&(e(),!0)}catch(n){return!1}},t.email).show()}function pe(e){const t=document.getElementById("dynamicContent");if(!t)return;t.innerHTML='\n    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-10 gap-6 border-b border-slate-200/60 pb-6">\n      <div>\n        <h2 class="text-3xl sm:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-slate-700 via-slate-800 to-slate-900 tracking-tight mb-2">\n          Documentos\n        </h2>\n        <p class="text-slate-500 text-sm sm:text-base max-w-lg">\n          Tus archivos est√°n <span class="text-emerald-600 font-bold bg-emerald-50 px-1 rounded">encriptados</span> y listos.\n        </p>\n      </div>\n\n      <div class="flex items-center gap-3 w-full sm:w-auto">\n          <button id="btnSettings" class="p-3 bg-white text-slate-400 hover:text-secondary border border-slate-200 rounded-xl hover:shadow-md hover:border-secondary/30 transition-all duration-300 group" title="Configuraci√≥n">\n             <i class="fas fa-sliders group-hover:rotate-180 transition-transform duration-700 text-lg"></i>\n          </button>\n          \n          <button id="btnNewDocVault" class="flex-1 sm:flex-none px-6 py-3 bg-gradient-to-r from-primary to-secondary hover:from-primary-hover hover:to-secondary-hover text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transition-all hover:-translate-y-1 hover:shadow-indigo-500/40 flex items-center justify-center gap-2 group">\n            <div class="bg-white/20 rounded-lg p-1 group-hover:rotate-90 transition-transform">\n              <i class="fas fa-plus text-xs"></i>\n            </div>\n            <span>Crear Nuevo</span>\n          </button>\n      </div>\n    </div>\n    \n    <div id="vaultListContainer" class="min-h-[300px]"></div>\n  ';const n=new ae(t=>ue(()=>me(t,e)),()=>ue(()=>fe(e)));document.getElementById("btnNewDocVault")?.addEventListener("click",()=>ue(()=>fe(e))),document.getElementById("btnSettings")?.addEventListener("click",()=>function(e){const t=document.getElementById("dynamicContent");t.innerHTML='\n    <div class="max-w-4xl mx-auto animate-fade-in-up">\n        <button id="backToDash" class="group mb-8 flex items-center text-slate-500 hover:text-primary transition-colors font-medium text-sm bg-white/50 w-fit px-4 py-2 rounded-full backdrop-blur-sm hover:bg-white">\n            <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> Volver\n        </button>\n        <div id="settingsContainer"></div>\n    </div>';const n=new de;document.getElementById("settingsContainer").innerHTML=n.render(),n.setupEventListeners(),document.getElementById("backToDash").onclick=()=>pe(e)}(e)),n.loadDocuments()}function me(e,t){document.getElementById("dynamicContent").innerHTML='\n    <div id="documentViewerPlaceholder" class="max-w-5xl mx-auto glass rounded-2xl p-8">\n        <div class="animate-pulse flex space-x-6">\n            <div class="w-16 h-16 bg-slate-200 rounded-xl"></div>\n            <div class="flex-1 space-y-4 py-1">\n                <div class="h-6 bg-slate-200 rounded w-1/3"></div>\n                <div class="space-y-2">\n                    <div class="h-4 bg-slate-200 rounded"></div>\n                    <div class="h-4 bg-slate-200 rounded w-5/6"></div>\n                </div>\n            </div>\n        </div>\n    </div>';const n=new oe(e,e=>{e?function(e,t){const n=document.getElementById("dynamicContent"),s=new se(e,()=>me(e.documentId,t),()=>me(e.documentId,t));n.innerHTML='<div id="editorContainer" class="max-w-5xl mx-auto animate-fade-in-up"></div>',document.getElementById("editorContainer").innerHTML=s.render(),s.setupEventListeners()}(e,t):pe(t)}),s=document.getElementById("documentViewerPlaceholder");s&&(s.outerHTML=n.render()),n.load()}function fe(e){const t=document.getElementById("dynamicContent"),n=new Z(t=>async function(e,t){const n=document.getElementById("dynamicContent");n.innerHTML='\n    <div class="flex flex-col justify-center items-center h-64 gap-4">\n        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-primary"></div>\n        <p class="text-slate-400 font-medium">Cargando plantilla...</p>\n    </div>';try{const s=await O.getTemplateById(e),a=new se({template:s},()=>pe(t),()=>fe(t));n.innerHTML='<div id="editorContainer" class="max-w-5xl mx-auto animate-fade-in-up"></div>',document.getElementById("editorContainer").innerHTML=a.render(),a.setupEventListeners()}catch(s){alert("Error cargando plantilla"),fe(t)}}(t,e));t.innerHTML='\n    <div class="max-w-6xl mx-auto animate-fade-in-up">\n        <button id="backToDash" class="group mb-8 flex items-center text-slate-500 hover:text-primary transition-colors font-medium text-sm bg-white/50 w-fit px-4 py-2 rounded-full backdrop-blur-sm hover:bg-white">\n            <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> Volver a la B√≥veda\n        </button>\n        <div id="tmContainer"></div>\n    </div>',document.getElementById("tmContainer").innerHTML=n.render(),document.getElementById("backToDash").onclick=()=>pe(e),O.initialize(e.uid),n.loadTemplates()}document.addEventListener("DOMContentLoaded",()=>{!async function(){const e=document.getElementById("app");if(!e)return;M.subscribe(async t=>{await ce(t,e)});const t=M.getCurrentUser();await ce(t,e)}()}),window.app={requireEncryption:ue};export{z as g};
